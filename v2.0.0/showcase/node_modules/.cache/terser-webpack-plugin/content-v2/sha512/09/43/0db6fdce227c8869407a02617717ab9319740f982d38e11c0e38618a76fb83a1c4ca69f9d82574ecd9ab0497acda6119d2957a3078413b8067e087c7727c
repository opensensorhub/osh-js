{"code":"!function(t){var e={};function r(a){if(e[a])return e[a].exports;var i=e[a]={i:a,l:!1,exports:{}};return t[a].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(t,\"__esModule\",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&\"object\"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,\"default\",{enumerable:!0,value:t}),2&e&&\"string\"!=typeof t)for(var i in t)r.d(a,i,function(e){return t[e]}.bind(null,i));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,\"a\",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p=\"\",r(r.s=0)}([function(t,e,r){\"use strict\";r.r(e);var a=class{constructor(t){t=t||{},this.canvasElement=t.canvas||document.createElement(\"canvas\"),this.contextOptions=t.contextOptions,this.type=t.type||\"yuv420\",this.customYUV444=t.customYUV444,this.conversionType=t.conversionType||\"rec601\",this.width=t.width||640,this.height=t.height||320,this.animationTime=t.animationTime||0,this.canvasElement.width=this.width,this.canvasElement.height=this.height,this.init()}init(){this.initContextGL(),this.contextGL&&(this.initProgram(),this.initBuffers(),this.initTextures()),\"yuv420\"===this.type?this.drawNextOuptutPictureGL=t=>{var e=this.contextGL,r=this.texturePosBuffer,a=this.uTexturePosBuffer,i=this.vTexturePosBuffer,o=this.yTextureRef,n=this.uTextureRef,u=this.vTextureRef,s=t.yData,h=t.uData,f=t.vData,l=this.width,v=this.height,c=t.yDataPerRow||l,x=t.yRowCnt||v,T=t.uDataPerRow||l/2,R=t.uRowCnt||v/2,m=t.vDataPerRow||T,d=t.vRowCnt||R;let g=90*Math.round(t.roll/90);g>180&&(g-=360),90==Math.abs(g)?(this.canvasElement.width=this.height,this.canvasElement.height=this.width,e.viewport(0,0,v,l)):(this.canvasElement.width=this.width,this.canvasElement.height=this.height,e.viewport(0,0,l,v));var A=v/x,E=l/c,p=new Float32Array([E,0,0,0,E,A,0,A]);e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,p,e.DYNAMIC_DRAW),this.customYUV444?(A=v/R,E=l/T):(A=v/2/R,E=l/2/T);var P=new Float32Array([E,0,0,0,E,A,0,A]);e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,P,e.DYNAMIC_DRAW),this.customYUV444?(A=v/d,E=l/m):(A=v/2/d,E=l/2/m);var y=new Float32Array([E,0,0,0,E,A,0,A]);e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,y,e.DYNAMIC_DRAW),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,c,x,0,e.LUMINANCE,e.UNSIGNED_BYTE,s),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,T,R,0,e.LUMINANCE,e.UNSIGNED_BYTE,h),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,u),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,m,d,0,e.LUMINANCE,e.UNSIGNED_BYTE,f),e.uniform1f(this.rollUniform,g*Math.PI/180),e.drawArrays(e.TRIANGLE_STRIP,0,4)}:\"yuv422\"===this.type&&(this.drawNextOuptutPictureGL=t=>{var e=this.contextGL,r=this.texturePosBuffer,a=this.textureRef,i=t.data,o=this.width,n=this.height,u=t.dataPerRow||2*o,s=t.rowCnt||n;e.viewport(0,0,o,n);var h=n/s,f=o/(u/2),l=new Float32Array([f,0,0,0,f,h,0,h]);e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,l,e.DYNAMIC_DRAW),e.uniform2f(e.getUniformLocation(this.shaderProgram,\"resolution\"),u,n),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,u,s,0,e.LUMINANCE,e.UNSIGNED_BYTE,i),e.drawArrays(e.TRIANGLE_STRIP,0,4)})}isWebGL(){return this.contextGL}initContextGL(){for(var t=this.canvasElement,e=null,r=[\"webgl\",\"experimental-webgl\",\"moz-webgl\",\"webkit-3d\"],a=0;!e&&a<r.length;){var i=r[a];try{e=this.contextOptions?t.getContext(i,this.contextOptions):t.getContext(i)}catch(t){e=null}e&&\"function\"==typeof e.getParameter||(e=null),++a}this.contextGL=e}initProgram(){var t,e,r=this.contextGL;\"yuv420\"===this.type?(t=[\"attribute vec4 vertexPos;\",\"attribute vec4 texturePos;\",\"attribute vec4 uTexturePos;\",\"attribute vec4 vTexturePos;\",\"varying vec2 textureCoord;\",\"varying vec2 uTextureCoord;\",\"varying vec2 vTextureCoord;\",\"uniform float roll;\",\"void main()\",\"{\",\"  vec4 ctr = vec4(0.5, 0.5, 0, 0);\",\"  mat4 rotMatrix = mat4( cos(roll), -sin(roll), 0, 0,\",\"                         sin(roll),  cos(roll), 0, 0,\",\"                         0,          0,         1, 0,\",\"                         0,          0,         0, 1);\",\"  gl_Position = vertexPos;\",\"  textureCoord = mat2(rotMatrix) * (texturePos.xy - vec2(ctr)) + vec2(ctr);\",\"  uTextureCoord = mat2(rotMatrix) * (uTexturePos.xy - vec2(ctr)) + vec2(ctr);\",\"  vTextureCoord = mat2(rotMatrix) * (vTexturePos.xy - vec2(ctr)) + vec2(ctr);\",\"}\"].join(\"\\n\"),e=[\"precision highp float;\",\"varying highp vec2 textureCoord;\",\"varying highp vec2 uTextureCoord;\",\"varying highp vec2 vTextureCoord;\",\"uniform sampler2D ySampler;\",\"uniform sampler2D uSampler;\",\"uniform sampler2D vSampler;\",\"uniform mat4 YUV2RGB;\",\"void main(void) {\",\"  highp float y = texture2D(ySampler,  textureCoord).r;\",\"  highp float u = texture2D(uSampler,  uTextureCoord).r;\",\"  highp float v = texture2D(vSampler,  vTextureCoord).r;\",\"  gl_FragColor = vec4(y, u, v, 1) * YUV2RGB;\",\"}\"].join(\"\\n\")):\"yuv422\"===this.type&&(t=[\"attribute vec4 vertexPos;\",\"attribute vec4 texturePos;\",\"varying vec2 textureCoord;\",\"void main()\",\"{\",\"  gl_Position = vertexPos;\",\"  textureCoord = texturePos.xy;\",\"}\"].join(\"\\n\"),e=[\"precision highp float;\",\"varying highp vec2 textureCoord;\",\"uniform sampler2D sampler;\",\"uniform highp vec2 resolution;\",\"uniform mat4 YUV2RGB;\",\"void main(void) {\",\"  highp float texPixX = 1.0 / resolution.x;\",\"  highp float logPixX = 2.0 / resolution.x;\",\"  highp float logHalfPixX = 4.0 / resolution.x;\",\"  highp float steps = floor(textureCoord.x / logPixX);\",\"  highp float uvSteps = floor(textureCoord.x / logHalfPixX);\",\"  highp float y = texture2D(sampler, vec2((logPixX * steps) + texPixX, textureCoord.y)).r;\",\"  highp float u = texture2D(sampler, vec2((logHalfPixX * uvSteps), textureCoord.y)).r;\",\"  highp float v = texture2D(sampler, vec2((logHalfPixX * uvSteps) + texPixX + texPixX, textureCoord.y)).r;\",\"  gl_FragColor = vec4(y, u, v, 1.0) * YUV2RGB;\",\"}\"].join(\"\\n\"));var a=[];a=\"rec709\"===this.conversionType?[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1]:[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1];var i=r.createShader(r.VERTEX_SHADER);r.shaderSource(i,t),r.compileShader(i),r.getShaderParameter(i,r.COMPILE_STATUS)||console.log(\"Vertex shader failed to compile: \"+r.getShaderInfoLog(i));var o=r.createShader(r.FRAGMENT_SHADER);r.shaderSource(o,e),r.compileShader(o),r.getShaderParameter(o,r.COMPILE_STATUS)||console.log(\"Fragment shader failed to compile: \"+r.getShaderInfoLog(o));var n=r.createProgram();r.attachShader(n,i),r.attachShader(n,o),r.linkProgram(n),r.getProgramParameter(n,r.LINK_STATUS)||console.log(\"Program failed to compile: \"+r.getProgramInfoLog(n)),r.useProgram(n);var u=r.getUniformLocation(n,\"YUV2RGB\");r.uniformMatrix4fv(u,!1,a),this.rollUniform=r.getUniformLocation(n,\"roll\"),this.shaderProgram=n}initBuffers(){var t=this.contextGL,e=this.shaderProgram,r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),t.STATIC_DRAW);var a=t.getAttribLocation(e,\"vertexPos\");if(t.enableVertexAttribArray(a),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0),this.animationTime){var i=this.animationTime,o=0,n=function(){var r=1*(o+=15)/i;o>=i?r=1:setTimeout(n,15);var a=-1*r,u=1*r,s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array([u,u,a,u,u,a,a,a]),t.STATIC_DRAW);var h=t.getAttribLocation(e,\"vertexPos\");t.enableVertexAttribArray(h),t.vertexAttribPointer(h,2,t.FLOAT,!1,0,0);try{t.drawArrays(t.TRIANGLE_STRIP,0,4)}catch(t){}};n()}var u=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,u),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW);var s=t.getAttribLocation(e,\"texturePos\");if(t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),this.texturePosBuffer=u,\"yuv420\"===this.type){var h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW);var f=t.getAttribLocation(e,\"uTexturePos\");t.enableVertexAttribArray(f),t.vertexAttribPointer(f,2,t.FLOAT,!1,0,0),this.uTexturePosBuffer=h;var l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW);var v=t.getAttribLocation(e,\"vTexturePos\");t.enableVertexAttribArray(v),t.vertexAttribPointer(v,2,t.FLOAT,!1,0,0),this.vTexturePosBuffer=l}}initTextures(){var t=this.contextGL,e=this.shaderProgram;if(\"yuv420\"===this.type){var r=this.initTexture(),a=t.getUniformLocation(e,\"ySampler\");t.uniform1i(a,0),this.yTextureRef=r;var i=this.initTexture(),o=t.getUniformLocation(e,\"uSampler\");t.uniform1i(o,1),this.uTextureRef=i;var n=this.initTexture(),u=t.getUniformLocation(e,\"vSampler\");t.uniform1i(u,2),this.vTextureRef=n}else if(\"yuv422\"===this.type){var s=this.initTexture(),h=t.getUniformLocation(e,\"sampler\");t.uniform1i(h,0),this.textureRef=s}}initTexture(){var t=this.contextGL,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),e}drawNextOutputPicture(t,e,r,a){this.contextGL?this.drawNextOuptutPictureGL(t,e,r,a):this.drawNextOuptutPictureRGBA(t,e,r,a)}drawNextOuptutPictureRGBA(t,e,r,a){var i=a,o=this.canvasElement.getContext(\"2d\"),n=o.getImageData(0,0,t,e);n.data.set(i),null===r?o.putImageData(n,0,0):o.putImageData(n,-r.left,-r.top,0,0,r.width,r.height)}resize(t,e){this.canvasElement.width=t,this.canvasElement.height=e,this.width=t,this.height=e}};Math.pow(2,53);function i(t){return null!=t}let o;self.buffer=[],self.onmessage=t=>{self.framerate=t.data.framerate,self.yuvCanvas=new a({width:t.data.width,height:t.data.height,contextOptions:{preserveDrawingBuffer:!0},canvas:t.data.canvas}),o=new BroadcastChannel(\"ffmpeg-decode-\"+t.data.dataSourceId),o.onmessage=t=>{self.buffer.push(t.data)}},setInterval(()=>{var t;buffer.length>1&&(t=buffer.shift(),i(self.yuvCanvas)&&(self.yuvCanvas.width===t.width&&self.yuvCanvas.height===t.height||self.yuvCanvas.resize(t.width,t.height),self.yuvCanvas.drawNextOuptutPictureGL({yData:t.yData,yDataPerRow:t.yDataPerRow,yRowCnt:t.yRowCnt,uData:t.uData,uDataPerRow:t.uDataPerRow,uRowCnt:t.uRowCnt,vData:t.vData,vDataPerRow:t.vDataPerRow,vRowCnt:t.vRowCnt,roll:t.roll})))},1e3/self.framerate)}]);","extractedComments":[]}