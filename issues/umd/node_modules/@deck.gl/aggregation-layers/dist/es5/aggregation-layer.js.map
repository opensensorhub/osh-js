{"version":3,"sources":["../../src/aggregation-layer.js"],"names":["AggregationLayer","dimensions","setState","ignoreProps","constructor","_propTypes","data","props","opts","changeFlags","extensionsChanged","shaders","getShaders","defines","NON_INSTANCED_MODEL","updateShaders","_updateAttributes","changedAttributes","getAttributeManager","getShaderAttributes","context","viewport","mousePosition","gl","moduleSettings","Object","assign","create","pickingActive","devicePixelRatio","updateOpts","params","oldProps","compareAll","dimension","state","dataProps","accessors","updateTriggersChanged","all","accessor","newProps","propTypes","name","isObjectEmpty","undefined","AttributeManager","id","stats","CompositeLayer","obj","isEmpty","key","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {CompositeLayer, AttributeManager, _compareProps as compareProps} from '@deck.gl/core';\nimport {cssToDeviceRatio} from '@luma.gl/core';\nimport {filterProps} from './utils/prop-utils';\n\nexport default class AggregationLayer extends CompositeLayer {\n  initializeState(dimensions) {\n    super.initializeState();\n\n    this.setState({\n      // Layer props , when changed doesn't require updating aggregation\n      ignoreProps: filterProps(this.constructor._propTypes, dimensions.data.props),\n      dimensions\n    });\n  }\n\n  updateState(opts) {\n    super.updateState(opts);\n    const {changeFlags} = opts;\n    if (changeFlags.extensionsChanged) {\n      const shaders = this.getShaders({});\n      if (shaders && shaders.defines) {\n        shaders.defines.NON_INSTANCED_MODEL = 1;\n      }\n      this.updateShaders(shaders);\n    }\n\n    // Explictly call to update attributes as 'CompositeLayer' doesn't call this\n    this._updateAttributes(opts.props);\n  }\n\n  updateAttributes(changedAttributes) {\n    // Super classes, can refer to state.changedAttributes to determine what\n    // attributes changed\n    this.setState({changedAttributes});\n  }\n\n  getAttributes() {\n    return this.getAttributeManager().getShaderAttributes();\n  }\n\n  getModuleSettings() {\n    // For regular layer draw this happens during draw cycle (_drawLayersInViewport) not during update cycle\n    // For aggregation layers this is called during updateState to update aggregation data\n    // NOTE: it is similar to LayerPass._getModuleParameters() but doesn't inlcude `effects` it is not needed for aggregation\n    const {viewport, mousePosition, gl} = this.context;\n    const moduleSettings = Object.assign(Object.create(this.props), {\n      viewport,\n      mousePosition,\n      pickingActive: 0,\n      devicePixelRatio: cssToDeviceRatio(gl)\n    });\n    return moduleSettings;\n  }\n\n  updateShaders(shaders) {\n    // Default implemention is empty, subclasses can update their Model objects if needed\n  }\n\n  /**\n   * Checks if aggregation is dirty\n   * @param {Object} updateOpts - object {props, oldProps, changeFlags}\n   * @param {Object} params - object {dimension, compareAll}\n   * @param {Object} params.dimension - {props, accessors} array of props and/or accessors\n   * @param {Boolean} params.compareAll - when `true` it will include non layer props for comparision\n   * @returns {Boolean} - returns true if dimensions' prop or accessor is changed\n   **/\n  isAggregationDirty(updateOpts, params = {}) {\n    const {props, oldProps, changeFlags} = updateOpts;\n    const {compareAll = false, dimension} = params;\n    const {ignoreProps} = this.state;\n    const {props: dataProps, accessors = []} = dimension;\n    const {updateTriggersChanged} = changeFlags;\n    if (updateTriggersChanged) {\n      if (updateTriggersChanged.all) {\n        return true;\n      }\n      for (const accessor of accessors) {\n        if (updateTriggersChanged[accessor]) {\n          return true;\n        }\n      }\n    }\n    if (compareAll) {\n      if (changeFlags.extensionsChanged) {\n        return true;\n      }\n      // Compare non layer props too (like extension props)\n      // ignoreprops refers to all Layer props other than aggregation props that need to be comapred\n      return compareProps({\n        oldProps,\n        newProps: props,\n        ignoreProps,\n        propTypes: this.constructor._propTypes\n      });\n    }\n    // Compare props of the dimension\n    for (const name of dataProps) {\n      if (props[name] !== oldProps[name]) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  /**\n   * Checks if an attribute is changed\n   * @param {String} name - name of the attribute\n   * @returns {Boolean} - `true` if attribute `name` is changed, `false` otherwise,\n   *                       If `name` is not passed or `undefiend`, `true` if any attribute is changed, `false` otherwise\n   **/\n  isAttributeChanged(name) {\n    const {changedAttributes} = this.state;\n    if (!name) {\n      // if name not specified return true if any attribute is changed\n      return !isObjectEmpty(changedAttributes);\n    }\n    return changedAttributes && changedAttributes[name] !== undefined;\n  }\n\n  // Private\n\n  // override Composite layer private method to create AttributeManager instance\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats\n    });\n  }\n}\n\n// Helper methods\n\n// Returns true if given object is empty, false otherwise.\nfunction isObjectEmpty(obj) {\n  let isEmpty = true;\n  /* eslint-disable no-unused-vars  */\n  for (const key in obj) {\n    isEmpty = false;\n    break;\n  }\n  /* eslint-enable no-unused-vars  */\n  return isEmpty;\n}\n\nAggregationLayer.layerName = 'AggregationLayer';\n"],"file":"aggregation-layer.js"}