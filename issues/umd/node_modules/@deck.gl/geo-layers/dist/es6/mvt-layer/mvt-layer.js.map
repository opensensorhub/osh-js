{"version":3,"sources":["../../../src/mvt-layer/mvt-layer.js"],"names":["Matrix4","MVTLoader","load","COORDINATE_SYSTEM","TileLayer","getURLFromTemplate","ClipExtension","WORLD_SIZE","defaultProps","uniqueIdProperty","type","value","highlightedFeatureId","MVTLayer","getTileData","tile","url","props","data","Promise","reject","options","getLoadOptions","mvt","coordinates","context","viewport","resolution","tileIndex","x","y","z","renderSubLayers","worldScale","Math","pow","xScale","yScale","xOffset","yOffset","modelMatrix","scale","autoHighlight","coordinateOrigin","coordinateSystem","CARTESIAN","extensions","onHover","info","pickingEvent","hoveredFeatureId","state","hoveredFeature","object","newHoveredFeatureId","getFeatureUniqueId","setState","getHighlightedObjectIndex","isFeatureIdPresent","isFeatureIdDefined","Array","isArray","featureIdToHighlight","findIndex","feature","properties","id","undefined","layerName"],"mappings":"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","sourcesContent":["import {Matrix4} from 'math.gl';\nimport {MVTLoader} from '@loaders.gl/mvt';\nimport {load} from '@loaders.gl/core';\nimport {COORDINATE_SYSTEM} from '@deck.gl/core';\n\nimport TileLayer from '../tile-layer/tile-layer';\nimport {getURLFromTemplate} from '../tile-layer/utils';\nimport ClipExtension from './clip-extension';\n\nconst WORLD_SIZE = 512;\n\nconst defaultProps = {\n  uniqueIdProperty: {type: 'string', value: ''},\n  highlightedFeatureId: null\n};\n\nexport default class MVTLayer extends TileLayer {\n  getTileData(tile) {\n    const url = getURLFromTemplate(this.props.data, tile);\n    if (!url) {\n      return Promise.reject('Invalid URL');\n    }\n    let options = this.getLoadOptions();\n    options = {\n      ...options,\n      mvt: {\n        ...(options && options.mvt),\n        coordinates: this.context.viewport.resolution ? 'wgs84' : 'local',\n        tileIndex: {x: tile.x, y: tile.y, z: tile.z}\n      }\n    };\n    return load(url, MVTLoader, options);\n  }\n\n  renderSubLayers(props) {\n    const {tile} = props;\n    const worldScale = Math.pow(2, tile.z);\n\n    const xScale = WORLD_SIZE / worldScale;\n    const yScale = -xScale;\n\n    const xOffset = (WORLD_SIZE * tile.x) / worldScale;\n    const yOffset = WORLD_SIZE * (1 - tile.y / worldScale);\n\n    const modelMatrix = new Matrix4().scale([xScale, yScale, 1]);\n\n    props.autoHighlight = false;\n    if (!this.context.viewport.resolution) {\n      props.modelMatrix = modelMatrix;\n      props.coordinateOrigin = [xOffset, yOffset, 0];\n      props.coordinateSystem = COORDINATE_SYSTEM.CARTESIAN;\n      props.extensions = [...(props.extensions || []), new ClipExtension()];\n    }\n\n    return super.renderSubLayers(props);\n  }\n\n  onHover(info, pickingEvent) {\n    const {uniqueIdProperty, autoHighlight} = this.props;\n\n    if (autoHighlight) {\n      const {hoveredFeatureId} = this.state;\n      const hoveredFeature = info.object;\n      let newHoveredFeatureId;\n\n      if (hoveredFeature) {\n        newHoveredFeatureId = getFeatureUniqueId(hoveredFeature, uniqueIdProperty);\n      }\n\n      if (hoveredFeatureId !== newHoveredFeatureId && newHoveredFeatureId !== -1) {\n        this.setState({hoveredFeatureId: newHoveredFeatureId});\n      }\n    }\n\n    return super.onHover(info, pickingEvent);\n  }\n\n  getHighlightedObjectIndex(tile) {\n    const {hoveredFeatureId} = this.state;\n    const {uniqueIdProperty, highlightedFeatureId} = this.props;\n    const {data} = tile;\n\n    const isFeatureIdPresent =\n      isFeatureIdDefined(hoveredFeatureId) || isFeatureIdDefined(highlightedFeatureId);\n\n    if (!isFeatureIdPresent || !Array.isArray(data)) {\n      return -1;\n    }\n\n    const featureIdToHighlight = isFeatureIdDefined(highlightedFeatureId)\n      ? highlightedFeatureId\n      : hoveredFeatureId;\n\n    return data.findIndex(\n      feature => getFeatureUniqueId(feature, uniqueIdProperty) === featureIdToHighlight\n    );\n  }\n}\n\nfunction getFeatureUniqueId(feature, uniqueIdProperty) {\n  if (uniqueIdProperty) {\n    return feature.properties[uniqueIdProperty];\n  }\n\n  if ('id' in feature) {\n    return feature.id;\n  }\n\n  return -1;\n}\n\nfunction isFeatureIdDefined(value) {\n  return value !== undefined && value !== null && value !== '';\n}\n\nMVTLayer.layerName = 'MVTLayer';\nMVTLayer.defaultProps = defaultProps;\n"],"file":"mvt-layer.js"}