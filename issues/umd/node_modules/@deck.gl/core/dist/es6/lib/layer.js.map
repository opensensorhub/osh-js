{"version":3,"sources":["../../../src/lib/layer.js"],"names":["COORDINATE_SYSTEM","AttributeManager","UniformTransitionManager","diffProps","validateProps","count","log","debug","withParameters","setParameters","assert","memoize","mergeShaders","projectPosition","getWorldPosition","typedArrayManager","Component","LayerState","worldToPixels","load","TRACE_CHANGE_FLAG","TRACE_INITIALIZE","TRACE_UPDATE","TRACE_FINALIZE","TRACE_MATCHED","MAX_PICKING_COLOR_CACHE_SIZE","EMPTY_ARRAY","Object","freeze","areViewportsEqual","oldViewport","viewport","equals","pickingColorCache","Uint8ClampedArray","defaultProps","data","type","value","async","dataComparator","_dataDiff","__diff","compare","optional","dataTransform","onDataLoad","fetch","url","propName","layer","resourceManager","context","loadOptions","getLoadOptions","inResourceManager","contains","add","resourceId","persistent","subscribe","onChange","internalState","reloadAsyncProp","consumerId","id","requestId","updateTriggers","visible","pickable","opacity","min","max","onHover","onClick","onDragStart","onDrag","onDragEnd","coordinateSystem","DEFAULT","coordinateOrigin","modelMatrix","wrapLongitude","positionFormat","colorFormat","parameters","uniforms","extensions","getPolygonOffset","layerIndex","highlightedObjectIndex","autoHighlight","highlightColor","Layer","toString","className","constructor","layerName","name","props","setState","updateObject","setChangeFlags","stateChanged","assign","state","setNeedsRedraw","redraw","needsRedraw","setNeedsUpdate","layerManager","String","needsUpdate","getNeedsRedraw","opts","clearRedrawFlags","_getNeedsRedraw","hasUniformTransition","shouldUpdateState","_getUpdateParams","uniformTransitions","active","isLoaded","isAsyncPropLoading","isPickable","getModels","models","model","getAttributeManager","attributeManager","getCurrentLayer","project","xyz","worldPosition","x","y","z","pixelProjectionMatrix","length","unproject","xy","use64bitPositions","LNGLAT","CARTESIAN","info","pickingEvent","nullPickingColor","encodePickingColor","i","target","decodePickingColor","color","Uint8Array","i1","i2","i3","index","initializeState","Error","getShaders","shaders","extension","call","oldProps","changeFlags","propsOrDataChanged","updateState","dataChanged","Array","isArray","dataRange","invalidateAll","neededPickingBuffer","needPickingBuffer","pickingColors","instancePickingColors","attributes","pickingColorsAttribute","constant","invalidate","finalizeState","delete","finalize","unsubscribe","clear","draw","getPickingInfo","mode","object","activateViewport","viewportChanged","_update","invalidateAttribute","diffReason","updateAttributes","changedAttributes","_setModelAttributes","_updateAttributes","numInstances","getNumInstances","startIndices","getStartIndices","update","transitions","buffers","ignoreUnknownAttributes","getChangedAttributes","clearChangedFlags","_updateAttributeTransition","updateTransition","_updateUniformTransition","propsInTransition","create","key","defineProperty","calculateInstancePickingColors","attribute","cacheSize","warn","allocate","size","copy","maxCount","Math","newCacheSize","pickingColor","subarray","excludeAttributes","userData","shaderAttributes","getShaderAttributes","setAttributes","disablePickingIndex","objectIndex","_disablePickingIndex","colors","start","getVertexOffset","end","buffer","subData","offset","restorePickingColors","updateSubBuffer","startOffset","undefined","_initialize","_initState","propsChanged","extensionsChanged","_updateState","stateNeedsUpdate","currentProps","currentViewport","updateParams","oldModels","gl","error","modelChanged","_updateModules","isComposite","_renderLayers","setInstanceCount","clearChangeFlags","resetOldProps","_finalize","drawLayer","moduleParameters","pow","setModuleParameters","offsets","polygonOffset","getChangeFlags","flags","flagChanged","concat","updateTriggersChanged","somethingChanged","newProps","transitionsChanged","updateModuleSettings","forceUpdate","pickingSelectedColor","pickingHighlightColor","Number","isInteger","getOldProps","attributeManagerNeedsRedraw","_getAttributeManager","stats","timeline","isFinite","addInstanced","noAlloc","get","deprecated","onAsyncPropUpdated","_onAsyncPropUpdated","bind","setAsyncProps","_transferState","oldLayer"],"mappings":"AAqBA,SAAQA,iBAAR,QAAgC,aAAhC;AACA,OAAOC,gBAAP,MAA6B,+BAA7B;AACA,OAAOC,wBAAP,MAAqC,8BAArC;AACA,SAAQC,SAAR,EAAmBC,aAAnB,QAAuC,oBAAvC;AACA,SAAQC,KAAR,QAAoB,gBAApB;AACA,OAAOC,GAAP,MAAgB,cAAhB;AACA,OAAOC,KAAP,MAAkB,UAAlB;AAEA,SAAQC,cAAR,EAAwBC,aAAxB,QAA4C,eAA5C;AACA,OAAOC,MAAP,MAAmB,iBAAnB;AACA,OAAOC,OAAP,MAAoB,kBAApB;AACA,SAAQC,YAAR,QAA2B,iBAA3B;AACA,SAAQC,eAAR,EAAyBC,gBAAzB,QAAgD,wCAAhD;AACA,OAAOC,iBAAP,MAA8B,8BAA9B;AAEA,OAAOC,SAAP,MAAsB,wBAAtB;AACA,OAAOC,UAAP,MAAuB,eAAvB;AAEA,SAAQC,aAAR,QAA4B,uBAA5B;AAEA,SAAQC,IAAR,QAAmB,kBAAnB;AAEA,MAAMC,iBAAiB,GAAG,kBAA1B;AACA,MAAMC,gBAAgB,GAAG,kBAAzB;AACA,MAAMC,YAAY,GAAG,cAArB;AACA,MAAMC,cAAc,GAAG,gBAAvB;AACA,MAAMC,aAAa,GAAG,eAAtB;AAEA,MAAMC,4BAA4B,GAAG,KAAK,EAAL,GAAU,CAA/C;AAEA,MAAMC,WAAW,GAAGC,MAAM,CAACC,MAAP,CAAc,EAAd,CAApB;AAGA,MAAMC,iBAAiB,GAAGlB,OAAO,CAAC,CAAC;AAACmB,EAAAA,WAAD;AAAcC,EAAAA;AAAd,CAAD,KAA6B;AAC7D,SAAOD,WAAW,CAACE,MAAZ,CAAmBD,QAAnB,CAAP;AACD,CAFgC,CAAjC;AAIA,IAAIE,iBAAiB,GAAG,IAAIC,iBAAJ,CAAsB,CAAtB,CAAxB;AAEA,MAAMC,YAAY,GAAG;AAEnBC,EAAAA,IAAI,EAAE;AAACC,IAAAA,IAAI,EAAE,MAAP;AAAeC,IAAAA,KAAK,EAAEZ,WAAtB;AAAmCa,IAAAA,KAAK,EAAE;AAA1C,GAFa;AAGnBC,EAAAA,cAAc,EAAE,IAHG;AAInBC,EAAAA,SAAS,EAAE;AAACJ,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAEF,IAAI,IAAIA,IAAI,IAAIA,IAAI,CAACM,MAA/C;AAAuDC,IAAAA,OAAO,EAAE,KAAhE;AAAuEC,IAAAA,QAAQ,EAAE;AAAjF,GAJQ;AAKnBC,EAAAA,aAAa,EAAE;AAACR,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GALI;AAMnBE,EAAAA,UAAU,EAAE;AAACT,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GANO;AAOnBG,EAAAA,KAAK,EAAE;AACLV,IAAAA,IAAI,EAAE,UADD;AAELC,IAAAA,KAAK,EAAE,CAACU,GAAD,EAAM;AAACC,MAAAA,QAAD;AAAWC,MAAAA;AAAX,KAAN,KAA4B;AACjC,YAAM;AAACC,QAAAA;AAAD,UAAoBD,KAAK,CAACE,OAAhC;AACA,YAAMC,WAAW,GAAGH,KAAK,CAACI,cAAN,EAApB;AACA,UAAIC,iBAAiB,GAAGJ,eAAe,CAACK,QAAhB,CAAyBR,GAAzB,CAAxB;;AAEA,UAAI,CAACO,iBAAD,IAAsB,CAACF,WAA3B,EAAwC;AAEtCF,QAAAA,eAAe,CAACM,GAAhB,CAAoB;AAACC,UAAAA,UAAU,EAAEV,GAAb;AAAkBZ,UAAAA,IAAI,EAAEY,GAAxB;AAA6BW,UAAAA,UAAU,EAAE;AAAzC,SAApB;AACAJ,QAAAA,iBAAiB,GAAG,IAApB;AACD;;AACD,UAAIA,iBAAJ,EAAuB;AACrB,eAAOJ,eAAe,CAACS,SAAhB,CAA0B;AAC/BF,UAAAA,UAAU,EAAEV,GADmB;AAE/Ba,UAAAA,QAAQ,EAAEzB,IAAI,IAAIc,KAAK,CAACY,aAAN,CAAoBC,eAApB,CAAoCd,QAApC,EAA8Cb,IAA9C,CAFa;AAG/B4B,UAAAA,UAAU,EAAEd,KAAK,CAACe,EAHa;AAI/BC,UAAAA,SAAS,EAAEjB;AAJoB,SAA1B,CAAP;AAMD;;AAED,aAAO9B,IAAI,CAAC6B,GAAD,EAAMK,WAAN,CAAX;AACD,KAtBI;AAuBLV,IAAAA,OAAO,EAAE;AAvBJ,GAPY;AAgCnBwB,EAAAA,cAAc,EAAE,EAhCG;AAkCnBC,EAAAA,OAAO,EAAE,IAlCU;AAmCnBC,EAAAA,QAAQ,EAAE,KAnCS;AAoCnBC,EAAAA,OAAO,EAAE;AAACjC,IAAAA,IAAI,EAAE,QAAP;AAAiBkC,IAAAA,GAAG,EAAE,CAAtB;AAAyBC,IAAAA,GAAG,EAAE,CAA9B;AAAiClC,IAAAA,KAAK,EAAE;AAAxC,GApCU;AAsCnBmC,EAAAA,OAAO,EAAE;AAACpC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GAtCU;AAuCnB8B,EAAAA,OAAO,EAAE;AAACrC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GAvCU;AAwCnB+B,EAAAA,WAAW,EAAE;AAACtC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GAxCM;AAyCnBgC,EAAAA,MAAM,EAAE;AAACvC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GAzCW;AA0CnBiC,EAAAA,SAAS,EAAE;AAACxC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,IAA1B;AAAgCK,IAAAA,OAAO,EAAE,KAAzC;AAAgDC,IAAAA,QAAQ,EAAE;AAA1D,GA1CQ;AA4CnBkC,EAAAA,gBAAgB,EAAE9E,iBAAiB,CAAC+E,OA5CjB;AA6CnBC,EAAAA,gBAAgB,EAAE;AAAC3C,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAvB;AAAkCK,IAAAA,OAAO,EAAE;AAA3C,GA7CC;AA8CnBsC,EAAAA,WAAW,EAAE;AAAC5C,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,KAAK,EAAE,IAAvB;AAA6BK,IAAAA,OAAO,EAAE,IAAtC;AAA4CC,IAAAA,QAAQ,EAAE;AAAtD,GA9CM;AA+CnBsC,EAAAA,aAAa,EAAE,KA/CI;AAgDnBC,EAAAA,cAAc,EAAE,KAhDG;AAiDnBC,EAAAA,WAAW,EAAE,MAjDM;AAmDnBC,EAAAA,UAAU,EAAE,EAnDO;AAoDnBC,EAAAA,QAAQ,EAAE,EApDS;AAqDnBC,EAAAA,UAAU,EAAE,EArDO;AA0DnBC,EAAAA,gBAAgB,EAAE;AAChBnD,IAAAA,IAAI,EAAE,UADU;AAEhBC,IAAAA,KAAK,EAAE,CAAC;AAACmD,MAAAA;AAAD,KAAD,KAAkB,CAAC,CAAD,EAAI,CAACA,UAAD,GAAc,GAAlB,CAFT;AAGhB9C,IAAAA,OAAO,EAAE;AAHO,GA1DC;AAiEnB+C,EAAAA,sBAAsB,EAAE,CAAC,CAjEN;AAkEnBC,EAAAA,aAAa,EAAE,KAlEI;AAmEnBC,EAAAA,cAAc,EAAE;AAACvD,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,GAAP,EAAY,GAAZ;AAA1B;AAnEG,CAArB;AAsEA,eAAe,MAAMuD,KAAN,SAAoB7E,SAApB,CAA8B;AAC3C8E,EAAAA,QAAQ,GAAG;AACT,UAAMC,SAAS,GAAG,KAAKC,WAAL,CAAiBC,SAAjB,IAA8B,KAAKD,WAAL,CAAiBE,IAAjE;AACA,qBAAUH,SAAV,oBAA6B,KAAKI,KAAL,CAAWlC,EAAxC;AACD;;AAKDmC,EAAAA,QAAQ,CAACC,YAAD,EAAe;AACrB,SAAKC,cAAL,CAAoB;AAACC,MAAAA,YAAY,EAAE;AAAf,KAApB;AACA5E,IAAAA,MAAM,CAAC6E,MAAP,CAAc,KAAKC,KAAnB,EAA0BJ,YAA1B;AACA,SAAKK,cAAL;AACD;;AAGDA,EAAAA,cAAc,CAACC,MAAM,GAAG,IAAV,EAAgB;AAC5B,QAAI,KAAK7C,aAAT,EAAwB;AACtB,WAAKA,aAAL,CAAmB8C,WAAnB,GAAiCD,MAAjC;AACD;AACF;;AAGDE,EAAAA,cAAc,GAAG;AACf,SAAKzD,OAAL,CAAa0D,YAAb,CAA0BD,cAA1B,CAAyCE,MAAM,CAAC,IAAD,CAA/C;AACA,SAAKjD,aAAL,CAAmBkD,WAAnB,GAAiC,IAAjC;AACD;;AAGDC,EAAAA,cAAc,CAACC,IAAI,GAAG;AAACC,IAAAA,gBAAgB,EAAE;AAAnB,GAAR,EAAmC;AAC/C,WAAO,KAAKC,eAAL,CAAqBF,IAArB,CAAP;AACD;;AAGDF,EAAAA,WAAW,GAAG;AAEZ,WACE,KAAKlD,aAAL,CAAmBkD,WAAnB,IACA,KAAKK,oBAAL,EADA,IAEA,KAAKC,iBAAL,CAAuB,KAAKC,gBAAL,EAAvB,CAHF;AAMD;;AAEDF,EAAAA,oBAAoB,GAAG;AACrB,WAAO,KAAKvD,aAAL,CAAmB0D,kBAAnB,CAAsCC,MAA7C;AACD;;AAED,MAAIC,QAAJ,GAAe;AACb,WAAO,KAAK5D,aAAL,IAAsB,CAAC,KAAKA,aAAL,CAAmB6D,kBAAnB,EAA9B;AACD;;AAED,MAAIzC,aAAJ,GAAoB;AAClB,WAAO,KAAKiB,KAAL,CAAWjB,aAAlB;AACD;;AAGD0C,EAAAA,UAAU,GAAG;AACX,WAAO,KAAKzB,KAAL,CAAW9B,QAAX,IAAuB,KAAK8B,KAAL,CAAW/B,OAAzC;AACD;;AAGDyD,EAAAA,SAAS,GAAG;AACV,WAAO,KAAKpB,KAAL,KAAe,KAAKA,KAAL,CAAWqB,MAAX,KAAsB,KAAKrB,KAAL,CAAWsB,KAAX,GAAmB,CAAC,KAAKtB,KAAL,CAAWsB,KAAZ,CAAnB,GAAwC,EAA9D,CAAf,CAAP;AACD;;AAEDC,EAAAA,mBAAmB,GAAG;AACpB,WAAO,KAAKlE,aAAL,IAAsB,KAAKA,aAAL,CAAmBmE,gBAAhD;AACD;;AAIDC,EAAAA,eAAe,GAAG;AAChB,WAAO,KAAKpE,aAAL,IAAsB,KAAKA,aAAL,CAAmBZ,KAAhD;AACD;;AAGDI,EAAAA,cAAc,GAAG;AACf,WAAO,KAAK6C,KAAL,CAAW9C,WAAlB;AACD;;AAMD8E,EAAAA,OAAO,CAACC,GAAD,EAAM;AACX,UAAM;AAACrG,MAAAA;AAAD,QAAa,KAAKqB,OAAxB;AACA,UAAMiF,aAAa,GAAGvH,gBAAgB,CAACsH,GAAD,EAAM;AAC1CrG,MAAAA,QAD0C;AAE1CkD,MAAAA,WAAW,EAAE,KAAKkB,KAAL,CAAWlB,WAFkB;AAG1CD,MAAAA,gBAAgB,EAAE,KAAKmB,KAAL,CAAWnB,gBAHa;AAI1CF,MAAAA,gBAAgB,EAAE,KAAKqB,KAAL,CAAWrB;AAJa,KAAN,CAAtC;AAMA,UAAM,CAACwD,CAAD,EAAIC,CAAJ,EAAOC,CAAP,IAAYtH,aAAa,CAACmH,aAAD,EAAgBtG,QAAQ,CAAC0G,qBAAzB,CAA/B;AACA,WAAOL,GAAG,CAACM,MAAJ,KAAe,CAAf,GAAmB,CAACJ,CAAD,EAAIC,CAAJ,CAAnB,GAA4B,CAACD,CAAD,EAAIC,CAAJ,EAAOC,CAAP,CAAnC;AACD;;AAIDG,EAAAA,SAAS,CAACC,EAAD,EAAK;AACZ,UAAM;AAAC7G,MAAAA;AAAD,QAAa,KAAKqB,OAAxB;AACA,WAAOrB,QAAQ,CAAC4G,SAAT,CAAmBC,EAAnB,CAAP;AACD;;AAED/H,EAAAA,eAAe,CAACuH,GAAD,EAAM;AACnB,WAAOvH,eAAe,CAACuH,GAAD,EAAM;AAC1BrG,MAAAA,QAAQ,EAAE,KAAKqB,OAAL,CAAarB,QADG;AAE1BkD,MAAAA,WAAW,EAAE,KAAKkB,KAAL,CAAWlB,WAFE;AAG1BD,MAAAA,gBAAgB,EAAE,KAAKmB,KAAL,CAAWnB,gBAHH;AAI1BF,MAAAA,gBAAgB,EAAE,KAAKqB,KAAL,CAAWrB;AAJH,KAAN,CAAtB;AAMD;;AAED+D,EAAAA,iBAAiB,GAAG;AAClB,UAAM;AAAC/D,MAAAA;AAAD,QAAqB,KAAKqB,KAAhC;AACA,WACErB,gBAAgB,KAAK9E,iBAAiB,CAAC+E,OAAvC,IACAD,gBAAgB,KAAK9E,iBAAiB,CAAC8I,MADvC,IAEAhE,gBAAgB,KAAK9E,iBAAiB,CAAC+I,SAHzC;AAKD;;AAGDtE,EAAAA,OAAO,CAACuE,IAAD,EAAOC,YAAP,EAAqB;AAC1B,QAAI,KAAK9C,KAAL,CAAW1B,OAAf,EAAwB;AACtB,aAAO,KAAK0B,KAAL,CAAW1B,OAAX,CAAmBuE,IAAnB,EAAyBC,YAAzB,CAAP;AACD;;AACD,WAAO,KAAP;AACD;;AAEDvE,EAAAA,OAAO,CAACsE,IAAD,EAAOC,YAAP,EAAqB;AAC1B,QAAI,KAAK9C,KAAL,CAAWzB,OAAf,EAAwB;AACtB,aAAO,KAAKyB,KAAL,CAAWzB,OAAX,CAAmBsE,IAAnB,EAAyBC,YAAzB,CAAP;AACD;;AACD,WAAO,KAAP;AACD;;AAKDC,EAAAA,gBAAgB,GAAG;AACjB,WAAO,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAAP;AACD;;AAIDC,EAAAA,kBAAkB,CAACC,CAAD,EAAIC,MAAM,GAAG,EAAb,EAAiB;AACjCA,IAAAA,MAAM,CAAC,CAAD,CAAN,GAAaD,CAAC,GAAG,CAAL,GAAU,GAAtB;AACAC,IAAAA,MAAM,CAAC,CAAD,CAAN,GAAcD,CAAC,GAAG,CAAL,IAAW,CAAZ,GAAiB,GAA7B;AACAC,IAAAA,MAAM,CAAC,CAAD,CAAN,GAAeD,CAAC,GAAG,CAAL,IAAW,CAAZ,IAAkB,CAAnB,GAAwB,GAApC;AACA,WAAOC,MAAP;AACD;;AAKDC,EAAAA,kBAAkB,CAACC,KAAD,EAAQ;AACxB7I,IAAAA,MAAM,CAAC6I,KAAK,YAAYC,UAAlB,CAAN;AACA,UAAM,CAACC,EAAD,EAAKC,EAAL,EAASC,EAAT,IAAeJ,KAArB;AAEA,UAAMK,KAAK,GAAGH,EAAE,GAAGC,EAAE,GAAG,GAAV,GAAgBC,EAAE,GAAG,KAArB,GAA6B,CAA3C;AACA,WAAOC,KAAP;AACD;;AAODC,EAAAA,eAAe,GAAG;AAChB,UAAM,IAAIC,KAAJ,iBAAmB,IAAnB,sCAAN;AACD;;AAEDC,EAAAA,UAAU,CAACC,OAAD,EAAU;AAClB,SAAK,MAAMC,SAAX,IAAwB,KAAK9D,KAAL,CAAWZ,UAAnC,EAA+C;AAC7CyE,MAAAA,OAAO,GAAGpJ,YAAY,CAACoJ,OAAD,EAAUC,SAAS,CAACF,UAAV,CAAqBG,IAArB,CAA0B,IAA1B,EAAgCD,SAAhC,CAAV,CAAtB;AACD;;AACD,WAAOD,OAAP;AACD;;AAGD1C,EAAAA,iBAAiB,CAAC;AAAC6C,IAAAA,QAAD;AAAWhE,IAAAA,KAAX;AAAkB/C,IAAAA,OAAlB;AAA2BgH,IAAAA;AAA3B,GAAD,EAA0C;AACzD,WAAOA,WAAW,CAACC,kBAAnB;AACD;;AAKDC,EAAAA,WAAW,CAAC;AAACH,IAAAA,QAAD;AAAWhE,IAAAA,KAAX;AAAkB/C,IAAAA,OAAlB;AAA2BgH,IAAAA;AAA3B,GAAD,EAA0C;AACnD,UAAMnC,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;;AACA,QAAIoC,WAAW,CAACG,WAAZ,IAA2BtC,gBAA/B,EAAiD;AAC/C,YAAM;AAACsC,QAAAA;AAAD,UAAgBH,WAAtB;;AACA,UAAII,KAAK,CAACC,OAAN,CAAcF,WAAd,CAAJ,EAAgC;AAE9B,aAAK,MAAMG,SAAX,IAAwBH,WAAxB,EAAqC;AACnCtC,UAAAA,gBAAgB,CAAC0C,aAAjB,CAA+BD,SAA/B;AACD;AACF,OALD,MAKO;AACLzC,QAAAA,gBAAgB,CAAC0C,aAAjB;AACD;AACF;;AAED,UAAMC,mBAAmB,GAAGT,QAAQ,CAACzE,sBAAT,IAAmC,CAAnC,IAAwCyE,QAAQ,CAAC9F,QAA7E;AACA,UAAMwG,iBAAiB,GAAG1E,KAAK,CAACT,sBAAN,IAAgC,CAAhC,IAAqCS,KAAK,CAAC9B,QAArE;;AACA,QAAIuG,mBAAmB,KAAKC,iBAAxB,IAA6C5C,gBAAjD,EAAmE;AACjE,YAAM;AAAC6C,QAAAA,aAAD;AAAgBC,QAAAA;AAAhB,UAAyC9C,gBAAgB,CAAC+C,UAAhE;AACA,YAAMC,sBAAsB,GAAGH,aAAa,IAAIC,qBAAhD;;AACA,UAAIE,sBAAJ,EAA4B;AAC1B,YAAIJ,iBAAiB,IAAII,sBAAsB,CAACC,QAAhD,EAA0D;AACxDD,UAAAA,sBAAsB,CAACC,QAAvB,GAAkC,KAAlC;AACAjD,UAAAA,gBAAgB,CAACkD,UAAjB,CAA4BF,sBAAsB,CAAChH,EAAnD;AACD;;AACD,YAAI,CAACgH,sBAAsB,CAAC3I,KAAxB,IAAiC,CAACuI,iBAAtC,EAAyD;AACvDI,UAAAA,sBAAsB,CAACC,QAAvB,GAAkC,IAAlC;AACAD,UAAAA,sBAAsB,CAAC3I,KAAvB,GAA+B,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,CAA/B;AACD;AACF;AACF;AACF;;AAID8I,EAAAA,aAAa,GAAG;AACd,SAAK,MAAMrD,KAAX,IAAoB,KAAKF,SAAL,EAApB,EAAsC;AACpCE,MAAAA,KAAK,CAACsD,MAAN;AACD;;AACD,UAAMpD,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;;AACA,QAAIC,gBAAJ,EAAsB;AACpBA,MAAAA,gBAAgB,CAACqD,QAAjB;AACD;;AACD,SAAKlI,OAAL,CAAaD,eAAb,CAA6BoI,WAA7B,CAAyC;AAACvH,MAAAA,UAAU,EAAE,KAAKC;AAAlB,KAAzC;AACA,SAAKH,aAAL,CAAmB0D,kBAAnB,CAAsCgE,KAAtC;AACD;;AAGDC,EAAAA,IAAI,CAACvE,IAAD,EAAO;AACT,SAAK,MAAMa,KAAX,IAAoB,KAAKF,SAAL,EAApB,EAAsC;AACpCE,MAAAA,KAAK,CAAC0D,IAAN,CAAWvE,IAAX;AACD;AACF;;AAIDwE,EAAAA,cAAc,CAAC;AAAC1C,IAAAA,IAAD;AAAO2C,IAAAA;AAAP,GAAD,EAAe;AAC3B,UAAM;AAAC/B,MAAAA;AAAD,QAAUZ,IAAhB;;AAEA,QAAIY,KAAK,IAAI,CAAb,EAAgB;AAEd,UAAIY,KAAK,CAACC,OAAN,CAAc,KAAKtE,KAAL,CAAW/D,IAAzB,CAAJ,EAAoC;AAClC4G,QAAAA,IAAI,CAAC4C,MAAL,GAAc,KAAKzF,KAAL,CAAW/D,IAAX,CAAgBwH,KAAhB,CAAd;AACD;AACF;;AAED,WAAOZ,IAAP;AACD;;AAMD6C,EAAAA,gBAAgB,CAAC9J,QAAD,EAAW;AACzB,UAAMD,WAAW,GAAG,KAAKgC,aAAL,CAAmB/B,QAAvC;AACA,SAAK+B,aAAL,CAAmB/B,QAAnB,GAA8BA,QAA9B;;AAEA,QAAI,CAACD,WAAD,IAAgB,CAACD,iBAAiB,CAAC;AAACC,MAAAA,WAAD;AAAcC,MAAAA;AAAd,KAAD,CAAtC,EAAiE;AAC/D,WAAKuE,cAAL,CAAoB;AAACwF,QAAAA,eAAe,EAAE;AAAlB,OAApB;;AACA,WAAKC,OAAL;AACD;AACF;;AAGDC,EAAAA,mBAAmB,CAAC9F,IAAI,GAAG,KAAR,EAAe+F,UAAU,GAAG,EAA5B,EAAgC;AACjD,UAAMhE,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;;AACA,QAAI,CAACC,gBAAL,EAAuB;AACrB;AACD;;AAED,QAAI/B,IAAI,KAAK,KAAb,EAAoB;AAClB+B,MAAAA,gBAAgB,CAAC0C,aAAjB;AACD,KAFD,MAEO;AACL1C,MAAAA,gBAAgB,CAACkD,UAAjB,CAA4BjF,IAA5B;AACD;AACF;;AAEDgG,EAAAA,gBAAgB,CAACC,iBAAD,EAAoB;AAClC,SAAK,MAAMpE,KAAX,IAAoB,KAAKF,SAAL,EAApB,EAAsC;AACpC,WAAKuE,mBAAL,CAAyBrE,KAAzB,EAAgCoE,iBAAhC;AACD;AACF;;AAGDE,EAAAA,iBAAiB,CAAClG,KAAD,EAAQ;AACvB,UAAM8B,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;;AACA,QAAI,CAACC,gBAAL,EAAuB;AACrB;AACD;;AAGD,UAAMqE,YAAY,GAAG,KAAKC,eAAL,CAAqBpG,KAArB,CAArB;AACA,UAAMqG,YAAY,GAAG,KAAKC,eAAL,CAAqBtG,KAArB,CAArB;AAEA8B,IAAAA,gBAAgB,CAACyE,MAAjB,CAAwB;AACtBtK,MAAAA,IAAI,EAAE+D,KAAK,CAAC/D,IADU;AAEtBkK,MAAAA,YAFsB;AAGtBE,MAAAA,YAHsB;AAItBrG,MAAAA,KAJsB;AAKtBwG,MAAAA,WAAW,EAAExG,KAAK,CAACwG,WALG;AAMtBC,MAAAA,OAAO,EAAEzG,KAAK,CAAC/D,IAAN,CAAW4I,UANE;AAOtB5H,MAAAA,OAAO,EAAE,IAPa;AAStByJ,MAAAA,uBAAuB,EAAE;AATH,KAAxB;AAYA,UAAMV,iBAAiB,GAAGlE,gBAAgB,CAAC6E,oBAAjB,CAAsC;AAACC,MAAAA,iBAAiB,EAAE;AAApB,KAAtC,CAA1B;AACA,SAAKb,gBAAL,CAAsBC,iBAAtB;AACD;;AAGDa,EAAAA,0BAA0B,GAAG;AAC3B,UAAM/E,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;;AACA,QAAIC,gBAAJ,EAAsB;AACpBA,MAAAA,gBAAgB,CAACgF,gBAAjB;AACD;AACF;;AAGDC,EAAAA,wBAAwB,GAAG;AACzB,UAAM;AAAC1F,MAAAA;AAAD,QAAuB,KAAK1D,aAAlC;;AACA,QAAI0D,kBAAkB,CAACC,MAAvB,EAA+B;AAE7B,YAAM0F,iBAAiB,GAAG3F,kBAAkB,CAACkF,MAAnB,EAA1B;AACA,YAAMvG,KAAK,GAAGxE,MAAM,CAACyL,MAAP,CAAc,KAAKjH,KAAnB,CAAd;;AACA,WAAK,MAAMkH,GAAX,IAAkBF,iBAAlB,EAAqC;AACnCxL,QAAAA,MAAM,CAAC2L,cAAP,CAAsBnH,KAAtB,EAA6BkH,GAA7B,EAAkC;AAAC/K,UAAAA,KAAK,EAAE6K,iBAAiB,CAACE,GAAD;AAAzB,SAAlC;AACD;;AACD,aAAOlH,KAAP;AACD;;AACD,WAAO,KAAKA,KAAZ;AACD;;AAEDoH,EAAAA,8BAA8B,CAACC,SAAD,EAAY;AAAClB,IAAAA;AAAD,GAAZ,EAA4B;AACxD,QAAIkB,SAAS,CAACtC,QAAd,EAAwB;AACtB;AACD;;AAID,UAAMuC,SAAS,GAAGxL,iBAAiB,CAACyG,MAAlB,GAA2B,CAA7C;;AAEA,QAAI+E,SAAS,GAAGnB,YAAhB,EAA8B;AAC5B,UAAIA,YAAY,GAAG7K,4BAAnB,EAAiD;AAC/CnB,QAAAA,GAAG,CAACoN,IAAJ,CACE,wFADF;AAGD;;AAEDzL,MAAAA,iBAAiB,GAAGlB,iBAAiB,CAAC4M,QAAlB,CAA2B1L,iBAA3B,EAA8CqK,YAA9C,EAA4D;AAC9EsB,QAAAA,IAAI,EAAE,CADwE;AAE9EC,QAAAA,IAAI,EAAE,IAFwE;AAG9EC,QAAAA,QAAQ,EAAEC,IAAI,CAACvJ,GAAL,CAAS8H,YAAT,EAAuB7K,4BAAvB;AAHoE,OAA5D,CAApB;AAOA,YAAMuM,YAAY,GAAG/L,iBAAiB,CAACyG,MAAlB,GAA2B,CAAhD;AACA,YAAMuF,YAAY,GAAG,EAArB;;AACA,WAAK,IAAI7E,CAAC,GAAGqE,SAAb,EAAwBrE,CAAC,GAAG4E,YAA5B,EAA0C5E,CAAC,EAA3C,EAA+C;AAC7C,aAAKD,kBAAL,CAAwBC,CAAxB,EAA2B6E,YAA3B;AACAhM,QAAAA,iBAAiB,CAACmH,CAAC,GAAG,CAAJ,GAAQ,CAAT,CAAjB,GAA+B6E,YAAY,CAAC,CAAD,CAA3C;AACAhM,QAAAA,iBAAiB,CAACmH,CAAC,GAAG,CAAJ,GAAQ,CAAT,CAAjB,GAA+B6E,YAAY,CAAC,CAAD,CAA3C;AACAhM,QAAAA,iBAAiB,CAACmH,CAAC,GAAG,CAAJ,GAAQ,CAAT,CAAjB,GAA+B6E,YAAY,CAAC,CAAD,CAA3C;AACD;AACF;;AAEDT,IAAAA,SAAS,CAAClL,KAAV,GAAkBL,iBAAiB,CAACiM,QAAlB,CAA2B,CAA3B,EAA8B5B,YAAY,GAAG,CAA7C,CAAlB;AACD;;AAEDF,EAAAA,mBAAmB,CAACrE,KAAD,EAAQoE,iBAAR,EAA2B;AAC5C,UAAMlE,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;AACA,UAAMmG,iBAAiB,GAAGpG,KAAK,CAACqG,QAAN,CAAeD,iBAAf,IAAoC,EAA9D;AACA,UAAME,gBAAgB,GAAGpG,gBAAgB,CAACqG,mBAAjB,CACvBnC,iBADuB,EAEvBgC,iBAFuB,CAAzB;AAKApG,IAAAA,KAAK,CAACwG,aAAN,CAAoBF,gBAApB;AACD;;AAIDG,EAAAA,mBAAmB,CAACC,WAAD,EAAc;AAC/B,SAAKC,oBAAL,CAA0BD,WAA1B;AACD;;AAEDC,EAAAA,oBAAoB,CAACD,WAAD,EAAc;AAChC,UAAM;AAAC3D,MAAAA,aAAD;AAAgBC,MAAAA;AAAhB,QAAyC,KAAK/C,mBAAL,GAA2BgD,UAA1E;AACA,UAAM2D,MAAM,GAAG7D,aAAa,IAAIC,qBAAhC;AAEA,UAAM6D,KAAK,GAAGD,MAAM,CAACE,eAAP,CAAuBJ,WAAvB,CAAd;AACA,UAAMK,GAAG,GAAGH,MAAM,CAACE,eAAP,CAAuBJ,WAAW,GAAG,CAArC,CAAZ;AAGAE,IAAAA,MAAM,CAACI,MAAP,CAAcC,OAAd,CAAsB;AACpB5M,MAAAA,IAAI,EAAE,IAAIoH,UAAJ,CAAesF,GAAG,GAAGF,KAArB,CADc;AAEpBK,MAAAA,MAAM,EAAEL;AAFY,KAAtB;AAID;;AAEDM,EAAAA,oBAAoB,GAAG;AACrB,UAAM;AAACpE,MAAAA,aAAD;AAAgBC,MAAAA;AAAhB,QAAyC,KAAK/C,mBAAL,GAA2BgD,UAA1E;AACA,UAAM2D,MAAM,GAAG7D,aAAa,IAAIC,qBAAhC;AACA4D,IAAAA,MAAM,CAACQ,eAAP,CAAuB;AAACC,MAAAA,WAAW,EAAE;AAAd,KAAvB;AACD;;AAOD7C,EAAAA,eAAe,CAACpG,KAAD,EAAQ;AACrBA,IAAAA,KAAK,GAAGA,KAAK,IAAI,KAAKA,KAAtB;;AAGA,QAAIA,KAAK,CAACmG,YAAN,KAAuB+C,SAA3B,EAAsC;AACpC,aAAOlJ,KAAK,CAACmG,YAAb;AACD;;AAGD,QAAI,KAAK7F,KAAL,IAAc,KAAKA,KAAL,CAAW6F,YAAX,KAA4B+C,SAA9C,EAAyD;AACvD,aAAO,KAAK5I,KAAL,CAAW6F,YAAlB;AACD;;AAGD,WAAOjM,KAAK,CAAC8F,KAAK,CAAC/D,IAAP,CAAZ;AACD;;AAMDqK,EAAAA,eAAe,CAACtG,KAAD,EAAQ;AACrBA,IAAAA,KAAK,GAAGA,KAAK,IAAI,KAAKA,KAAtB;;AAGA,QAAIA,KAAK,CAACqG,YAAN,KAAuB6C,SAA3B,EAAsC;AACpC,aAAOlJ,KAAK,CAACqG,YAAb;AACD;;AAGD,QAAI,KAAK/F,KAAL,IAAc,KAAKA,KAAL,CAAW+F,YAA7B,EAA2C;AACzC,aAAO,KAAK/F,KAAL,CAAW+F,YAAlB;AACD;;AAED,WAAO,IAAP;AACD;;AAOD8C,EAAAA,WAAW,GAAG;AACZ/O,IAAAA,KAAK,CAACc,gBAAD,EAAmB,IAAnB,CAAL;;AAEA,SAAKkO,UAAL;;AAGA,SAAK1F,eAAL,CAAqB,KAAKzG,OAA1B;;AAEA,SAAK,MAAM6G,SAAX,IAAwB,KAAK9D,KAAL,CAAWZ,UAAnC,EAA+C;AAC7C0E,MAAAA,SAAS,CAACJ,eAAV,CAA0BK,IAA1B,CAA+B,IAA/B,EAAqC,KAAK9G,OAA1C,EAAmD6G,SAAnD;AACD;;AAID,SAAK3D,cAAL,CAAoB;AAClBiE,MAAAA,WAAW,EAAE,IADK;AAElBiF,MAAAA,YAAY,EAAE,IAFI;AAGlB1D,MAAAA,eAAe,EAAE,IAHC;AAIlB2D,MAAAA,iBAAiB,EAAE;AAJD,KAApB;;AAOA,SAAKC,YAAL;AACD;;AAID3D,EAAAA,OAAO,GAAG;AAER,UAAM4D,gBAAgB,GAAG,KAAK3I,WAAL,EAAzB;AAEAzG,IAAAA,KAAK,CAACe,YAAD,EAAe,IAAf,EAAqBqO,gBAArB,CAAL;;AAEA,QAAIA,gBAAJ,EAAsB;AACpB,WAAKD,YAAL;AACD;AACF;;AAGDA,EAAAA,YAAY,GAAG;AACb,UAAME,YAAY,GAAG,KAAKzJ,KAA1B;AACA,UAAM0J,eAAe,GAAG,KAAKzM,OAAL,CAAarB,QAArC;;AACA,UAAMoL,iBAAiB,GAAG,KAAKD,wBAAL,EAA1B;;AACA,SAAKpJ,aAAL,CAAmBqJ,iBAAnB,GAAuCA,iBAAvC;AAIA,SAAK/J,OAAL,CAAarB,QAAb,GAAwB,KAAK+B,aAAL,CAAmB/B,QAAnB,IAA+B8N,eAAvD;AAEA,SAAK1J,KAAL,GAAagH,iBAAb;;AAEA,UAAM2C,YAAY,GAAG,KAAKvI,gBAAL,EAArB;;AACA,UAAMwI,SAAS,GAAG,KAAKlI,SAAL,EAAlB;;AAGA,QAAI,KAAKzE,OAAL,CAAa4M,EAAjB,EAAqB;AACnB,WAAK1F,WAAL,CAAiBwF,YAAjB;AACD,KAFD,MAEO;AACL,UAAI;AACF,aAAKxF,WAAL,CAAiBwF,YAAjB;AACD,OAFD,CAEE,OAAOG,KAAP,EAAc,CAEf;AACF;;AAED,SAAK,MAAMhG,SAAX,IAAwB,KAAK9D,KAAL,CAAWZ,UAAnC,EAA+C;AAC7C0E,MAAAA,SAAS,CAACK,WAAV,CAAsBJ,IAAtB,CAA2B,IAA3B,EAAiC4F,YAAjC,EAA+C7F,SAA/C;AACD;;AAED,UAAMiG,YAAY,GAAG,KAAKrI,SAAL,GAAiB,CAAjB,MAAwBkI,SAAS,CAAC,CAAD,CAAtD;;AACA,SAAKI,cAAL,CAAoBL,YAApB,EAAkCI,YAAlC;;AAGA,QAAI,KAAKE,WAAT,EAAsB;AAEpB,WAAKC,aAAL,CAAmBP,YAAnB;AACD,KAHD,MAGO;AACL,WAAKpJ,cAAL;;AAEA,WAAK2F,iBAAL,CAAuB,KAAKlG,KAA5B;;AAGA,UAAI,KAAKM,KAAL,CAAWsB,KAAf,EAAsB;AACpB,aAAKtB,KAAL,CAAWsB,KAAX,CAAiBuI,gBAAjB,CAAkC,KAAK/D,eAAL,EAAlC;AACD;AACF;;AAGD,SAAKnJ,OAAL,CAAarB,QAAb,GAAwB8N,eAAxB;AACA,SAAK1J,KAAL,GAAayJ,YAAb;AACA,SAAKW,gBAAL;AACA,SAAKzM,aAAL,CAAmBkD,WAAnB,GAAiC,KAAjC;AACA,SAAKlD,aAAL,CAAmB0M,aAAnB;AACD;;AAKDC,EAAAA,SAAS,GAAG;AACVlQ,IAAAA,KAAK,CAACgB,cAAD,EAAiB,IAAjB,CAAL;AACAb,IAAAA,MAAM,CAAC,KAAKoD,aAAL,IAAsB,KAAK2C,KAA5B,CAAN;AAGA,SAAK2E,aAAL,CAAmB,KAAKhI,OAAxB;;AAEA,SAAK,MAAM6G,SAAX,IAAwB,KAAK9D,KAAL,CAAWZ,UAAnC,EAA+C;AAC7C0E,MAAAA,SAAS,CAACmB,aAAV,CAAwBlB,IAAxB,CAA6B,IAA7B,EAAmCD,SAAnC;AACD;AACF;;AAGDyG,EAAAA,SAAS,CAAC;AAACC,IAAAA,gBAAgB,GAAG,IAApB;AAA0BrL,IAAAA,QAAQ,GAAG,EAArC;AAAyCD,IAAAA,UAAU,GAAG;AAAtD,GAAD,EAA4D;AACnE,SAAK2H,0BAAL;;AAEA,UAAM4C,YAAY,GAAG,KAAKzJ,KAA1B;AAGA,SAAKA,KAAL,GAAa,KAAKrC,aAAL,CAAmBqJ,iBAAnB,IAAwCyC,YAArD;AAEA,UAAM;AAACtL,MAAAA;AAAD,QAAY,KAAK6B,KAAvB;AAEAb,IAAAA,QAAQ,CAAChB,OAAT,GAAmByJ,IAAI,CAAC6C,GAAL,CAAStM,OAAT,EAAkB,IAAI,GAAtB,CAAnB;;AAGA,QAAIqM,gBAAJ,EAAsB;AACpB,WAAKE,mBAAL,CAAyBF,gBAAzB;AACD;;AAID,UAAM;AAACnL,MAAAA;AAAD,QAAqB,KAAKW,KAAhC;AACA,UAAM2K,OAAO,GAAItL,gBAAgB,IAAIA,gBAAgB,CAACF,QAAD,CAArC,IAAoD,CAAC,CAAD,EAAI,CAAJ,CAApE;AAEA7E,IAAAA,aAAa,CAAC,KAAK2C,OAAL,CAAa4M,EAAd,EAAkB;AAACe,MAAAA,aAAa,EAAED;AAAhB,KAAlB,CAAb;AAGAtQ,IAAAA,cAAc,CAAC,KAAK4C,OAAL,CAAa4M,EAAd,EAAkB3K,UAAlB,EAA8B,MAAM;AAChD,YAAM6B,IAAI,GAAG;AAACyJ,QAAAA,gBAAD;AAAmBrL,QAAAA,QAAnB;AAA6BD,QAAAA,UAA7B;AAAyCjC,QAAAA,OAAO,EAAE,KAAKA;AAAvD,OAAb;;AAGA,WAAK,MAAM6G,SAAX,IAAwB,KAAK9D,KAAL,CAAWZ,UAAnC,EAA+C;AAC7C0E,QAAAA,SAAS,CAACwB,IAAV,CAAevB,IAAf,CAAoB,IAApB,EAA0BhD,IAA1B,EAAgC+C,SAAhC;AACD;;AAED,WAAKwB,IAAL,CAAUvE,IAAV;AACD,KATa,CAAd;AAaA,SAAKf,KAAL,GAAayJ,YAAb;AACD;;AAGDoB,EAAAA,cAAc,GAAG;AACf,WAAO,KAAKlN,aAAL,CAAmBsG,WAA1B;AACD;;AAID9D,EAAAA,cAAc,CAAC2K,KAAD,EAAQ;AACpB,UAAM;AAAC7G,MAAAA;AAAD,QAAgB,KAAKtG,aAA3B;;AAGA,SAAK,MAAMuJ,GAAX,IAAkB4D,KAAlB,EAAyB;AACvB,UAAIA,KAAK,CAAC5D,GAAD,CAAT,EAAgB;AACd,YAAI6D,WAAW,GAAG,KAAlB;;AACA,gBAAQ7D,GAAR;AACE,eAAK,aAAL;AAEE,gBAAI7C,KAAK,CAACC,OAAN,CAAcL,WAAW,CAACiD,GAAD,CAAzB,CAAJ,EAAqC;AACnCjD,cAAAA,WAAW,CAACiD,GAAD,CAAX,GAAmB7C,KAAK,CAACC,OAAN,CAAcwG,KAAK,CAAC5D,GAAD,CAAnB,IACfjD,WAAW,CAACiD,GAAD,CAAX,CAAiB8D,MAAjB,CAAwBF,KAAK,CAAC5D,GAAD,CAA7B,CADe,GAEf4D,KAAK,CAAC5D,GAAD,CAFT;AAGA6D,cAAAA,WAAW,GAAG,IAAd;AACD;;AAEH;AACE,gBAAI,CAAC9G,WAAW,CAACiD,GAAD,CAAhB,EAAuB;AACrBjD,cAAAA,WAAW,CAACiD,GAAD,CAAX,GAAmB4D,KAAK,CAAC5D,GAAD,CAAxB;AACA6D,cAAAA,WAAW,GAAG,IAAd;AACD;;AAdL;;AAgBA,YAAIA,WAAJ,EAAiB;AACf3Q,UAAAA,KAAK,CAACa,iBAAD,EAAoB,IAApB,EAA0BiM,GAA1B,EAA+B4D,KAA/B,CAAL;AACD;AACF;AACF;;AAID,UAAM5G,kBAAkB,GACtBD,WAAW,CAACG,WAAZ,IACAH,WAAW,CAACgH,qBADZ,IAEAhH,WAAW,CAACoF,YAFZ,IAGApF,WAAW,CAACqF,iBAJd;AAKArF,IAAAA,WAAW,CAACC,kBAAZ,GAAiCA,kBAAjC;AACAD,IAAAA,WAAW,CAACiH,gBAAZ,GACEhH,kBAAkB,IAAI4G,KAAK,CAACnF,eAA5B,IAA+CmF,KAAK,CAAC1K,YADvD;AAED;;AAIDgK,EAAAA,gBAAgB,GAAG;AACjB,SAAKzM,aAAL,CAAmBsG,WAAnB,GAAiC;AAE/BG,MAAAA,WAAW,EAAE,KAFkB;AAG/BiF,MAAAA,YAAY,EAAE,KAHiB;AAI/B4B,MAAAA,qBAAqB,EAAE,KAJQ;AAK/BtF,MAAAA,eAAe,EAAE,KALc;AAM/BvF,MAAAA,YAAY,EAAE,KANiB;AAO/BkJ,MAAAA,iBAAiB,EAAE,KAPY;AAU/BpF,MAAAA,kBAAkB,EAAE,KAVW;AAW/BgH,MAAAA,gBAAgB,EAAE;AAXa,KAAjC;AAaD;;AAKDlR,EAAAA,SAAS,CAACmR,QAAD,EAAWnH,QAAX,EAAqB;AAC5B,UAAMC,WAAW,GAAGjK,SAAS,CAACmR,QAAD,EAAWnH,QAAX,CAA7B;;AAGA,QAAIC,WAAW,CAACgH,qBAAhB,EAAuC;AACrC,WAAK,MAAM/D,GAAX,IAAkBjD,WAAW,CAACgH,qBAA9B,EAAqD;AACnD,YAAIhH,WAAW,CAACgH,qBAAZ,CAAkC/D,GAAlC,CAAJ,EAA4C;AAC1C,eAAKrB,mBAAL,CAAyBqB,GAAzB;AACD;AACF;AACF;;AAGD,QAAIjD,WAAW,CAACmH,kBAAhB,EAAoC;AAClC,WAAK,MAAMlE,GAAX,IAAkBjD,WAAW,CAACmH,kBAA9B,EAAkD;AAEhD,aAAKzN,aAAL,CAAmB0D,kBAAnB,CAAsC/D,GAAtC,CACE4J,GADF,EAEElD,QAAQ,CAACkD,GAAD,CAFV,EAGEiE,QAAQ,CAACjE,GAAD,CAHV,EAIEiE,QAAQ,CAAC3E,WAAT,CAAqBU,GAArB,CAJF;AAMD;AACF;;AAED,WAAO,KAAK/G,cAAL,CAAoB8D,WAApB,CAAP;AACD;;AAGDhK,EAAAA,aAAa,GAAG;AACdA,IAAAA,aAAa,CAAC,KAAK+F,KAAN,CAAb;AACD;;AAED0K,EAAAA,mBAAmB,CAACF,gBAAD,EAAmB;AACpC,SAAK,MAAM5I,KAAX,IAAoB,KAAKF,SAAL,EAApB,EAAsC;AACpCE,MAAAA,KAAK,CAACyJ,oBAAN,CAA2Bb,gBAA3B;AACD;AACF;;AAGDR,EAAAA,cAAc,CAAC;AAAChK,IAAAA,KAAD;AAAQgE,IAAAA;AAAR,GAAD,EAAoBsH,WAApB,EAAiC;AAE7C,UAAM;AAAC9L,MAAAA,aAAD;AAAgBD,MAAAA,sBAAhB;AAAwCE,MAAAA;AAAxC,QAA0DO,KAAhE;;AACA,QACEsL,WAAW,IACXtH,QAAQ,CAACxE,aAAT,KAA2BA,aAD3B,IAEAwE,QAAQ,CAACzE,sBAAT,KAAoCA,sBAFpC,IAGAyE,QAAQ,CAACvE,cAAT,KAA4BA,cAJ9B,EAKE;AACA,YAAMP,UAAU,GAAG,EAAnB;;AACA,UAAI,CAACM,aAAL,EAAoB;AAClBN,QAAAA,UAAU,CAACqM,oBAAX,GAAkC,IAAlC;AACD;;AACD,UAAIlH,KAAK,CAACC,OAAN,CAAc7E,cAAd,CAAJ,EAAmC;AACjCP,QAAAA,UAAU,CAACsM,qBAAX,GAAmC/L,cAAnC;AACD;;AAGD,UAAIgM,MAAM,CAACC,SAAP,CAAiBnM,sBAAjB,CAAJ,EAA8C;AAC5CL,QAAAA,UAAU,CAACqM,oBAAX,GACEhM,sBAAsB,IAAI,CAA1B,GAA8B,KAAKyD,kBAAL,CAAwBzD,sBAAxB,CAA9B,GAAgF,IADlF;AAED;;AAED,WAAKmL,mBAAL,CAAyBxL,UAAzB;AACD;AACF;;AAEDkC,EAAAA,gBAAgB,GAAG;AACjB,WAAO;AACLpB,MAAAA,KAAK,EAAE,KAAKA,KADP;AAELgE,MAAAA,QAAQ,EAAE,KAAKrG,aAAL,CAAmBgO,WAAnB,EAFL;AAGL1O,MAAAA,OAAO,EAAE,KAAKA,OAHT;AAILgH,MAAAA,WAAW,EAAE,KAAKtG,aAAL,CAAmBsG;AAJ3B,KAAP;AAMD;;AAGDhD,EAAAA,eAAe,CAACF,IAAD,EAAO;AAGpB,QAAI,CAAC,KAAKpD,aAAV,EAAyB;AACvB,aAAO,KAAP;AACD;;AAED,QAAI6C,MAAM,GAAG,KAAb;AACAA,IAAAA,MAAM,GAAGA,MAAM,IAAK,KAAK7C,aAAL,CAAmB8C,WAAnB,IAAkC,KAAK3C,EAA3D;AACA,SAAKH,aAAL,CAAmB8C,WAAnB,GAAiC,KAAK9C,aAAL,CAAmB8C,WAAnB,IAAkC,CAACM,IAAI,CAACC,gBAAzE;AAGA,UAAMc,gBAAgB,GAAG,KAAKD,mBAAL,EAAzB;AACA,UAAM+J,2BAA2B,GAAG9J,gBAAgB,IAAIA,gBAAgB,CAAChB,cAAjB,CAAgCC,IAAhC,CAAxD;AACAP,IAAAA,MAAM,GAAGA,MAAM,IAAIoL,2BAAnB;AAEA,WAAOpL,MAAP;AACD;;AAGDqL,EAAAA,oBAAoB,GAAG;AACrB,WAAO,IAAI/R,gBAAJ,CAAqB,KAAKmD,OAAL,CAAa4M,EAAlC,EAAsC;AAC3C/L,MAAAA,EAAE,EAAE,KAAKkC,KAAL,CAAWlC,EAD4B;AAE3CgO,MAAAA,KAAK,EAAE,KAAK7O,OAAL,CAAa6O,KAFuB;AAG3CC,MAAAA,QAAQ,EAAE,KAAK9O,OAAL,CAAa8O;AAHoB,KAAtC,CAAP;AAKD;;AAED3C,EAAAA,UAAU,GAAG;AACX7O,IAAAA,MAAM,CAAC,CAAC,KAAKoD,aAAN,IAAuB,CAAC,KAAK2C,KAA9B,CAAN;AACA/F,IAAAA,MAAM,CAACyR,QAAQ,CAAC,KAAKhM,KAAL,CAAWrB,gBAAZ,CAAT,YAA2C,KAAKb,EAAhD,gCAAN;;AAEA,UAAMgE,gBAAgB,GAAG,KAAK+J,oBAAL,EAAzB;;AAEA,QAAI/J,gBAAJ,EAAsB;AAIpBA,MAAAA,gBAAgB,CAACmK,YAAjB,CAA8B;AAC5BrH,QAAAA,qBAAqB,EAAE;AACrB1I,UAAAA,IAAI,MADiB;AAErBuL,UAAAA,IAAI,EAAE,CAFe;AAGrByE,UAAAA,OAAO,EAAE,IAHY;AAIrB3F,UAAAA,MAAM,EAAE,KAAKa;AAJQ;AADK,OAA9B;AAQD;;AAED,SAAKzJ,aAAL,GAAqB,IAAI7C,UAAJ,CAAe;AAClCgH,MAAAA,gBADkC;AAElC/E,MAAAA,KAAK,EAAE;AAF2B,KAAf,CAArB;AAIA,SAAKqN,gBAAL;AAEA,SAAK9J,KAAL,GAAa,EAAb;AAIA9E,IAAAA,MAAM,CAAC2L,cAAP,CAAsB,KAAK7G,KAA3B,EAAkC,kBAAlC,EAAsD;AACpD6L,MAAAA,GAAG,EAAE,MAAM;AACThS,QAAAA,GAAG,CAACiS,UAAJ,CAAe,8BAAf,EAA+C,6BAA/C;AACA,eAAOtK,gBAAP;AACD;AAJmD,KAAtD;AAQA,SAAKnE,aAAL,CAAmBZ,KAAnB,GAA2B,IAA3B;AACA,SAAKY,aAAL,CAAmB0D,kBAAnB,GAAwC,IAAItH,wBAAJ,CAA6B,KAAKkD,OAAL,CAAa8O,QAA1C,CAAxC;AACA,SAAKpO,aAAL,CAAmB0O,kBAAnB,GAAwC,KAAKC,mBAAL,CAAyBC,IAAzB,CAA8B,IAA9B,CAAxC;AAGA,SAAK5O,aAAL,CAAmB6O,aAAnB,CAAiC,KAAKxM,KAAtC;AACD;;AAGDyM,EAAAA,cAAc,CAACC,QAAD,EAAW;AACvBtS,IAAAA,KAAK,CAACiB,aAAD,EAAgB,IAAhB,EAAsB,SAASqR,QAA/B,CAAL;AAEA,UAAM;AAACpM,MAAAA,KAAD;AAAQ3C,MAAAA;AAAR,QAAyB+O,QAA/B;AACAnS,IAAAA,MAAM,CAAC+F,KAAK,IAAI3C,aAAV,CAAN;;AAEA,QAAI,SAAS+O,QAAb,EAAuB;AACrB;AACD;;AAGD,SAAK/O,aAAL,GAAqBA,aAArB;AACA,SAAKA,aAAL,CAAmBZ,KAAnB,GAA2B,IAA3B;AAGA,SAAKuD,KAAL,GAAaA,KAAb;AAKA,SAAK3C,aAAL,CAAmB6O,aAAnB,CAAiC,KAAKxM,KAAtC;AAEA,SAAKhG,SAAL,CAAe,KAAKgG,KAApB,EAA2B,KAAKrC,aAAL,CAAmBgO,WAAnB,EAA3B;AACD;;AAEDW,EAAAA,mBAAmB,GAAG;AACpB,SAAKtS,SAAL,CAAe,KAAKgG,KAApB,EAA2B,KAAKrC,aAAL,CAAmBgO,WAAnB,EAA3B;AACA,SAAKjL,cAAL;AACD;;AA51B0C;AA+1B7ChB,KAAK,CAACI,SAAN,GAAkB,OAAlB;AACAJ,KAAK,CAAC1D,YAAN,GAAqBA,YAArB","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable react/no-direct-mutation-state */\nimport {COORDINATE_SYSTEM} from './constants';\nimport AttributeManager from './attribute/attribute-manager';\nimport UniformTransitionManager from './uniform-transition-manager';\nimport {diffProps, validateProps} from '../lifecycle/props';\nimport {count} from '../utils/count';\nimport log from '../utils/log';\nimport debug from '../debug';\nimport GL from '@luma.gl/constants';\nimport {withParameters, setParameters} from '@luma.gl/core';\nimport assert from '../utils/assert';\nimport memoize from '../utils/memoize';\nimport {mergeShaders} from '../utils/shader';\nimport {projectPosition, getWorldPosition} from '../shaderlib/project/project-functions';\nimport typedArrayManager from '../utils/typed-array-manager';\n\nimport Component from '../lifecycle/component';\nimport LayerState from './layer-state';\n\nimport {worldToPixels} from '@math.gl/web-mercator';\n\nimport {load} from '@loaders.gl/core';\n\nconst TRACE_CHANGE_FLAG = 'layer.changeFlag';\nconst TRACE_INITIALIZE = 'layer.initialize';\nconst TRACE_UPDATE = 'layer.update';\nconst TRACE_FINALIZE = 'layer.finalize';\nconst TRACE_MATCHED = 'layer.matched';\n\nconst MAX_PICKING_COLOR_CACHE_SIZE = 2 ** 24 - 1;\n\nconst EMPTY_ARRAY = Object.freeze([]);\n\n// Only compare the same two viewports once\nconst areViewportsEqual = memoize(({oldViewport, viewport}) => {\n  return oldViewport.equals(viewport);\n});\n\nlet pickingColorCache = new Uint8ClampedArray(0);\n\nconst defaultProps = {\n  // data: Special handling for null, see below\n  data: {type: 'data', value: EMPTY_ARRAY, async: true},\n  dataComparator: null,\n  _dataDiff: {type: 'function', value: data => data && data.__diff, compare: false, optional: true},\n  dataTransform: {type: 'function', value: null, compare: false, optional: true},\n  onDataLoad: {type: 'function', value: null, compare: false, optional: true},\n  fetch: {\n    type: 'function',\n    value: (url, {propName, layer}) => {\n      const {resourceManager} = layer.context;\n      const loadOptions = layer.getLoadOptions();\n      let inResourceManager = resourceManager.contains(url);\n\n      if (!inResourceManager && !loadOptions) {\n        // If there is no layer-specific load options, then attempt to cache this resource in the data manager\n        resourceManager.add({resourceId: url, data: url, persistent: false});\n        inResourceManager = true;\n      }\n      if (inResourceManager) {\n        return resourceManager.subscribe({\n          resourceId: url,\n          onChange: data => layer.internalState.reloadAsyncProp(propName, data),\n          consumerId: layer.id,\n          requestId: propName\n        });\n      }\n\n      return load(url, loadOptions);\n    },\n    compare: false\n  },\n  updateTriggers: {}, // Update triggers: a core change detection mechanism in deck.gl\n\n  visible: true,\n  pickable: false,\n  opacity: {type: 'number', min: 0, max: 1, value: 1},\n\n  onHover: {type: 'function', value: null, compare: false, optional: true},\n  onClick: {type: 'function', value: null, compare: false, optional: true},\n  onDragStart: {type: 'function', value: null, compare: false, optional: true},\n  onDrag: {type: 'function', value: null, compare: false, optional: true},\n  onDragEnd: {type: 'function', value: null, compare: false, optional: true},\n\n  coordinateSystem: COORDINATE_SYSTEM.DEFAULT,\n  coordinateOrigin: {type: 'array', value: [0, 0, 0], compare: true},\n  modelMatrix: {type: 'array', value: null, compare: true, optional: true},\n  wrapLongitude: false,\n  positionFormat: 'XYZ',\n  colorFormat: 'RGBA',\n\n  parameters: {},\n  uniforms: {},\n  extensions: [],\n\n  // Offset depth based on layer index to avoid z-fighting.\n  // Negative values pull layer towards the camera\n  // https://www.opengl.org/archives/resources/faq/technical/polygonoffset.htm\n  getPolygonOffset: {\n    type: 'function',\n    value: ({layerIndex}) => [0, -layerIndex * 100],\n    compare: false\n  },\n\n  // Selection/Highlighting\n  highlightedObjectIndex: -1,\n  autoHighlight: false,\n  highlightColor: {type: 'accessor', value: [0, 0, 128, 128]}\n};\n\nexport default class Layer extends Component {\n  toString() {\n    const className = this.constructor.layerName || this.constructor.name;\n    return `${className}({id: '${this.props.id}'})`;\n  }\n\n  // Public API\n\n  // Updates selected state members and marks the object for redraw\n  setState(updateObject) {\n    this.setChangeFlags({stateChanged: true});\n    Object.assign(this.state, updateObject);\n    this.setNeedsRedraw();\n  }\n\n  // Sets the redraw flag for this layer, will trigger a redraw next animation frame\n  setNeedsRedraw(redraw = true) {\n    if (this.internalState) {\n      this.internalState.needsRedraw = redraw;\n    }\n  }\n\n  // This layer needs a deep update\n  setNeedsUpdate() {\n    this.context.layerManager.setNeedsUpdate(String(this));\n    this.internalState.needsUpdate = true;\n  }\n\n  // Checks state of attributes and model\n  getNeedsRedraw(opts = {clearRedrawFlags: false}) {\n    return this._getNeedsRedraw(opts);\n  }\n\n  // Checks if layer attributes needs updating\n  needsUpdate() {\n    // Call subclass lifecycle method\n    return (\n      this.internalState.needsUpdate ||\n      this.hasUniformTransition() ||\n      this.shouldUpdateState(this._getUpdateParams())\n    );\n    // End lifecycle method\n  }\n\n  hasUniformTransition() {\n    return this.internalState.uniformTransitions.active;\n  }\n\n  get isLoaded() {\n    return this.internalState && !this.internalState.isAsyncPropLoading();\n  }\n\n  get wrapLongitude() {\n    return this.props.wrapLongitude;\n  }\n\n  // Returns true if the layer is pickable and visible.\n  isPickable() {\n    return this.props.pickable && this.props.visible;\n  }\n\n  // Return an array of models used by this layer, can be overriden by layer subclass\n  getModels() {\n    return this.state && (this.state.models || (this.state.model ? [this.state.model] : []));\n  }\n\n  getAttributeManager() {\n    return this.internalState && this.internalState.attributeManager;\n  }\n\n  // Returns the most recent layer that matched to this state\n  // (When reacting to an async event, this layer may no longer be the latest)\n  getCurrentLayer() {\n    return this.internalState && this.internalState.layer;\n  }\n\n  // Returns the default parse options for async props\n  getLoadOptions() {\n    return this.props.loadOptions;\n  }\n\n  // PROJECTION METHODS\n\n  // Projects a point with current map state (lat, lon, zoom, pitch, bearing)\n  // From the current layer's coordinate system to screen\n  project(xyz) {\n    const {viewport} = this.context;\n    const worldPosition = getWorldPosition(xyz, {\n      viewport,\n      modelMatrix: this.props.modelMatrix,\n      coordinateOrigin: this.props.coordinateOrigin,\n      coordinateSystem: this.props.coordinateSystem\n    });\n    const [x, y, z] = worldToPixels(worldPosition, viewport.pixelProjectionMatrix);\n    return xyz.length === 2 ? [x, y] : [x, y, z];\n  }\n\n  // Note: this does not reverse `project`.\n  // Always unprojects to the viewport's coordinate system\n  unproject(xy) {\n    const {viewport} = this.context;\n    return viewport.unproject(xy);\n  }\n\n  projectPosition(xyz) {\n    return projectPosition(xyz, {\n      viewport: this.context.viewport,\n      modelMatrix: this.props.modelMatrix,\n      coordinateOrigin: this.props.coordinateOrigin,\n      coordinateSystem: this.props.coordinateSystem\n    });\n  }\n\n  use64bitPositions() {\n    const {coordinateSystem} = this.props;\n    return (\n      coordinateSystem === COORDINATE_SYSTEM.DEFAULT ||\n      coordinateSystem === COORDINATE_SYSTEM.LNGLAT ||\n      coordinateSystem === COORDINATE_SYSTEM.CARTESIAN\n    );\n  }\n\n  // Event handling\n  onHover(info, pickingEvent) {\n    if (this.props.onHover) {\n      return this.props.onHover(info, pickingEvent);\n    }\n    return false;\n  }\n\n  onClick(info, pickingEvent) {\n    if (this.props.onClick) {\n      return this.props.onClick(info, pickingEvent);\n    }\n    return false;\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  // @return {Array} - a black color\n  nullPickingColor() {\n    return [0, 0, 0];\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  encodePickingColor(i, target = []) {\n    target[0] = (i + 1) & 255;\n    target[1] = ((i + 1) >> 8) & 255;\n    target[2] = (((i + 1) >> 8) >> 8) & 255;\n    return target;\n  }\n\n  // Returns the index corresponding to a picking color that doesn't match any subfeature\n  // @param {Uint8Array} color - color array to be decoded\n  // @return {Array} - the decoded picking color\n  decodePickingColor(color) {\n    assert(color instanceof Uint8Array);\n    const [i1, i2, i3] = color;\n    // 1 was added to seperate from no selection\n    const index = i1 + i2 * 256 + i3 * 65536 - 1;\n    return index;\n  }\n\n  // //////////////////////////////////////////////////\n  // LIFECYCLE METHODS, overridden by the layer subclasses\n\n  // Called once to set up the initial state\n  // App can create WebGL resources\n  initializeState() {\n    throw new Error(`Layer ${this} has not defined initializeState`);\n  }\n\n  getShaders(shaders) {\n    for (const extension of this.props.extensions) {\n      shaders = mergeShaders(shaders, extension.getShaders.call(this, extension));\n    }\n    return shaders;\n  }\n\n  // Let's layer control if updateState should be called\n  shouldUpdateState({oldProps, props, context, changeFlags}) {\n    return changeFlags.propsOrDataChanged;\n  }\n\n  // Default implementation, all attributes will be invalidated and updated\n  // when data changes\n  /* eslint-disable-next-line complexity */\n  updateState({oldProps, props, context, changeFlags}) {\n    const attributeManager = this.getAttributeManager();\n    if (changeFlags.dataChanged && attributeManager) {\n      const {dataChanged} = changeFlags;\n      if (Array.isArray(dataChanged)) {\n        // is partial update\n        for (const dataRange of dataChanged) {\n          attributeManager.invalidateAll(dataRange);\n        }\n      } else {\n        attributeManager.invalidateAll();\n      }\n    }\n\n    const neededPickingBuffer = oldProps.highlightedObjectIndex >= 0 || oldProps.pickable;\n    const needPickingBuffer = props.highlightedObjectIndex >= 0 || props.pickable;\n    if (neededPickingBuffer !== needPickingBuffer && attributeManager) {\n      const {pickingColors, instancePickingColors} = attributeManager.attributes;\n      const pickingColorsAttribute = pickingColors || instancePickingColors;\n      if (pickingColorsAttribute) {\n        if (needPickingBuffer && pickingColorsAttribute.constant) {\n          pickingColorsAttribute.constant = false;\n          attributeManager.invalidate(pickingColorsAttribute.id);\n        }\n        if (!pickingColorsAttribute.value && !needPickingBuffer) {\n          pickingColorsAttribute.constant = true;\n          pickingColorsAttribute.value = [0, 0, 0];\n        }\n      }\n    }\n  }\n\n  // Called once when layer is no longer matched and state will be discarded\n  // App can destroy WebGL resources here\n  finalizeState() {\n    for (const model of this.getModels()) {\n      model.delete();\n    }\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.finalize();\n    }\n    this.context.resourceManager.unsubscribe({consumerId: this.id});\n    this.internalState.uniformTransitions.clear();\n  }\n\n  // If state has a model, draw it with supplied uniforms\n  draw(opts) {\n    for (const model of this.getModels()) {\n      model.draw(opts);\n    }\n  }\n\n  // called to populate the info object that is passed to the event handler\n  // @return null to cancel event\n  getPickingInfo({info, mode}) {\n    const {index} = info;\n\n    if (index >= 0) {\n      // If props.data is an indexable array, get the object\n      if (Array.isArray(this.props.data)) {\n        info.object = this.props.data[index];\n      }\n    }\n\n    return info;\n  }\n\n  // END LIFECYCLE METHODS\n  // //////////////////////////////////////////////////\n\n  // INTERNAL METHODS\n  activateViewport(viewport) {\n    const oldViewport = this.internalState.viewport;\n    this.internalState.viewport = viewport;\n\n    if (!oldViewport || !areViewportsEqual({oldViewport, viewport})) {\n      this.setChangeFlags({viewportChanged: true});\n      this._update();\n    }\n  }\n\n  // Default implementation of attribute invalidation, can be redefined\n  invalidateAttribute(name = 'all', diffReason = '') {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    if (name === 'all') {\n      attributeManager.invalidateAll();\n    } else {\n      attributeManager.invalidate(name);\n    }\n  }\n\n  updateAttributes(changedAttributes) {\n    for (const model of this.getModels()) {\n      this._setModelAttributes(model, changedAttributes);\n    }\n  }\n\n  // Calls attribute manager to update any WebGL attributes\n  _updateAttributes(props) {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    // Figure out data length\n    const numInstances = this.getNumInstances(props);\n    const startIndices = this.getStartIndices(props);\n\n    attributeManager.update({\n      data: props.data,\n      numInstances,\n      startIndices,\n      props,\n      transitions: props.transitions,\n      buffers: props.data.attributes,\n      context: this,\n      // Don't worry about non-attribute props\n      ignoreUnknownAttributes: true\n    });\n\n    const changedAttributes = attributeManager.getChangedAttributes({clearChangedFlags: true});\n    this.updateAttributes(changedAttributes);\n  }\n\n  // Update attribute transitions. This is called in drawLayer, no model updates required.\n  _updateAttributeTransition() {\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.updateTransition();\n    }\n  }\n\n  // Update uniform (prop) transitions. This is called in updateState, may result in model updates.\n  _updateUniformTransition() {\n    const {uniformTransitions} = this.internalState;\n    if (uniformTransitions.active) {\n      // clone props\n      const propsInTransition = uniformTransitions.update();\n      const props = Object.create(this.props);\n      for (const key in propsInTransition) {\n        Object.defineProperty(props, key, {value: propsInTransition[key]});\n      }\n      return props;\n    }\n    return this.props;\n  }\n\n  calculateInstancePickingColors(attribute, {numInstances}) {\n    if (attribute.constant) {\n      return;\n    }\n\n    // calculateInstancePickingColors always generates the same sequence.\n    // pickingColorCache saves the largest generated sequence for reuse\n    const cacheSize = pickingColorCache.length / 3;\n\n    if (cacheSize < numInstances) {\n      if (numInstances > MAX_PICKING_COLOR_CACHE_SIZE) {\n        log.warn(\n          'Layer has too many data objects. Picking might not be able to distinguish all objects.'\n        )();\n      }\n\n      pickingColorCache = typedArrayManager.allocate(pickingColorCache, numInstances, {\n        size: 3,\n        copy: true,\n        maxCount: Math.max(numInstances, MAX_PICKING_COLOR_CACHE_SIZE)\n      });\n\n      // If the attribute is larger than the cache, resize the cache and populate the missing chunk\n      const newCacheSize = pickingColorCache.length / 3;\n      const pickingColor = [];\n      for (let i = cacheSize; i < newCacheSize; i++) {\n        this.encodePickingColor(i, pickingColor);\n        pickingColorCache[i * 3 + 0] = pickingColor[0];\n        pickingColorCache[i * 3 + 1] = pickingColor[1];\n        pickingColorCache[i * 3 + 2] = pickingColor[2];\n      }\n    }\n\n    attribute.value = pickingColorCache.subarray(0, numInstances * 3);\n  }\n\n  _setModelAttributes(model, changedAttributes) {\n    const attributeManager = this.getAttributeManager();\n    const excludeAttributes = model.userData.excludeAttributes || {};\n    const shaderAttributes = attributeManager.getShaderAttributes(\n      changedAttributes,\n      excludeAttributes\n    );\n\n    model.setAttributes(shaderAttributes);\n  }\n\n  // Sets the picking color at the specified index to null picking color. Used for multi-depth picking.\n  // This method may be overriden by layer implementations\n  disablePickingIndex(objectIndex) {\n    this._disablePickingIndex(objectIndex);\n  }\n\n  _disablePickingIndex(objectIndex) {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n\n    const start = colors.getVertexOffset(objectIndex);\n    const end = colors.getVertexOffset(objectIndex + 1);\n\n    // Fill the sub buffer with 0s\n    colors.buffer.subData({\n      data: new Uint8Array(end - start),\n      offset: start // 1 byte per element\n    });\n  }\n\n  restorePickingColors() {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n    colors.updateSubBuffer({startOffset: 0});\n  }\n\n  // Deduces numer of instances. Intention is to support:\n  // - Explicit setting of numInstances\n  // - Auto-deduction for ES6 containers that define a size member\n  // - Auto-deduction for Classic Arrays via the built-in length attribute\n  // - Auto-deduction via arrays\n  getNumInstances(props) {\n    props = props || this.props;\n\n    // First Check if app has provided an explicit value\n    if (props.numInstances !== undefined) {\n      return props.numInstances;\n    }\n\n    // Second check if the layer has set its own value\n    if (this.state && this.state.numInstances !== undefined) {\n      return this.state.numInstances;\n    }\n\n    // Use container library to get a count for any ES6 container or object\n    return count(props.data);\n  }\n\n  // Buffer layout describes how many attribute values are packed for each data object\n  // The default (null) is one value each object.\n  // Some data formats (e.g. paths, polygons) have various length. Their buffer layout\n  //  is in the form of [L0, L1, L2, ...]\n  getStartIndices(props) {\n    props = props || this.props;\n\n    // First Check if startIndices is provided as an explicit value\n    if (props.startIndices !== undefined) {\n      return props.startIndices;\n    }\n\n    // Second check if the layer has set its own value\n    if (this.state && this.state.startIndices) {\n      return this.state.startIndices;\n    }\n\n    return null;\n  }\n\n  // LAYER MANAGER API\n  // Should only be called by the deck.gl LayerManager class\n\n  // Called by layer manager when a new layer is found\n  /* eslint-disable max-statements */\n  _initialize() {\n    debug(TRACE_INITIALIZE, this);\n\n    this._initState();\n\n    // Call subclass lifecycle methods\n    this.initializeState(this.context);\n    // Initialize extensions\n    for (const extension of this.props.extensions) {\n      extension.initializeState.call(this, this.context, extension);\n    }\n    // End subclass lifecycle methods\n\n    // initializeState callback tends to clear state\n    this.setChangeFlags({\n      dataChanged: true,\n      propsChanged: true,\n      viewportChanged: true,\n      extensionsChanged: true\n    });\n\n    this._updateState();\n  }\n\n  // Called by layer manager\n  // if this layer is new (not matched with an existing layer) oldProps will be empty object\n  _update() {\n    // Call subclass lifecycle method\n    const stateNeedsUpdate = this.needsUpdate();\n    // End lifecycle method\n    debug(TRACE_UPDATE, this, stateNeedsUpdate);\n\n    if (stateNeedsUpdate) {\n      this._updateState();\n    }\n  }\n\n  // Common code for _initialize and _update\n  _updateState() {\n    const currentProps = this.props;\n    const currentViewport = this.context.viewport;\n    const propsInTransition = this._updateUniformTransition();\n    this.internalState.propsInTransition = propsInTransition;\n    // Overwrite this.context.viewport during update to use the last activated viewport on this layer\n    // In multi-view applications, a layer may only be drawn in one of the views\n    // Which would make the \"active\" viewport different from the shared context\n    this.context.viewport = this.internalState.viewport || currentViewport;\n    // Overwrite this.props during update to use in-transition prop values\n    this.props = propsInTransition;\n\n    const updateParams = this._getUpdateParams();\n    const oldModels = this.getModels();\n\n    // Safely call subclass lifecycle methods\n    if (this.context.gl) {\n      this.updateState(updateParams);\n    } else {\n      try {\n        this.updateState(updateParams);\n      } catch (error) {\n        // ignore error if gl context is missing\n      }\n    }\n    // Execute extension updates\n    for (const extension of this.props.extensions) {\n      extension.updateState.call(this, updateParams, extension);\n    }\n\n    const modelChanged = this.getModels()[0] !== oldModels[0];\n    this._updateModules(updateParams, modelChanged);\n    // End subclass lifecycle methods\n\n    if (this.isComposite) {\n      // Render or update previously rendered sublayers\n      this._renderLayers(updateParams);\n    } else {\n      this.setNeedsRedraw();\n      // Add any subclass attributes\n      this._updateAttributes(this.props);\n\n      // Note: Automatic instance count update only works for single layers\n      if (this.state.model) {\n        this.state.model.setInstanceCount(this.getNumInstances());\n      }\n    }\n\n    // Restore shared context\n    this.context.viewport = currentViewport;\n    this.props = currentProps;\n    this.clearChangeFlags();\n    this.internalState.needsUpdate = false;\n    this.internalState.resetOldProps();\n  }\n  /* eslint-enable max-statements */\n\n  // Called by manager when layer is about to be disposed\n  // Note: not guaranteed to be called on application shutdown\n  _finalize() {\n    debug(TRACE_FINALIZE, this);\n    assert(this.internalState && this.state);\n\n    // Call subclass lifecycle method\n    this.finalizeState(this.context);\n    // Finalize extensions\n    for (const extension of this.props.extensions) {\n      extension.finalizeState.call(this, extension);\n    }\n  }\n\n  // Calculates uniforms\n  drawLayer({moduleParameters = null, uniforms = {}, parameters = {}}) {\n    this._updateAttributeTransition();\n\n    const currentProps = this.props;\n    // Overwrite this.props during redraw to use in-transition prop values\n    // `internalState.propsInTransition` could be missing if `updateState` failed\n    this.props = this.internalState.propsInTransition || currentProps;\n\n    const {opacity} = this.props;\n    // apply gamma to opacity to make it visually \"linear\"\n    uniforms.opacity = Math.pow(opacity, 1 / 2.2);\n\n    // TODO/ib - hack move to luma Model.draw\n    if (moduleParameters) {\n      this.setModuleParameters(moduleParameters);\n    }\n\n    // Apply polygon offset to avoid z-fighting\n    // TODO - move to draw-layers\n    const {getPolygonOffset} = this.props;\n    const offsets = (getPolygonOffset && getPolygonOffset(uniforms)) || [0, 0];\n\n    setParameters(this.context.gl, {polygonOffset: offsets});\n\n    // Call subclass lifecycle method\n    withParameters(this.context.gl, parameters, () => {\n      const opts = {moduleParameters, uniforms, parameters, context: this.context};\n\n      // extensions\n      for (const extension of this.props.extensions) {\n        extension.draw.call(this, opts, extension);\n      }\n\n      this.draw(opts);\n    });\n\n    // End lifecycle method\n\n    this.props = currentProps;\n  }\n\n  // Helper methods\n  getChangeFlags() {\n    return this.internalState.changeFlags;\n  }\n\n  // Dirty some change flags, will be handled by updateLayer\n  /* eslint-disable complexity */\n  setChangeFlags(flags) {\n    const {changeFlags} = this.internalState;\n\n    /* eslint-disable no-fallthrough, max-depth */\n    for (const key in flags) {\n      if (flags[key]) {\n        let flagChanged = false;\n        switch (key) {\n          case 'dataChanged':\n            // changeFlags.dataChanged may be `false`, a string (reason) or an array of ranges\n            if (Array.isArray(changeFlags[key])) {\n              changeFlags[key] = Array.isArray(flags[key])\n                ? changeFlags[key].concat(flags[key])\n                : flags[key];\n              flagChanged = true;\n            }\n\n          default:\n            if (!changeFlags[key]) {\n              changeFlags[key] = flags[key];\n              flagChanged = true;\n            }\n        }\n        if (flagChanged) {\n          debug(TRACE_CHANGE_FLAG, this, key, flags);\n        }\n      }\n    }\n    /* eslint-enable no-fallthrough, max-depth */\n\n    // Update composite flags\n    const propsOrDataChanged =\n      changeFlags.dataChanged ||\n      changeFlags.updateTriggersChanged ||\n      changeFlags.propsChanged ||\n      changeFlags.extensionsChanged;\n    changeFlags.propsOrDataChanged = propsOrDataChanged;\n    changeFlags.somethingChanged =\n      propsOrDataChanged || flags.viewportChanged || flags.stateChanged;\n  }\n  /* eslint-enable complexity */\n\n  // Clear all changeFlags, typically after an update\n  clearChangeFlags() {\n    this.internalState.changeFlags = {\n      // Primary changeFlags, can be strings stating reason for change\n      dataChanged: false,\n      propsChanged: false,\n      updateTriggersChanged: false,\n      viewportChanged: false,\n      stateChanged: false,\n      extensionsChanged: false,\n\n      // Derived changeFlags\n      propsOrDataChanged: false,\n      somethingChanged: false\n    };\n  }\n\n  // Compares the layers props with old props from a matched older layer\n  // and extracts change flags that describe what has change so that state\n  // can be update correctly with minimal effort\n  diffProps(newProps, oldProps) {\n    const changeFlags = diffProps(newProps, oldProps);\n\n    // iterate over changedTriggers\n    if (changeFlags.updateTriggersChanged) {\n      for (const key in changeFlags.updateTriggersChanged) {\n        if (changeFlags.updateTriggersChanged[key]) {\n          this.invalidateAttribute(key);\n        }\n      }\n    }\n\n    // trigger uniform transitions\n    if (changeFlags.transitionsChanged) {\n      for (const key in changeFlags.transitionsChanged) {\n        // prop changed and transition is enabled\n        this.internalState.uniformTransitions.add(\n          key,\n          oldProps[key],\n          newProps[key],\n          newProps.transitions[key]\n        );\n      }\n    }\n\n    return this.setChangeFlags(changeFlags);\n  }\n\n  // Called by layer manager to validate props (in development)\n  validateProps() {\n    validateProps(this.props);\n  }\n\n  setModuleParameters(moduleParameters) {\n    for (const model of this.getModels()) {\n      model.updateModuleSettings(moduleParameters);\n    }\n  }\n\n  // PRIVATE METHODS\n  _updateModules({props, oldProps}, forceUpdate) {\n    // Picking module parameters\n    const {autoHighlight, highlightedObjectIndex, highlightColor} = props;\n    if (\n      forceUpdate ||\n      oldProps.autoHighlight !== autoHighlight ||\n      oldProps.highlightedObjectIndex !== highlightedObjectIndex ||\n      oldProps.highlightColor !== highlightColor\n    ) {\n      const parameters = {};\n      if (!autoHighlight) {\n        parameters.pickingSelectedColor = null;\n      }\n      if (Array.isArray(highlightColor)) {\n        parameters.pickingHighlightColor = highlightColor;\n      }\n\n      // highlightedObjectIndex will overwrite any settings from auto highlighting.\n      if (Number.isInteger(highlightedObjectIndex)) {\n        parameters.pickingSelectedColor =\n          highlightedObjectIndex >= 0 ? this.encodePickingColor(highlightedObjectIndex) : null;\n      }\n\n      this.setModuleParameters(parameters);\n    }\n  }\n\n  _getUpdateParams() {\n    return {\n      props: this.props,\n      oldProps: this.internalState.getOldProps(),\n      context: this.context,\n      changeFlags: this.internalState.changeFlags\n    };\n  }\n\n  // Checks state of attributes and model\n  _getNeedsRedraw(opts) {\n    // this method may be called by the render loop as soon a the layer\n    // has been created, so guard against uninitialized state\n    if (!this.internalState) {\n      return false;\n    }\n\n    let redraw = false;\n    redraw = redraw || (this.internalState.needsRedraw && this.id);\n    this.internalState.needsRedraw = this.internalState.needsRedraw && !opts.clearRedrawFlags;\n\n    // TODO - is attribute manager needed? - Model should be enough.\n    const attributeManager = this.getAttributeManager();\n    const attributeManagerNeedsRedraw = attributeManager && attributeManager.getNeedsRedraw(opts);\n    redraw = redraw || attributeManagerNeedsRedraw;\n\n    return redraw;\n  }\n\n  // Create new attribute manager\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats,\n      timeline: this.context.timeline\n    });\n  }\n\n  _initState() {\n    assert(!this.internalState && !this.state);\n    assert(isFinite(this.props.coordinateSystem), `${this.id}: invalid coordinateSystem`);\n\n    const attributeManager = this._getAttributeManager();\n\n    if (attributeManager) {\n      // All instanced layers get instancePickingColors attribute by default\n      // Their shaders can use it to render a picking scene\n      // TODO - this slightly slows down non instanced layers\n      attributeManager.addInstanced({\n        instancePickingColors: {\n          type: GL.UNSIGNED_BYTE,\n          size: 3,\n          noAlloc: true,\n          update: this.calculateInstancePickingColors\n        }\n      });\n    }\n\n    this.internalState = new LayerState({\n      attributeManager,\n      layer: this\n    });\n    this.clearChangeFlags(); // populate this.internalState.changeFlags\n\n    this.state = {};\n    // for backwards compatibility with older layers\n    // TODO - remove in next release\n    /* eslint-disable accessor-pairs */\n    Object.defineProperty(this.state, 'attributeManager', {\n      get: () => {\n        log.deprecated('layer.state.attributeManager', 'layer.getAttributeManager()');\n        return attributeManager;\n      }\n    });\n    /* eslint-enable accessor-pairs */\n\n    this.internalState.layer = this;\n    this.internalState.uniformTransitions = new UniformTransitionManager(this.context.timeline);\n    this.internalState.onAsyncPropUpdated = this._onAsyncPropUpdated.bind(this);\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n  }\n\n  // Called by layer manager to transfer state from an old layer\n  _transferState(oldLayer) {\n    debug(TRACE_MATCHED, this, this === oldLayer);\n\n    const {state, internalState} = oldLayer;\n    assert(state && internalState);\n\n    if (this === oldLayer) {\n      return;\n    }\n\n    // Move internalState\n    this.internalState = internalState;\n    this.internalState.layer = this;\n\n    // Move state\n    this.state = state;\n    // We keep the state ref on old layers to support async actions\n    // oldLayer.state = null;\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n\n    this.diffProps(this.props, this.internalState.getOldProps());\n  }\n\n  _onAsyncPropUpdated() {\n    this.diffProps(this.props, this.internalState.getOldProps());\n    this.setNeedsUpdate();\n  }\n}\n\nLayer.layerName = 'Layer';\nLayer.defaultProps = defaultProps;\n"],"file":"layer.js"}