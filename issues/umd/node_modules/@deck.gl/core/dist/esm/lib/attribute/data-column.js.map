{"version":3,"sources":["../../../../src/lib/attribute/data-column.js"],"names":["hasFeature","FEATURES","Buffer","ShaderAttribute","glArrayFromType","typedArrayManager","toDoublePrecisionArray","log","getStride","accessor","stride","size","bytesPerElement","resolveShaderAttribute","baseAccessor","shaderAttributeOptions","offset","removed","vertexOffset","elementOffset","resolveDoublePrecisionShaderAttributes","resolvedOptions","high","low","DataColumn","gl","opts","id","logicalType","type","doublePrecision","defaultValue","Number","isFinite","Array","fill","bufferType","isIndexed","ELEMENT_INDEX_UINT32","defaultType","shaderAttributes","fp64","Float32Array","BYTES_PER_ELEMENT","value","settings","state","externalBuffer","bufferAccessor","allocatedValue","constant","_buffer","setData","release","options","isBuffer64Bit","Float64Array","doubleShaderAttributeDefs","getAccessor","shaderAttributeDef","getBuffer","ArrayBuffer","isView","buffer","_normalizeValue","normalized","_normalizeConstant","hasChanged","_areValuesEqual","_checkExternalBuffer","byteOffset","requiredBufferSize","byteLength","reallocate","setAccessor","subData","data","startOffset","endOffset","startIndex","endIndex","subarray","numInstances","copy","oldValue","allocate","ArrayType","illegalArrayType","Error","constructor","name","warn","map","x","out","start","i","value1","value2","target"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport GL from '@luma.gl/constants';\nimport {hasFeature, FEATURES, Buffer} from '@luma.gl/core';\nimport ShaderAttribute from './shader-attribute';\nimport {glArrayFromType} from './gl-utils';\nimport typedArrayManager from '../../utils/typed-array-manager';\nimport {toDoublePrecisionArray} from '../../utils/math-utils';\nimport log from '../../utils/log';\n\nfunction getStride(accessor) {\n  return accessor.stride || accessor.size * accessor.bytesPerElement;\n}\n\nfunction resolveShaderAttribute(baseAccessor, shaderAttributeOptions) {\n  if (shaderAttributeOptions.offset) {\n    log.removed('shaderAttribute.offset', 'vertexOffset, elementOffset')();\n  }\n\n  // All shader attributes share the parent's stride\n  const stride = getStride(baseAccessor);\n  // `vertexOffset` is used to access the neighboring vertex's value\n  // e.g. `nextPositions` in polygon\n  const vertexOffset =\n    'vertexOffset' in shaderAttributeOptions\n      ? shaderAttributeOptions.vertexOffset\n      : baseAccessor.vertexOffset || 0;\n  // `elementOffset` is defined when shader attribute's size is smaller than the parent's\n  // e.g. `translations` in transform matrix\n  const elementOffset = shaderAttributeOptions.elementOffset || 0;\n  const offset =\n    // offsets defined by the attribute\n    vertexOffset * stride +\n    elementOffset * baseAccessor.bytesPerElement +\n    // offsets defined by external buffers if any\n    (baseAccessor.offset || 0);\n\n  return {\n    ...shaderAttributeOptions,\n    offset,\n    stride\n  };\n}\n\nfunction resolveDoublePrecisionShaderAttributes(baseAccessor, shaderAttributeOptions) {\n  const resolvedOptions = resolveShaderAttribute(baseAccessor, shaderAttributeOptions);\n\n  return {\n    high: resolvedOptions,\n    low: {\n      ...resolvedOptions,\n      offset: resolvedOptions.offset + baseAccessor.size * 4\n    }\n  };\n}\n\nexport default class DataColumn {\n  /* eslint-disable max-statements */\n  constructor(gl, opts) {\n    this.gl = gl;\n    this.id = opts.id;\n    this.size = opts.size;\n\n    const logicalType = opts.logicalType || opts.type;\n    const doublePrecision = logicalType === GL.DOUBLE;\n\n    let {defaultValue} = opts;\n    defaultValue = Number.isFinite(defaultValue)\n      ? [defaultValue]\n      : defaultValue || new Array(this.size).fill(0);\n    opts.defaultValue = defaultValue;\n\n    let bufferType = logicalType;\n    if (doublePrecision) {\n      bufferType = GL.FLOAT;\n    } else if (!bufferType && opts.isIndexed) {\n      bufferType =\n        gl && hasFeature(gl, FEATURES.ELEMENT_INDEX_UINT32) ? GL.UNSIGNED_INT : GL.UNSIGNED_SHORT;\n    } else if (!bufferType) {\n      bufferType = GL.FLOAT;\n    }\n    opts.logicalType = logicalType;\n    opts.type = bufferType;\n\n    // This is the attribute type defined by the layer\n    // If an external buffer is provided, this.type may be overwritten\n    // But we always want to use defaultType for allocation\n    let defaultType = glArrayFromType(logicalType || bufferType || GL.FLOAT);\n    this.shaderAttributes = {};\n    this.doublePrecision = doublePrecision;\n\n    // `fp64: false` tells a double-precision attribute to allocate Float32Arrays\n    // by default when using auto-packing. This is more efficient in use cases where\n    // high precision is unnecessary, but the `64Low` attribute is still required\n    // by the shader.\n    if (doublePrecision && opts.fp64 === false) {\n      defaultType = Float32Array;\n    }\n    opts.bytesPerElement = defaultType.BYTES_PER_ELEMENT;\n\n    this.defaultType = defaultType;\n    this.value = null;\n    this.settings = opts;\n    this.state = {\n      externalBuffer: null,\n      bufferAccessor: opts,\n      allocatedValue: null,\n      constant: false\n    };\n    this._buffer = null;\n\n    this.setData(opts);\n  }\n  /* eslint-enable max-statements */\n\n  get buffer() {\n    if (!this._buffer) {\n      const {isIndexed, type} = this.settings;\n      this._buffer = new Buffer(this.gl, {\n        id: this.id,\n        target: isIndexed ? GL.ELEMENT_ARRAY_BUFFER : GL.ARRAY_BUFFER,\n        accessor: {type}\n      });\n    }\n    return this._buffer;\n  }\n\n  get byteOffset() {\n    const accessor = this.getAccessor();\n    if (accessor.vertexOffset) {\n      return accessor.vertexOffset * getStride(accessor);\n    }\n    return 0;\n  }\n\n  delete() {\n    if (this._buffer) {\n      this._buffer.delete();\n      this._buffer = null;\n    }\n    typedArrayManager.release(this.state.allocatedValue);\n  }\n\n  getShaderAttributes(id, options) {\n    if (this.doublePrecision) {\n      const shaderAttributes = {};\n      const isBuffer64Bit = this.value instanceof Float64Array;\n\n      const doubleShaderAttributeDefs = resolveDoublePrecisionShaderAttributes(\n        this.getAccessor(),\n        options || {}\n      );\n\n      shaderAttributes[id] = new ShaderAttribute(this, doubleShaderAttributeDefs.high);\n      shaderAttributes[`${id}64Low`] = isBuffer64Bit\n        ? new ShaderAttribute(this, doubleShaderAttributeDefs.low)\n        : new Float32Array(this.size); // use constant for low part if buffer is 32-bit\n      return shaderAttributes;\n    }\n    if (options) {\n      const shaderAttributeDef = resolveShaderAttribute(this.getAccessor(), options);\n      return {[id]: new ShaderAttribute(this, shaderAttributeDef)};\n    }\n    return {[id]: this};\n  }\n\n  getBuffer() {\n    if (this.state.constant) {\n      return null;\n    }\n    return this.state.externalBuffer || this._buffer;\n  }\n\n  getValue() {\n    if (this.state.constant) {\n      return this.value;\n    }\n    return [this.getBuffer(), this.getAccessor()];\n  }\n\n  getAccessor() {\n    return this.state.bufferAccessor;\n  }\n\n  // returns true if success\n  // eslint-disable-next-line max-statements\n  setData(opts) {\n    const {state} = this;\n    if (ArrayBuffer.isView(opts)) {\n      opts = {value: opts};\n    } else if (opts instanceof Buffer) {\n      opts = {buffer: opts};\n    }\n\n    const accessor = {...this.settings, ...opts};\n    state.bufferAccessor = accessor;\n\n    if (opts.constant) {\n      // set constant\n      let value = opts.value;\n      value = this._normalizeValue(value, [], 0);\n      if (this.settings.normalized) {\n        value = this._normalizeConstant(value);\n      }\n      const hasChanged = !state.constant || !this._areValuesEqual(value, this.value);\n\n      if (!hasChanged) {\n        return false;\n      }\n      state.externalBuffer = null;\n      state.constant = true;\n      this.value = value;\n    } else if (opts.buffer) {\n      const buffer = opts.buffer;\n      state.externalBuffer = buffer;\n      state.constant = false;\n      this.value = opts.value;\n      const isBuffer64Bit = opts.value instanceof Float64Array;\n\n      // Copy the type of the buffer into the accessor\n      accessor.type = opts.type || buffer.accessor.type;\n      accessor.bytesPerElement = buffer.accessor.BYTES_PER_ELEMENT * (isBuffer64Bit ? 2 : 1);\n      accessor.stride = getStride(accessor);\n    } else if (opts.value) {\n      this._checkExternalBuffer(opts);\n\n      let value = opts.value;\n      state.externalBuffer = null;\n      state.constant = false;\n      this.value = value;\n\n      accessor.bytesPerElement = value.BYTES_PER_ELEMENT;\n      accessor.stride = getStride(accessor);\n\n      const {buffer, byteOffset} = this;\n\n      if (this.doublePrecision && value instanceof Float64Array) {\n        value = toDoublePrecisionArray(value, accessor);\n      }\n\n      // A small over allocation is used as safety margin\n      // Shader attributes may try to access this buffer with bigger offsets\n      const requiredBufferSize = value.byteLength + byteOffset + accessor.stride * 2;\n      if (buffer.byteLength < requiredBufferSize) {\n        buffer.reallocate(requiredBufferSize);\n      }\n      // Hack: force Buffer to infer data type\n      buffer.setAccessor(null);\n      buffer.subData({data: value, offset: byteOffset});\n      accessor.type = opts.type || buffer.accessor.type;\n    }\n\n    return true;\n  }\n\n  updateSubBuffer(opts = {}) {\n    const {value} = this;\n    const {startOffset = 0, endOffset} = opts;\n    this.buffer.subData({\n      data:\n        this.doublePrecision && value instanceof Float64Array\n          ? toDoublePrecisionArray(value, {\n              size: this.size,\n              startIndex: startOffset,\n              endIndex: endOffset\n            })\n          : value.subarray(startOffset, endOffset),\n      offset: startOffset * value.BYTES_PER_ELEMENT + this.byteOffset\n    });\n  }\n\n  allocate({numInstances, copy = false}) {\n    const {state} = this;\n    const oldValue = state.allocatedValue;\n\n    // Allocate at least one element to ensure a valid buffer\n    const value = typedArrayManager.allocate(oldValue, numInstances + 1, {\n      size: this.size,\n      type: this.defaultType,\n      copy\n    });\n\n    this.value = value;\n\n    const {buffer, byteOffset} = this;\n\n    if (buffer.byteLength < value.byteLength + byteOffset) {\n      buffer.reallocate(value.byteLength + byteOffset);\n\n      if (copy && oldValue) {\n        // Upload the full existing attribute value to the GPU, so that updateBuffer\n        // can choose to only update a partial range.\n        // TODO - copy old buffer to new buffer on the GPU\n        buffer.subData({\n          data:\n            oldValue instanceof Float64Array ? toDoublePrecisionArray(oldValue, this) : oldValue,\n          offset: byteOffset\n        });\n      }\n    }\n\n    state.allocatedValue = value;\n    state.constant = false;\n    state.externalBuffer = null;\n    state.bufferAccessor = this.settings;\n    return true;\n  }\n\n  // PRIVATE HELPER METHODS\n  _checkExternalBuffer(opts) {\n    const {value} = opts;\n    if (!opts.constant && value) {\n      const ArrayType = this.defaultType;\n\n      let illegalArrayType = false;\n      if (this.doublePrecision) {\n        // not 32bit or 64bit\n        illegalArrayType = value.BYTES_PER_ELEMENT < 4;\n      }\n      if (illegalArrayType) {\n        throw new Error(`Attribute ${this.id} does not support ${value.constructor.name}`);\n      }\n      if (!(value instanceof ArrayType) && this.settings.normalized && !('normalized' in opts)) {\n        log.warn(`Attribute ${this.id} is normalized`)();\n      }\n    }\n  }\n\n  // https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\n  _normalizeConstant(value) {\n    switch (this.settings.type) {\n      case GL.BYTE:\n        // normalize [-128, 127] to [-1, 1]\n        return new Float32Array(value).map(x => ((x + 128) / 255) * 2 - 1);\n\n      case GL.SHORT:\n        // normalize [-32768, 32767] to [-1, 1]\n        return new Float32Array(value).map(x => ((x + 32768) / 65535) * 2 - 1);\n\n      case GL.UNSIGNED_BYTE:\n        // normalize [0, 255] to [0, 1]\n        return new Float32Array(value).map(x => x / 255);\n\n      case GL.UNSIGNED_SHORT:\n        // normalize [0, 65535] to [0, 1]\n        return new Float32Array(value).map(x => x / 65535);\n\n      default:\n        // No normalization for gl.FLOAT and gl.HALF_FLOAT\n        return value;\n    }\n  }\n\n  /* check user supplied values and apply fallback */\n  _normalizeValue(value, out, start) {\n    const {defaultValue, size} = this.settings;\n\n    if (Number.isFinite(value)) {\n      out[start] = value;\n      return out;\n    }\n    if (!value) {\n      out[start] = defaultValue[0];\n      return out;\n    }\n\n    // Important - switch cases are 5x more performant than a for loop!\n    /* eslint-disable no-fallthrough, default-case */\n    switch (size) {\n      case 4:\n        out[start + 3] = Number.isFinite(value[3]) ? value[3] : defaultValue[3];\n      case 3:\n        out[start + 2] = Number.isFinite(value[2]) ? value[2] : defaultValue[2];\n      case 2:\n        out[start + 1] = Number.isFinite(value[1]) ? value[1] : defaultValue[1];\n      case 1:\n        out[start + 0] = Number.isFinite(value[0]) ? value[0] : defaultValue[0];\n        break;\n\n      default:\n        // In the rare case where the attribute size > 4, do it the slow way\n        // This is used for e.g. transform matrices\n        let i = size;\n        while (--i >= 0) {\n          out[start + i] = Number.isFinite(value[i]) ? value[i] : defaultValue[i];\n        }\n    }\n\n    return out;\n  }\n\n  _areValuesEqual(value1, value2) {\n    if (!value1 || !value2) {\n      return false;\n    }\n    const {size} = this;\n    for (let i = 0; i < size; i++) {\n      if (value1[i] !== value2[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n}\n"],"file":"data-column.js"}