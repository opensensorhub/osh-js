function readMP4Info(e){var t={absoluteTime:0,pts:0,timeScale:0,duration:0,rate:0},i=60;return t.absoluteTime=new DataView(e,i,i+8).getUint32(0),t.absoluteTime=1e3*(t.absoluteTime-2082844800),i+=8,t.pts=new DataView(e,i,i+4).getUint32(0),i+=4,t.timeScale=new DataView(e,i,i+4).getUint32(0),t.timeScale=1/t.timeScale,i+=4,t.duration=new DataView(e,i,i+4).getUint32(0),i+=4,t.rate=new DataView(e,i,i+4).getUint32(0),t}function readNCC(e,t){for(var i="",n=0;n<t;n++)i+=String.fromCharCode(e[n]);return i}function onMouseUpdate(e){absoluteXposition=e.pageX,absoluteYposition=e.pageY}OSH.DataConnector.AjaxConnector=Class.create(OSH.DataConnector.DataConnector,{sendRequest:function(e){var t=new XMLHttpRequest;t.open("POST",this.getUrl(),!0),t.setRequestHeader("Content-Type","text/xml"),t.send(e),t.onreadystatechange=function(){4==t.readyState&&200==t.status&&console.log("ici")}.bind(this)},onError:function(e){},onSuccess:function(e){}}),OSH.DataConnector.WebSocketDataConnector=Class.create(OSH.DataConnector.DataConnector,{connect:function(){if(!this.init){if(OSH.Utils.isWebWorker()){var e=this.getUrl(),t=URL.createObjectURL(new Blob(["(",function(){function e(e){i=new WebSocket(e),i.binaryType="arraybuffer",i.onmessage=function(e){e.data.byteLength>0&&self.postMessage(e.data)},i.onerror=function(e){i.close()}}function t(){i.close()}var i=null;self.onmessage=function(i){"close"==i.data?t():e(i.data)}}.toString(),")()"],{type:"application/javascript"}));this.worker=new Worker(t),this.worker.postMessage(e),this.worker.onmessage=function(e){this.onMessage(e.data)}.bind(this),URL.revokeObjectURL(t)}else this.ws=new WebSocket(this.getUrl()),this.ws.binaryType="arraybuffer",this.ws.onmessage=function(e){e.data.byteLength>0&&this.onMessage(e.data)}.bind(this),this.ws.onerror=function(e){this.ws.close()}.bind(this);this.init=!0}},disconnect:function(){OSH.Utils.isWebWorker()&&null!=this.worker?(this.worker.postMessage("close"),this.worker.terminate(),this.init=!1):null!=this.ws&&(this.ws.close(),this.init=!1)},onMessage:function(e){},close:function(){this.disconnect()}}),OSH.DataConnector.DataConnector=Class.create({initialize:function(e){this.url=e,this.id="DataConnector-"+OSH.Utils.randomUUID()},getId:function(){return this.id},getUrl:function(){return this.url}}),OSH.DataReceiver.DataSource=Class.create({initialize:function(e,t){this.id="DataSource-"+OSH.Utils.randomUUID(),this.name=e,this.properties=t,this.timeShift=0,this.connected=!1,this.initDataSource(t)},initDataSource:function(e){"undefined"!=typeof e.timeShift&&(this.timeShift=e.timeShift),"undefined"!=typeof e.syncMasterTime?this.syncMasterTime=e.syncMasterTime:this.syncMasterTime=!1,"undefined"!=typeof e.bufferingTime&&(this.bufferingTime=e.bufferingTime),"undefined"!=typeof e.timeOut&&(this.timeOut=e.timeOut),"ws"==e.protocol&&(this.connector=new OSH.DataConnector.WebSocketDataConnector(this.buildUrl(e)),this.connector.onMessage=this.onMessage.bind(this))},disconnect:function(){this.connector.disconnect(),this.connected=!1,OSH.EventManager.fire(OSH.EventManager.EVENT.DATA+"-"+this.id,{dataSourceId:this.id,reset:!0})},connect:function(){this.connector.connect(),this.connected=!0},onMessage:function(e){var e={timeStamp:this.parseTimeStamp(e)+this.timeShift,data:this.parseData(e)};this.onData(e)},parseTimeStamp:function(e){return(new Date).getTime()},parseData:function(e){return e},onData:function(e){},getId:function(){return this.id},getName:function(){return this.name},buildUrl:function(e){var t="";t+=e.protocol+"://",t+=e.endpointUrl+"?",t+="service="+e.service+"&",t+="version=2.0&",t+="request=GetResult&",t+="offering="+e.offeringID+"&",t+="observedProperty="+e.observedProperty+"&";var i=e.startTime,n=e.endTime;return"now"!==i&&0!=this.timeShift&&"urn:android:device:060693280a28e015-sos"!==e.offeringID&&(i=new Date(Date.parse(i)-this.timeShift).toISOString(),n=new Date(Date.parse(n)-this.timeShift).toISOString()),t+="temporalFilter=phenomenonTime,"+i+"/"+n+"&",e.replaySpeed&&(t+="replaySpeed="+e.replaySpeed),e.responseFormat&&(t+="&responseFormat="+e.responseFormat),t}}),OSH.DataReceiver.Chart=Class.create(OSH.DataReceiver.DataSource,{parseTimeStamp:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=new Date(n[0]).getTime();return a},parseData:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(",");return n.shift(),n}}),OSH.DataReceiver.EulerOrientation=Class.create(OSH.DataReceiver.DataSource,{parseTimeStamp:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=new Date(n[0]).getTime();return a},parseData:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=parseFloat(n[1]),o=parseFloat(n[2]),s=parseFloat(n[3]);return{pitch:o,roll:s,heading:a}}}),OSH.DataReceiver.LatLonAlt=Class.create(OSH.DataReceiver.DataSource,{parseTimeStamp:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=new Date(n[0]).getTime();return a},parseData:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=parseFloat(n[1]),o=parseFloat(n[2]),s=parseFloat(n[3]);return{lat:a,lon:o,alt:s}}}),OSH.DataReceiver.Nexrad=Class.create(OSH.DataReceiver.DataSource,{parseTimeStamp:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(",");return new Date(n[0]).getTime()},parseData:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=parseFloat(n[2]),o=parseFloat(n[3]),s=parseFloat(n[4]),r=parseFloat(n[5]),d=parseInt(n[6]),l=parseFloat(n[7]),c=parseFloat(n[8]),u=parseInt(n[9]),h=parseFloat(n[10]),f=parseFloat(n[11]),m=parseInt(n[12]),p=13,v=[];for(count=0;count<d;count++)v.push(parseFloat(n[p++]));var g=[];for(count=0;count<u;count++)g.push(parseFloat(n[p++]));var S=[];for(count=0;count<m;count++)S.push(parseFloat(n[p++]));return{elevation:a,azimuth:o,rangeToCenterOfFirstRefGate:s,refGateSize:r,rangeToCenterOfFirstVelGate:l,velGateSize:c,rangeToCenterOfFirstSwGate:h,swGateSize:f,reflectivity:v,velocity:g,spectrumWidth:S}}}),OSH.DataReceiver.OrientationQuaternion=Class.create(OSH.DataReceiver.DataSource,{parseTimeStamp:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(",");return new Date(n[0]).getTime()},parseData:function(e,t){var i=String.fromCharCode.apply(null,new Uint8Array(t)),n=i.trim().split(","),a=parseFloat(n[1]),o=parseFloat(n[2]),s=parseFloat(n[3]),r=parseFloat(n[4]),d=0,l=0,c=-1,u=r*d+o*c-s*l,h=r*l+s*d-a*c,f=r*c+a*l-o*d,m=-a*d-o*l-s*c;xp=u*r+m*-a+h*-s-f*-o,yp=h*r+m*-o+f*-a-u*-s,zp=f*r+m*-s+u*-o-h*-a;var p=90-180/Math.PI*Math.atan2(yp,xp);return{heading:p,roll:null,pitch:null}}}),OSH.DataReceiver.VideoH264=Class.create(OSH.DataReceiver.DataSource,{initialize:function(e,t,i,n){e(t,i,n)},parseTimeStamp:function(e,t){return 1e3*new DataView(t).getFloat64(0,!1)},parseData:function(e,t){var i=t.byteLength;return new Uint8Array(t,12,i-12)}}),OSH.DataReceiver.VideoMjpeg=Class.create(OSH.DataReceiver.DataSource,{initialize:function(e,t,i,n){e(t,i,n)},parseTimeStamp:function(e,t){return 1e3*new DataView(t).getFloat64(0,!1)},parseData:function(e,t){var i=new Blob([t]),n=window.URL.createObjectURL(i.slice(12));return n}}),OSH.DataReceiver.VideoMp4=Class.create(OSH.DataReceiver.DataSource,{initialize:function(e,t,i,n){e(t,i,n),this.absoluteTime=-1},parseTimeStamp:function(e,t){if(this.absoluteTime==-1){var i=readMP4Info(t);return this.absoluteTime=i.absoluteTime,this.timeScale=i.timeScale,this.absoluteTime}var i=readMP4Info(t);return 1e3*i.pts*this.timeScale+this.absoluteTime}}),OSH.DataReceiver.DataReceiverController=Class.create({initialize:function(e){this.options=e,this.initBuffer(),this.dataSourcesIdToDataSources={},OSH.EventManager.observe(OSH.EventManager.EVENT.CONNECT_DATASOURCE,function(e){for(var t=e.dataSourcesId,i=0;i<t.length;i++){var n=t[i];n in this.dataSourcesIdToDataSources&&(this.dataSourcesIdToDataSources[n].syncMasterTime&&this.updateDataSourceTime(n,new Date(this.buffer.currentTime).toISOString()),this.dataSourcesIdToDataSources[n].connect(),this.buffer.startDataSource(n))}}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.DISCONNECT_DATASOURCE,function(e){for(var t=e.dataSourcesId,i=0;i<t.length;i++){var n=t[i];n in this.dataSourcesIdToDataSources&&(this.dataSourcesIdToDataSources[n].disconnect(),this.buffer.cancelDataSource(n))}}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.DATASOURCE_UPDATE_TIME,function(e){var t=[];for(var i in this.dataSourcesIdToDataSources){var n=this.dataSourcesIdToDataSources[i];n.syncMasterTime&&n.connected&&(n.disconnect(),this.buffer.cancelDataSource(i),t.push(i))}this.buffer.currentTime=Date.parse(e.startTime);for(var a=0;a<t.length;a++){var i=t[a],n=this.dataSourcesIdToDataSources[i];this.updateDataSourceTime(i,e.startTime,e.endTime),n.connect(),this.buffer.startDataSource(i)}}.bind(this))},updateDataSourceTime:function(e,t,i){var n=this.dataSourcesIdToDataSources[e],a=n.properties,o=n.options;"undefined"!=typeof t&&(a.startTime=t),"undefined"!=typeof i&&(a.endTime=i),n.initDataSource(a,o)},initBuffer:function(){this.buffer=new OSH.Buffer(this.options)},addEntity:function(e,t){if("undefined"!=typeof e.dataSources)for(var i=0;i<e.dataSources.length;i++)this.addDataSource(e.dataSources[i],t)},addDataSource:function(e,t){this.dataSourcesIdToDataSources[e.id]=e,this.buffer.addDataSource(e.id,{name:e.name,syncMasterTime:e.syncMasterTime,bufferingTime:e.bufferingTime,timeOut:e.timeOut}),e.onData=function(t){this.buffer.push({dataSourceId:e.getId(),data:t})}.bind(this)},connectAll:function(){this.buffer.start();for(var e in this.dataSourcesIdToDataSources)this.dataSourcesIdToDataSources[e].connect()}}),OSH.DataSender.DataSink=Class.create({initialize:function(e,t,i){"http"==t.protocol&&(this.connector=new OSH.DataConnector.AjaxConnector(this.buildUrl(t)),this.connector.onError=this.onCatchError.bind(this),this.connector.onSuccess=this.onCatchSuccess.bind(this)),this.id="DataSource-"+OSH.Utils.randomUUID(),this.name=e,this.properties=t},sendRequest:function(e){this.connector.sendRequest(this.buildRequest(e))},buildRequest:function(e){return""},buildUrl:function(e){var t="";return t+=e.protocol+"://",t+=e.endpointUrl},onCatchError:function(e){this.onError(e)},onCatchSuccess:function(e){this.onSuccess(e)},onError:function(e){},onSuccess:function(e){},getId:function(){return this.id},getName:function(){return this.name}}),OSH.DataSender.PtzTasking=Class.create(OSH.DataSender.DataSink,{buildRequest:function(e,t){var i="<sps:Submit ";return i+='service="'+this.properties.service+'" ',i+='version="'+this.properties.version+'" ',i+='xmlns:sps="http://www.opengis.net/sps/2.0" xmlns:swe="http://www.opengis.net/swe/2.0"> ',i+="<sps:procedure>"+this.properties.offeringID+"</sps:procedure>",i+="<sps:taskingParameters><sps:ParameterData>",i+='<sps:encoding><swe:TextEncoding blockSeparator=" "  collapseWhiteSpaces="true" decimalSeparator="." tokenSeparator=","/></sps:encoding>',i+="<sps:values>",0!=t.pan&&(i+="rpan,"+t.pan),0!=t.tilt&&(i+=" rtilt,"+t.tilt),0!=t.zoom&&(i+=" rzoom,"+t.zoom),i+="</sps:values></sps:ParameterData></sps:taskingParameters></sps:Submit>",document.fire("osh:log",i),i}}),OSH.DataSender.UavMapTasking=Class.create(OSH.DataSender.DataSource,{initialize:function(e,t,i){e(t,i),OSH.EventManager.observe(OSH.EventManager.EVENT.UAV_TAKEOFF,function(e){this.connector.sendRequest(this.buildTakeOffRequest())}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.UAV_GOTO,function(e){this.connector.sendRequest(this.buildGotoRequest({lat:e.geoLat,lon:e.geoLon}))}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.UAV_ORBIT,function(e){this.connector.sendRequest(this.buildOrbitRequest({lat:e.geoLat,lon:e.geoLon,radius:10}))}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.UAV_LOOKAT,function(e){this.connector.sendRequest(this.buildLookAtRequest({lat:e.geoLat,lon:e.geoLon}))}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.UAV_LAND,function(e){this.connector.sendRequest(this.buildLandRequest({lat:e.geoLat,lon:e.geoLon}))}.bind(this))},buildTakeOffRequest:function(e){return this.buildRequest("navCommands,TAKEOFF,10")},buildGotoRequest:function(e){return this.buildRequest("navCommands,GOTO_LLA,"+e.lat+","+e.lon+",0,0")},buildOrbitRequest:function(e){return this.buildRequest("navCommands,ORBIT,"+e.lat+","+e.lon+",0,"+e.radius)},buildLookAtRequest:function(e){return this.buildRequest("camCommands,MOUNT_TARGET,"+e.lat+","+e.lon+",0")},buildLandRequest:function(e){return this.buildRequest("navCommands,LAND,"+e.lat+","+e.lon)},buildRequest:function(e){var t="<sps:Submit ";return t+='service="'+this.properties.service+'" ',t+='version="'+this.properties.version+'" ',t+='xmlns:sps="http://www.opengis.net/sps/2.0" xmlns:swe="http://www.opengis.net/swe/2.0"> ',t+="<sps:procedure>"+this.properties.offeringID+"</sps:procedure>",t+="<sps:taskingParameters><sps:ParameterData>",t+='<sps:encoding><swe:TextEncoding blockSeparator=" "  collapseWhiteSpaces="true" decimalSeparator="." tokenSeparator=","/></sps:encoding>',t+="<sps:values>"+e+"</sps:values>",t+="</sps:ParameterData></sps:taskingParameters></sps:Submit>",document.fire("osh:log",t),t}}),OSH.DataSender.DataSenderController=Class.create({initialize:function(e){this.dataSources={}},addDataSource:function(e){this.dataSources[e.getId()]=e},sendRequest:function(e,t,i,n){e in this.dataSources&&("undefined"!=typeof i&&null!=i&&(this.dataSources[e].onSuccess=function(e){i(e)}),"undefined"!=typeof n&&null!=n&&(this.dataSources[e].onError=function(e){n(e)}),this.dataSources[e].sendRequest(t))}}),OSH.Sensor=Class.create({initialize:function(e){this.server=null,this.identifier=e.identifier,this.name=e.name[0].value,this.description=e.description,this.procedure=e.procedure;var t=null;if("undefined"!=typeof e.phenomenonTime&&(t=e.phenomenonTime.timePeriod),this.timeRangeStart=null!==t&&t.beginPosition.value.length>0?t.beginPosition.value[0]:"now",this.timeRangeEnd=null!==t&&t.endPosition.value.length>0?t.endPosition.value[0]:"now","now"==this.timeRangeEnd){var i=new Date;i.setUTCFullYear(2030),this.timeRangeEnd=i.toISOString()}if(this.observableProperties=[],this.outputs=[],this.featuresOfInterest=[],this.dataConnectors=[],"undefined"!=typeof e.observableProperty)for(var n=0;n<e.observableProperty.length;n++)this.observableProperties.push(e.observableProperty[n]);if("undefined"!=typeof e.relatedFeature)for(var a=0;a<e.relatedFeature.length;a++)this.featuresOfInterest.push(e.relatedFeature[a].featureRelationship.target.href)},describeSensor:function(){var e=this.server.url+"sensorhub/sos?service=SOS&version=2.0&request=DescribeSensor&procedure="+this.procedure,t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){console.log(this.name);var e=OSH.Utils.jsonix_XML2JSON(t.responseText);this.onDescribeSensor(e)}}.bind(this),t.open("GET",e,!0),t.send()},getResultTemplate:function(e){if(this.hasObservableProperty(e)){var t=this.server.url+"sensorhub/sos?service=SOS&version=2.0&request=GetResultTemplate&offering="+this.identifier+"&observedProperty="+e,i=new XMLHttpRequest;i.prop=e,i.onreadystatechange=function(){if(4==i.readyState&&200==i.status){var t=OSH.Utils.jsonix_XML2JSON(i.responseText);if(resEncoding={},resEncoding.fields=[],resEncoding.type=t.value.resultEncoding.abstractEncoding.name.localPart,"BinaryEncoding"==resEncoding.type){var n=t.value.resultEncoding.abstractEncoding.value.member;for(l=0;l<n.length;l++){var a=n[l].component.ref;refToks=a.split("/");var o=n[l].component.dataType.split("/");resEncoding.fields.push({name:a,type:o[o.length-1]})}}else if("TextEncoding"==resEncoding.type){var s=t.value.resultEncoding.abstractEncoding.value;resEncoding.collapseWhiteSpaces=s.collapseWhiteSpaces,resEncoding.tokenSeparator=s.tokenSeparator,resEncoding.decimalSeparator=s.decimalSeparator}var r={fields:[]};r.findFieldByName=function(e){for(var t=0;t<this.fields.length;t++)if(this.fields[t].name==e)return this.fields[t]};for(var d=t.value.resultStructure.abstractDataComponent.value.field,l=0;l<d.length;l++)this.buildDataFields(d[l],r);for(var c=0;c<resEncoding.fields.length;c++)this.setFieldEncoding(r,resEncoding.fields[c]);this.onGetResultTemplate(e,r,resEncoding)}}.bind(this),i.open("GET",t,!0),i.send()}},setFieldEncoding:function(e,t){var i=t.name,n=i.split("/");for(n.shift(),currFieldStruct=e;n.length>0;){for(var a=0;a<currFieldStruct.fields.length;a++)if(currFieldStruct.fields[a].name==n[0]){1==n.length?currFieldStruct.fields[a].type=t.type:currFieldStruct=currFieldStruct.fields[a];break}n.shift()}},buildDataFields:function(e,t){var i=e.abstractDataComponent;if("undefined"!=typeof i&&null!==i){if("DataArray"==i.name.localPart){var n=i.value.elementType,a=i.value.elementCount,o=0;o="undefined"!=typeof a.href?a.href.split("#")[1]:a.count.value;var e={name:e.name,val:[],count:o,fields:[]};t.fields.push(e),this.buildDataFields(n,e)}else if("Vector"==i.name.localPart){var e={name:e.name,fields:[]};t.fields.push(e);for(var s=0;s<i.value.coordinate.length;s++)this.buildDataFields(i.value.coordinate[s],e)}else if(t.fields.push({name:e.name,val:null,fields:[]}),"undefined"!=typeof i.value.id){t.id2FieldMap={};var r=i.value.id;t.id2FieldMap[r]=e.name}}else t.fields.push({name:e.name,val:null,fields:[]})},getResultTemplateAll:function(){for(var e=0;e<this.observableProperties.length;e++)this.getResultTemplate(this.observableProperties[e])},createDataConnector:function(e,t,i,n,a,o){if(n=this.timeRangeStart,a=this.timeRangeEnd,o=1,null===e||"undefined"==typeof e||!this.hasObservableProperty(e))return console.log("Could not create data connector! Property: "+e+" does not exist."),null;var s=this.server.getUrl();if(s=s.replace("http://","ws://"),s+="sensorhub/sos?service=SOS&version=2.0&request=GetResult&offering="+this.identifier,s+="&observedProperty="+e,!this.isValidTime(n)||!this.isValidTime(a))return console.log("Could not create data connector! Invalid time range"),null;s+="&temporalFilter=phenomenonTime,"+n+"/"+a,o>0&&(s+="&replaySpeed="+o),null!==t&&hasFeatureOfInterest(t)?s+="&featureOfInterest="+t:console.log("Warning! Feature Of Interest: "+t+" does not exist. Ignoring and returning all data");var r=new OSH.DataConnector.WebSocketDataConnector(s);return this.dataConnectors.push(r),r},createDataConnectorAll:function(e,t,i,n,a){"undefined"==typeof i&&(i=this.timeRangeStart),"undefined"==typeof n&&(i=this.timeRangeEnd),"undefined"==typeof a&&(a=1);for(var o=[],s=0;s<this.observableProperties.length;s++)o.push(this.createDataConnector(this.observableProperties[s],e,t,i,n,a));return o},hasObservableProperty:function(e){for(var t=0;t<this.observableProperties.length;t++)if(this.observableProperties[t]==e)return!0;return!1},hasFeatureOfInterest:function(e){for(var t=0;t<this.featuresOfInterest.length;t++)if(this.featuresOfInterest[t]==e)return!0;return!1},isValidTime:function(e){var t;t="now"==e?new Date:new Date(e);var i;i="now"==this.timeRangeStart?new Date:new Date(this.timeRangeStart);var n;return n="now"==this.timeRangeEnd?new Date:new Date(this.timeRangeEnd),t>=i&&t<=n},onDescribeSensor:function(e){},onGetResultTemplate:function(e,t,i){}}),OSH.Server=Class.create({initialize:function(e){this.url=e,this.id="Server-"+OSH.Utils.randomUUID(),this.capabilities=null,this.sensors=[]},getId:function(){return this.id},getUrl:function(){return this.url},getCapabilities:function(e,t){var i=this.url+"sensorhub/sos?service=SOS&version=2.0&request=GetCapabilities",n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){this.capabilities=OSH.Utils.jsonix_XML2JSON(n.responseText);for(var i=0;i<this.capabilities.value.contents.contents.offering.length;i++){var a=new OSH.Sensor(this.capabilities.value.contents.contents.offering[i].abstractOffering.value);a.server=this,this.sensors.push(a)}var o=e.bind(this);o(n.responseText)}else t(n.responseText)}.bind(this),n.open("GET",i,!0),n.send()},getSensorById:function(e){for(var t=0;t<this.sensors.length;t++)if(this.sensors[t].identifier==e)return this.sensors[t];return null}}),OSH.Log=Class.create({initialize:function(){this.logDiv=document.createElement("TEXTAREA"),this.logDiv.setAttribute("class","osh-log popup-content"),this.logDiv.setAttribute("wrap","off"),this.first=!0,document.observe("dom:loaded",function(){var e=new OSH.UI.Dialog({title:"Logging console"});e.appendContent(this.logDiv),e.setContentSize("300px","400px"),this.logDiv.value="[osh-log]> \n"}.bind(this)),document.observe("osh:log",function(e){this.first?(this.logDiv.value="[osh-log]> "+e.memo+"\n",this.first=!1):this.logDiv.value+="[osh-log]> "+e.memo+"\n"}.bind(this))}});var log=new OSH.Log,OSH={version:"dev"};window.OSH=OSH,window.OSH.Video={},window.OSH.UI={},window.OSH.UI.View={},window.OSH.Styler={},window.OSH.ContextMenu={},window.OSH.DataReceiver={},window.OSH.DataConnector={},window.OSH.Utils={},window.OSH.DataSender={};var MAX_LONG=Math.pow(2,53)+1;OSH.Utils=function(){},OSH.Utils.randomUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)})},OSH.Utils.jsonix_XML2JSON=function(e){var t=(SOS_2_0_Module_Factory(),new Jsonix.Context([XLink_1_0,IC_2_0,SMIL_2_0,SMIL_2_0_Language,GML_3_1_1,SWE_1_0_1,GML_3_2_1,OWS_1_1_0,SWE_2_0,SWES_2_0,WSN_T_1,WS_Addr_1_0_Core,OM_2_0,ISO19139_GMD_20070417,ISO19139_GCO_20070417,ISO19139_GSS_20070417,ISO19139_GTS_20070417,ISO19139_GSR_20070417,Filter_2_0,SensorML_2_0,SOS_2_0])),i=t.createUnmarshaller(),n=i.unmarshalString(e);return n},OSH.Utils.ParseBytes=function(e,t,i){var n=new DataView(e),a={double:function(e){return{val:n.getFloat64(e),bytes:8}},float64:function(e){return{val:n.getFloat64(e),bytes:8}},float32:function(e){return{val:n.getFloat32(e),bytes:4}},signedByte:function(e){return{val:n.getInt8(e),bytes:1}},signedInt:function(e){return{val:n.getInt32(e),bytes:4}},signedShort:function(e){return{val:n.getInt16(e),bytes:2}},unsignedByte:function(e){return{val:n.getUint8(e),bytes:1}},unsignedInt:function(e){return{val:n.getUint32(e),bytes:4}},unsignedShort:function(e){return{val:n.getUint16(e),bytes:2}}};return a[i](t)},OSH.Utils.ReadData=function(e,t,i){for(var n=i,a=0;a<e.fields.length;a++){var o=e.fields[a];if("undefined"!=typeof o.type&&null!=o.type){var s=OSH.Utils.ParseBytes(t,n,o.type);o.val=s.val,n+=s.bytes}else if("undefined"!=typeof o.count&&null!=o.count){if(isNaN(o.count)){var r=o.count,d=e.id2FieldMap[r];o.count=e.findFieldByName(d).val}for(var l=0;l<o.count;l++)for(var c=0;c<o.fields.length;c++){var u=JSON.parse(JSON.stringify(o.fields[c]));n=OSH.Utils.ReadData(u,t,n),o.val.push(u)}}}return n},OSH.Utils.GetResultObject=function(e){for(var t={},i=0;i<e.fields.length;i++)if("undefined"!=typeof e.fields[i].count){t[e.fields[i].name]=[];for(var n=0;n<e.fields[i].count;n++){for(var a={},o=0;o<e.fields[i].val[n].fields.length;o++)a[e.fields[i].val[n].fields[o].name]=e.fields[i].val[n].fields[o].val;t[e.fields[i].name].push(a)}}else t[e.fields[i].name]=e.fields[i].val;return t},OSH.Utils.isOpera=function(){return!!window.opr&&!!opr.addons||!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0},OSH.Utils.isFirefox=function(){return"undefined"!=typeof InstallTrigger},OSH.Utils.isSafari=function(){return Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0},OSH.Utils.isIE=function(){return!!document.documentMode},OSH.Utils.isChrome=function(){return!!window.chrome&&!!window.chrome.webstore},OSH.Utils.isBlink=function(){return(isChrome||isOpera)&&!!window.CSS};var absoluteXposition=null,absoluteYposition=null;document.addEventListener("mousemove",onMouseUpdate,!1),document.addEventListener("mouseenter",onMouseUpdate,!1),OSH.Utils.getXCursorPosition=function(){return absoluteXposition},OSH.Utils.getYCursorPosition=function(){return absoluteYposition},OSH.Utils.isArrayIntersect=function(e,t){return e.intersect(t).length>0},OSH.Utils.isWebWorker=function(){return Modernizr.webworkers},OSH.Utils.takeScreeshot=function(e){};var INITIAL_BUFFERING_TIME=3e3,BUFFER_STATUS={CANCEL:"cancel",START:"start",STOP:"stop",NOT_START_YET:"notStartYet"};OSH.Buffer=Class.create({initialize:function(e){this.buffers={},this.replayFactor=1,"undefined"!=typeof e&&"undefined"!=typeof e.replayFactor&&(this.replayFactor=e.replayFactor),this.stop=!1,this.bufferingState=!1},startObservers:function(){this.observeId=OSH.Utils.randomUUID(),this.boundHandlerMethod=this.push.bind(this),OSH.EventManager.observe(OSH.EventManager.EVENT.DATA,this.boundHandlerMethod,this.observeId)},stopObservers:function(){"undefined"==typeof this.observeId&&null===this.observeId||(OSH.EventManager.observe(OSH.EventManager.EVENT.DATA,this.boundHandlerMethod,this.observeId),this.observeId=void 0)},start:function(){this.stop=!1,this.startObservers(),this.startRealTime=(new Date).getTime(),this.processSyncData()},stop:function(){this.stopObservers(),this.stop=!0},cancelAll:function(){for(var e in this.buffers)this.cancelDataSource(e)},cancelDataSource:function(e){this.buffers[e].buffer=[],this.buffers[e].status=BUFFER_STATUS.CANCEL},startDataSource:function(e){this.buffers[e].status=BUFFER_STATUS.NOT_START_YET,this.buffers[e].lastRecordTime=Date.now()},startAll:function(){for(var e in this.buffers)this.startDataSource(e)},addDataSource:function(e,t){this.buffers[e]={buffer:[],syncMasterTime:!1,bufferingTime:INITIAL_BUFFERING_TIME,timeOut:3e3,lastRecordTime:Date.now(),status:BUFFER_STATUS.NOT_START_YET,name:"undefined"},"undefined"!=typeof t&&("undefined"!=typeof t.syncMasterTime&&(this.buffers[e].syncMasterTime=t.syncMasterTime),"undefined"!=typeof t.bufferingTime&&(this.buffers[e].bufferingTime=t.bufferingTime),"undefined"!=typeof t.timeOut&&(this.buffers[e].timeOut=t.timeOut),"undefined"!=typeof t.name&&(this.buffers[e].name=t.name))},addEntity:function(e,t){if("undefined"!=typeof e.dataSources)for(var i=0;i<e.dataSources.length;i++)this.addDataSource(e.dataSources[i],t)},push:function(e){var t=e.dataSourceId,i=this.buffers[t],n=i.syncMasterTime;n&&e.data.timeStamp<this.currentTime||i.status!=BUFFER_STATUS.CANCEL&&(i.status==BUFFER_STATUS.NOT_START_YET&&(i.startRelativeTime=e.data.timeStamp,i.startRelativeRealTime=(new Date).getTime(),i.status=BUFFER_STATUS.START),i.buffer.push(e.data),i.lastRecordTime=Date.now(),n||this.processData(i,t))},processSyncData:function(){if(!this.bufferingState){var e=null,t=null,i=MAX_LONG,n=null;for(var a in this.buffers)if(n=this.buffers[a],(n.status==BUFFER_STATUS.START||n.status==BUFFER_STATUS.NOT_START_YET)&&n.syncMasterTime)if(0===n.buffer.length){var o=n.timeOut-(Date.now()-n.lastRecordTime);if(o>0)return void window.setTimeout(function(){this.processSyncData()}.bind(this),o/10)}else n.buffer[0].timeStamp<i&&(e=n,t=a,i=n.buffer[0].timeStamp);null!==e?(this.currentTime=i,this.processData(e,t,function(){this.processSyncData()}.bind(this))):window.setTimeout(function(){this.processSyncData()}.bind(this),1e3)}},processData:function(e,t,i){var n=e.startRelativeTime,a=(new Date).getTime()-e.startRelativeRealTime,o=e.buffer.shift(),s=(o.timeStamp-n)/this.replayFactor-a;e.startRelativeTime=o.timeStamp,e.startRelativeRealTime=(new Date).getTime(),s>0?window.setTimeout(function(){this.dispatchData(t,o),"undefined"!=typeof i&&i()}.bind(this),s):(this.dispatchData(t,o),"undefined"!=typeof i&&i())},dispatchData:function(e,t){var i=this.buffers[e];i.status!=BUFFER_STATUS.CANCEL&&(i.syncMasterTime&&OSH.EventManager.fire(OSH.EventManager.EVENT.CURRENT_MASTER_TIME,{timeStamp:t.timeStamp}),OSH.EventManager.fire(OSH.EventManager.EVENT.DATA+"-"+e,{data:t}))},buffering:function(e,t){OSH.EventManager.fire(OSH.EventManager.EVENT.LOADING_START,{name:e}),this.bufferingState=!0,window.setTimeout(function(){this.bufferingState=!1,OSH.EventManager.fire(OSH.EventManager.EVENT.LOADING_STOP),this.processSyncData()}.bind(this),t)}});var observedEvent={};OSH.EventManager=function(){},OSH.EventManager.fire=function(e,t){document.fire("osh:"+e,t)},OSH.EventManager.observe=function(e,t,i){var n=function(e){"undefined"!=typeof t&&t(e.memo)};"undefined"!=typeof i&&(observedEvent[i]=n),document.observe("osh:"+e,n)},OSH.EventManager.stopObserving=function(e,t){"undefined"!=typeof t&&(document.stopObserving(e,observedEvent[t]),delete observedEvent[t])},OSH.EventManager.observeDiv=function(e,t,i){$(e).observe(t,function(e){"undefined"!=typeof i&&i(e)})},OSH.EventManager.EVENT={DATA:"data",SYNC_DATA:"syncData",SELECT_VIEW:"selectView",CONTEXT_MENU:"contextMenu",SHOW_VIEW:"showView",CONNECT_DATASOURCE:"connectDataSource",DISCONNECT_DATASOURCE:"disconnectDataSource",DATASOURCE_UPDATE_TIME:"updateDataSourceTime",CURRENT_MASTER_TIME:"currentMasterTime",UAV_TAKEOFF:"uav:takeoff",UAV_GOTO:"uav:goto",UAV_LOOKAT:"uav:lookat",UAV_LAND:"uav:land",UAV_ORBIT:"uav:orbit",LOADING_START:"loading:start",LOADING_STOP:"loading:stop",ADD_VIEW_ITEM:"addViewItem"},OSH.UI.ContextMenu.CircularMenu=Class.create(OSH.UI.ContextMenu.CssMenu,{initialize:function(e,t){e(t,"circular")}}),OSH.UI.ContextMenu.CssMenu=Class.create(OSH.UI.ContextMenu,{initialize:function(e,t,i){if(e(t),this.items=[],"undefined"!=typeof i?this.type=i:this.type="","undefined"!=typeof t&&"undefined"!=typeof t.items)for(var n=0;n<t.items.length;n++){var a=OSH.Utils.randomUUID(),o='<a  id="'+a+'" ';"undefined"!=typeof t.items[n].css&&(o+='class="'+t.items[n].css+'" ');var s="";"undefined"!=typeof t.items[n].name&&(s=t.items[n].name),o+='title="'+s+'"',o+='><span id ="'+a+'"class="'+this.type+'-menu-label">'+s+"</span></a>";var r="";"undefined"!=typeof t.items[n].action&&(r=t.items[n].action);var d="";"undefined"!=typeof t.items[n].viewId&&(d=t.items[n].viewId),this.items.push({html:o,id:a,action:r,viewId:d})}},show:function(e,t){this.removeElement();var i=OSH.Utils.randomUUID(),n=(OSH.Utils.randomUUID(),"");n+='<div class="'+this.type+'-menu">',n+='  <div class="'+this.type+'-menu-circle">';for(var a=0;a<this.items.length;a++)n+=this.items[a].html;n+="  </div>",n+='  <a id="'+i+'"class="'+this.type+'-menu-button fa fa-times fa-2x"></a>',n+="</div>",this.rootTag=document.createElement("div"),this.rootTag.setAttribute("class",""+this.type+"-menu-container"),this.rootTag.innerHTML=n,document.body.appendChild(this.rootTag);for(var o=document.querySelectorAll("."+this.type+"-menu-circle a"),a=0,s=o.length;a<s;a++)o[a].style.left=(50-35*Math.cos(-.5*Math.PI-2*(1/s)*a*Math.PI)).toFixed(4)+"%",o[a].style.top=(50+35*Math.sin(-.5*Math.PI-2*(1/s)*a*Math.PI)).toFixed(4)+"%";$(i).on("click",this.hide.bind(this));var r=0,d=0;t.offsetX&&(r=t.offsetX),t.offsetY&&(d=t.offsetY),document.querySelector("."+this.type+"-menu-circle").classList.toggle("open"),"undefined"!=typeof t.x&&(this.rootTag.style.left=t.x+r),"undefined"!=typeof t.y&&(this.rootTag.style.top=t.y+d),this.bindEvents={};for(var a=0;a<this.items.length;a++){var l=this.items[a];this.bindEvents[l.id]=l.viewId,$(l.id).on("click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SHOW_VIEW,{viewId:this.bindEvents[e.target.id]})}.bind(this))}},hide:function(e){document.querySelector("."+this.type+"-menu-circle").classList.toggle("open"),this.removeElement()},removeElement:function(){"undefined"!=typeof this.rootTag&&null!=this.rootTag&&"undefined"!=typeof this.rootTag.parentNode&&(this.rootTag.parentNode.removeChild(this.rootTag),this.rootTag=null)},getTransform:function(e){var t=e.style.transform;if(!t||0===t.length)return"";var i=/^\s*((\w+)\s*\(([^)]+)\))/,n=i.exec(t);return n[1]}}),OSH.UI.ContextMenu.StackMenu=Class.create(OSH.UI.ContextMenu.CssMenu,{initialize:function(e,t){e(t,"stack")},show:function(e,t){this.removeElement();var i="";i+='  <div class="'+this.type+'-menu-circle">';for(var n=0;n<this.items.length;n++)i+=this.items[n].html;i+="  </div>",this.rootTag=document.createElement("div"),this.rootTag.setAttribute("class",""+this.type+"-menu-container"),
this.rootTag.innerHTML=i,document.body.appendChild(this.rootTag);var a=0,o=0;t.offsetX&&(a=t.offsetX),t.offsetY&&(o=t.offsetY),"undefined"!=typeof t.x&&(this.rootTag.style.left=t.x+a),"undefined"!=typeof t.y&&(this.rootTag.style.top=t.y+o),document.querySelector("."+this.type+"-menu-circle").classList.toggle("open"),this.bindEvents={};for(var n=0;n<this.items.length;n++){var s=this.items[n];this.bindEvents[s.id]=s.viewId,$(s.id).on("click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SHOW_VIEW,{viewId:this.bindEvents[e.target.id]})}.bind(this))}}}),OSH.UI.ContextMenu=Class.create({initialize:function(e){"undefined"!=typeof e&&"undefined"!=typeof e.id?this.id=e.id:this.id="contextMenu-"+OSH.Utils.randomUUID(),this.handleEvents()},show:function(){},hide:function(){},handleEvents:function(){OSH.EventManager.observe(OSH.EventManager.EVENT.CONTEXT_MENU+"-"+this.id,function(e){"show"==e.action?this.show(e):"hide"==e.action&&this.hide()}.bind(this))}}),OSH.UI.View=Class.create({initialize:function(e,t,i){this.stylers=[],this.contextMenus=[],this.viewItems=[],this.names={},this.stylerToObj={},this.stylerIdToStyler={},this.lastRec={},this.selectedDataSources=[],this.dataSources=[],this.id="view-"+OSH.Utils.randomUUID(),this.dataSourceId=-1,"undefined"!=typeof i&&"undefined"!=typeof i.dataSourceId&&(this.dataSourceId=i.dataSourceId),"undefined"!=typeof i&&"undefined"!=typeof i.entityId&&(this.entityId=i.entityId),this.css="",this.cssSelected="","undefined"!=typeof i&&"undefined"!=typeof i.css&&(this.css=i.css),"undefined"!=typeof i&&"undefined"!=typeof i.cssSelected&&(this.cssSelected=i.cssSelected),this.init(e,t,i)},init:function(e,t,i){this.elementDiv=document.createElement("div"),this.elementDiv.setAttribute("id",this.id),this.elementDiv.setAttribute("class",this.css),this.divId=this.id;var n=document.getElementById(e);if(null==e||"undefined"==n||null==n||""==e?(document.body.appendChild(this.elementDiv),this.hide(),this.container=document.body):(n.appendChild(this.elementDiv),this.container=n),this.beforeAddingItems(i),"undefined"!=typeof t)for(var a=0;a<t.length;a++)this.addViewItem(t[a]);"undefined"!=typeof i&&"undefined"!=typeof i.show&&(document.getElementById(this.divId).style.display=i.show?"block":"none"),this.handleEvents(),"undefined"!=typeof i&&"undefined"!=typeof i.dataSourceId&&OSH.EventManager.observe(OSH.EventManager.EVENT.DATA+"-"+i.dataSourceId,function(e){e.reset?this.reset():this.setData(i.dataSourceId,e.data)}.bind(this));var o=this,s=new MutationObserver(function(e){e.forEach(function(e){"style"===e.attributeName&&o.onResize()})});s.observe(this.elementDiv,{attributes:!0})},hide:function(){this.elementDiv.style.display="none"},onResize:function(){},attachTo:function(e){"undefined"!=typeof this.elementDiv.parentNode&&this.elementDiv.parentNode.removeChild(this.elementDiv),document.getElementById(e).appendChild(this.elementDiv),"none"==this.elementDiv.style.display&&(this.elementDiv.style.display="block")},beforeAddingItems:function(e){},getId:function(){return this.id},getDivId:function(){return this.divId},setData:function(e,t){},show:function(e){},shows:function(e){},addViewItem:function(e){if(this.viewItems.push(e),e.hasOwnProperty("styler")){var t=e.styler;this.stylers.push(t),e.hasOwnProperty("name")&&(this.names[t.getId()]=e.name),t.init(this),t.viewItem=e,this.stylerIdToStyler[t.id]=t}e.hasOwnProperty("contextmenu")&&this.contextMenus.push(e.contextmenu);for(var i=t.getDataSourcesIds(),n=0;n<i.length;n++){var a=i[n],o=this;!function(i){OSH.EventManager.observe(OSH.EventManager.EVENT.DATA+"-"+i,function(n){if(!n.reset){var a=!1;a="undefined"!=typeof o.selectedEntity?e.entityId==o.selectedEntity:o.selectedDataSources.indexOf(i)>-1,t.setData(i,n.data,o,{selected:a}),o.lastRec[i]=n.data}}),OSH.EventManager.observe(OSH.EventManager.EVENT.SELECT_VIEW,function(n){var a=!1;a="undefined"!=typeof n.entityId?e.entityId==n.entityId:n.dataSourcesIds.indexOf(i)>-1,i in o.lastRec&&t.setData(i,o.lastRec[i],o,{selected:a})})}(a)}},handleEvents:function(){OSH.EventManager.observe(OSH.EventManager.EVENT.SELECT_VIEW,function(e){this.selectDataView(e.dataSourcesIds,e.entityId)}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.SHOW_VIEW,function(e){this.show(e)}.bind(this)),OSH.EventManager.observe(OSH.EventManager.EVENT.ADD_VIEW_ITEM,function(e){"undefined"!=typeof e.viewId&&e.viewId==this.id&&this.addViewItem(e.viewItem)}.bind(this))},selectDataView:function(e,t){if("undefined"!=typeof this.dataSources){this.selectedDataSources=e,this.selectedEntity=t;for(var i=0;i<this.dataSources.length;i++)this.setData(this.dataSources[i],this.lastRec[this.dataSources[i]])}},getDataSourcesId:function(){var e=[];this.dataSourceId!=-1&&e.push(this.dataSourceId);for(var t=0;t<this.viewItems.length;t++){var i=this.viewItems[t];if(i.hasOwnProperty("styler")){var n=i.styler;e=e.concat(n.getDataSourcesIds())}}return e},reset:function(){}}),OSH.UI.Styler=Class.create({initialize:function(e){this.properties=e,this.id="styler-"+OSH.Utils.randomUUID(),this.dataSourceToStylerMap={},this.initEvents()},initEvents:function(){OSH.EventManager.observe(OSH.EventManager.EVENT.DATASOURCE_UPDATE_TIME,function(e){this.clear()}.bind(this))},clear:function(){},setData:function(e,t,i){},getId:function(){return this.id},select:function(e){},addFn:function(e,t){for(var i=0;i<e.length;i++){var n=e[i];"undefined"==typeof this.dataSourceToStylerMap[n]&&(this.dataSourceToStylerMap[n]=[]),this.dataSourceToStylerMap[n].push(t)}},setData:function(e,t,i,n){if(e in this.dataSourceToStylerMap){for(var a=this.dataSourceToStylerMap[e],o=0;o<a.length;o++)a[o](t.data,t.timeStamp,n);return!0}return!1},getDataSourcesIds:function(){var e=[];for(var t in this.dataSourceToStylerMap)e.push(t);return e},init:function(){}}),OSH.UI.Styler.Curve=Class.create(OSH.UI.Styler,{initialize:function(e,t){if(e(t),this.xLabel="",this.yLabel="",this.color="#000000",this.stroke=1,this.x=0,this.y=[],"undefined"!=typeof t.stroke&&(this.stroke=t.stroke),"undefined"!=typeof t.color&&(this.color=t.color),"undefined"!=typeof t.x&&(this.x=t.x),"undefined"!=typeof t.y&&(this.y=t.y),"undefined"!=typeof t.strokeFunc){var i=function(e,i,n){this.stroke=t.strokeFunc.handler(e,i,n)}.bind(this);this.addFn(t.strokeFunc.dataSourceIds,i)}if("undefined"!=typeof t.colorFunc){var i=function(e,i,n){this.color=t.colorFunc.handler(e,i,n)}.bind(this);this.addFn(t.colorFunc.dataSourceIds,i)}if("undefined"!=typeof t.valuesFunc){var i=function(e,i,n){var a=t.valuesFunc.handler(e,i,n);this.x=a.x,this.y=a.y}.bind(this);this.addFn(t.valuesFunc.dataSourceIds,i)}},setData:function(e,t,i,n,a){e(t,i,n,a)&&"undefined"!=typeof n&&n.updateCurve(this,i.timeStamp,a)}}),OSH.UI.Styler.ImageDraping=Class.create(OSH.UI.Styler,{initialize:function(e,t){if(e(t),this.properties=t,this.platformLocation=null,this.platformOrientation=null,this.gimbalOrientation=null,this.cameraModel=null,this.imageSrc=null,this.snapshotFunc=null,this.options={},"undefined"!=typeof t.platformLocation&&(this.platformLocation=t.platformLocation),"undefined"!=typeof t.platformOrientation&&(this.platformOrientation=t.platformOrientation),"undefined"!=typeof t.gimbalOrientation&&(this.gimbalOrientation=t.gimbalOrientation),"undefined"!=typeof t.cameraModel&&(this.cameraModel=t.cameraModel),"undefined"!=typeof t.imageSrc&&(this.imageSrc=t.imageSrc),"undefined"!=typeof t.platformLocationFunc){var i=function(e,i,n){this.platformLocation=t.platformLocationFunc.handler(e,i,n)}.bind(this);this.addFn(t.platformLocationFunc.dataSourceIds,i)}if("undefined"!=typeof t.platformOrientationFunc){var i=function(e,i,n){this.platformOrientation=t.platformOrientationFunc.handler(e,i,n)}.bind(this);this.addFn(t.platformOrientationFunc.dataSourceIds,i)}if("undefined"!=typeof t.gimbalOrientationFunc){var i=function(e,i,n){this.gimbalOrientation=t.gimbalOrientationFunc.handler(e,i,n)}.bind(this);this.addFn(t.gimbalOrientationFunc.dataSourceIds,i)}if("undefined"!=typeof t.cameraModelFunc){var i=function(e,i,n){this.cameraModel=t.cameraModelFunc.handler(e,i,n)}.bind(this);this.addFn(t.cameraModelFunc.dataSourceIds,i)}"undefined"!=typeof t.snapshotFunc&&(this.snapshotFunc=t.snapshotFunc)},init:function(e,t){e(t)},setData:function(e,t,i,n,a){if(e(t,i,n,a)){var o=!0;null!=this.snapshotFunc&&(o=this.snapshotFunc()),"undefined"!=typeof n&&o&&null!=this.platformLocation&&null!=this.platformOrientation&&null!=this.gimbalOrientation&&null!=this.cameraModel&&null!=this.imageSrc&&n.updateDrapedImage(this,i.timeStamp,a)}}}),OSH.UI.Styler.Nexrad=Class.create(OSH.UI.Styler,{initialize:function(e,t){if(e(t),this.properties=t,this.location=null,this.radialData=null,this.options={},"undefined"!=typeof t.location&&(this.location=t.location),"undefined"!=typeof t.radialData&&(this.radialData=t.radialData),"undefined"!=typeof t.locationFunc){var i=function(e,i,n){this.location=t.locationFunc.handler(e,i,n)}.bind(this);this.addFn(t.locationFunc.dataSourceIds,i)}if("undefined"!=typeof t.radialDataFunc){var i=function(e,i,n){this.radialData=t.radialDataFunc.handler(e,i,n)}.bind(this);this.addFn(t.radialDataFunc.dataSourceIds,i)}this.reflectivityColorMap=[Cesium.Color.fromBytes(100,100,100),Cesium.Color.fromBytes(204,255,255),Cesium.Color.fromBytes(204,153,204),Cesium.Color.fromBytes(153,102,153),Cesium.Color.fromBytes(102,51,102),Cesium.Color.fromBytes(204,204,153),Cesium.Color.fromBytes(153,153,102),Cesium.Color.fromBytes(100,100,100),Cesium.Color.fromBytes(4,233,231),Cesium.Color.fromBytes(1,159,244),Cesium.Color.fromBytes(3,0,244),Cesium.Color.fromBytes(2,253,2),Cesium.Color.fromBytes(1,197,1),Cesium.Color.fromBytes(0,142,0),Cesium.Color.fromBytes(253,248,2),Cesium.Color.fromBytes(229,188,0),Cesium.Color.fromBytes(253,149,0),Cesium.Color.fromBytes(253,0,0),Cesium.Color.fromBytes(212,0,0),Cesium.Color.fromBytes(188,0,0),Cesium.Color.fromBytes(248,0,253),Cesium.Color.fromBytes(152,84,198),Cesium.Color.fromBytes(253,253,253)],this.pointCollection=new Cesium.PointPrimitiveCollection,this.radialCount=0},init:function(e,t){e(t)},setData:function(e,t,i,n,a){if(e(t,i,n,a)&&"undefined"!=typeof n){var o=Math.PI/180;if(i.data.elevation>.7)return;for(var s=Cesium.Cartesian3.fromDegrees(this.location.x,this.location.y,this.location.z),r=Cesium.Transforms.headingPitchRollQuaternion(s,(i.data.azimuth-90)*o,i.data.elevation*o,0),d=Cesium.Matrix3.fromQuaternion(r),l=(new Cesium.PointPrimitiveCollection,i.data.rangeToCenterOfFirstRefGate),c=i.data.refGateSize,u=0;u<i.data.reflectivity.length;u++){var h=i.data.reflectivity[u];if(!(h<-32||h>94.5)){var f=new Cesium.Cartesian3(l+u*c,0,0);Cesium.Matrix3.multiplyByVector(d,f,f),this.pointCollection.add({position:Cesium.Cartesian3.add(s,f,f),color:this.getReflectivityColor(h),pixelSize:3})}}this.radialCount++,100==this.radialCount&&(n.viewer.scene.primitives.add(this.pointCollection),this.pointCollection=new Cesium.PointPrimitiveCollection,this.radialCount=0)}},getReflectivityColor:function(e){var t=Math.floor((e+30)/5)+1;return this.reflectivityColorMap[t]}}),OSH.UI.Styler.PointMarker=Class.create(OSH.UI.Styler,{initialize:function(e,t){if(e(t),this.properties=t,this.location=null,this.orientation={heading:0},this.icon=null,this.iconAnchor=[16,16],this.label=null,this.color="#000000",this.options={},"undefined"!=typeof t.location&&(this.location=t.location),"undefined"!=typeof t.orientation&&(this.orientation=t.orientation),"undefined"!=typeof t.icon&&(this.icon=t.icon),"undefined"!=typeof t.iconAnchor&&(this.iconAnchor=t.iconAnchor),"undefined"!=typeof t.label&&(this.label=t.label),"undefined"!=typeof t.color&&(this.color=t.color),"undefined"!=typeof t.locationFunc){var i=function(e,i,n){this.location=t.locationFunc.handler(e,i,n)}.bind(this);this.addFn(t.locationFunc.dataSourceIds,i)}if("undefined"!=typeof t.orientationFunc){var i=function(e,i,n){this.orientation=t.orientationFunc.handler(e,i,n)}.bind(this);this.addFn(t.orientationFunc.dataSourceIds,i)}if("undefined"!=typeof t.iconFunc){var i=function(e,i,n){this.icon=t.iconFunc.handler(e,i,n)}.bind(this);this.addFn(t.iconFunc.dataSourceIds,i)}if("undefined"!=typeof t.labelFunc){var i=function(e,i,n){this.label=t.labelFunc.handler(e,i,n)}.bind(this);this.addFn(t.labelFunc.dataSourceIds,i)}if("undefined"!=typeof t.colorFunc){var i=function(e,i,n){this.color=t.colorFunc.handler(e,i,n)}.bind(this);this.addFn(t.colorFunc.dataSourceIds,i)}},init:function(e,t){e(t),"undefined"!=typeof t&&null!=this.location&&t.updateMarker(this,0,{})},setData:function(e,t,i,n,a){e(t,i,n,a)&&"undefined"!=typeof n&&null!=this.location&&n.updateMarker(this,i.timeStamp,a)},clear:function(e){}}),OSH.UI.Styler.Polyline=Class.create(OSH.UI.Styler,{initialize:function(e,t){if(e(t),this.properties=t,this.locations=[],this.color="red",this.weight=1,this.opacity=1,this.smoothFactor=1,this.maxPoints=10,"undefined"!=typeof t.color&&(this.color=t.color),"undefined"!=typeof t.weight&&(this.weight=t.weight),"undefined"!=typeof t.opacity&&(this.opacity=t.opacity),"undefined"!=typeof t.smoothFactor&&(this.smoothFactor=t.smoothFactor),"undefined"!=typeof t.maxPoints&&(this.maxPoints=t.maxPoints),"undefined"!=typeof t.locationFunc){var i=function(e){var i=t.locationFunc.handler(e);this.locations.push(i),this.locations.length>this.maxPoints&&this.locations.shift()}.bind(this);this.addFn(t.locationFunc.dataSourceIds,i)}if("undefined"!=typeof t.colorFunc){var i=function(e){this.color=t.colorFunc.handler(e)}.bind(this);this.addFn(t.colorFunc.dataSourceIds,i)}if("undefined"!=typeof t.weightFunc){var i=function(e){this.weight=t.weightFunc.handler(e)}.bind(this);this.addFn(t.weightFunc.dataSourceIds,i)}if("undefined"!=typeof t.opacityFunc){var i=function(e){this.opacity=t.opacityFunc.handler(e)}.bind(this);this.addFn(t.opacityFunc.dataSourceIds,i)}if("undefined"!=typeof t.smoothFactorFunc){var i=function(e){this.smoothFactor=t.smoothFactorFunc.handler(e)}.bind(this);this.addFn(t.smoothFactorFunc.dataSourceIds,i)}},setData:function(e,t,i,n,a){e(t,i,n,a)&&"undefined"!=typeof n&&"function"==typeof n.updatePolyline&&n.updatePolyline(this)},clear:function(e){this.locations=[]}}),OSH.UI.Nvd3CurveChartView=Class.create(OSH.UI.View,{initialize:function(e,t,i,n){e(t,i,n),this.entityId=n.entityId;var a="Time",o="yLabel",s=null,r=d3.format(".02f"),d=!0,l=!0,c=!0,u=!0,h=1;if("undefined"!=typeof n){if(n.xLabel)var a=n.xLabel;if(n.yLabel)var o=n.yLabel;n.xTickFormat&&(s=n.xTickFormat),n.yTickFormat&&(r=n.yTickFormat),n.showLegend&&(l=n.showLegend),n.showXAxis&&(u=n.showXAxis),n.showYAxis&&(c=n.showYAxis),n.useInteractiveGuideline&&(d=n.useInteractiveGuideline),n.transitionDuration&&(h=n.transitionDuration),n.maxPoints&&(this.maxPoints=n.maxPoints)}this.chart=nv.models.lineChart().margin({left:75,right:25}).options({duration:1,useInteractiveGuideline:d}).duration(1).showLegend(l).showYAxis(c).showXAxis(u),this.chart.xAxis.axisLabel(a).tickFormat(function(e){return d3.time.format.utc("%H:%M:%SZ")(new Date(e))}),this.chart.yAxis.axisLabel(o).tickFormat(d3.format(".02f")).axisLabelDistance(15),this.css=document.getElementById(this.divId).className,"undefined"!=typeof n&&(n.css&&(this.css+=" "+n.css),n.cssSelected&&(this.cssSelected=n.cssSelected));var f=document.createElementNS(d3.ns.prefix.svg,"svg");this.div=document.getElementById(this.divId),this.div.appendChild(f),this.div.style.width=this.width,this.div.style.height=this.height,this.svgChart=d3.select("#"+this.divId+" svg");var m=this;OSH.EventManager.observeDiv(this.divId,"click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:m.getDataSourcesId(),entityId:m.entityId})})},updateCurve:function(e,t,i){if("undefined"==typeof this.data){this.d3Data=[];i.name;this.data={values:[],key:this.names[e.getId()],interpolate:"cardinal",area:!0},this.data.values.push({y:e.y,x:e.x}),this.svgChart.datum([this.data]).call(this.chart)}else this.data.values.push({y:e.y,x:e.x});this.chart.update(),this.data.values.length>this.maxPoints&&this.data.values.shift()},selectDataView:function(e,t){var i=this.getDataSourcesId();OSH.Utils.isArrayIntersect(t,i)?this.div.setAttribute("class",this.css+" "+this.cssSelected):this.div.setAttribute("class",this.css)},reset:function(){this.data.values=[],this.chart.update()}}),OSH.UI.DiscoveryView=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i),this.swapId="","undefined"!=typeof i&&("undefined"!=typeof i.dataReceiverController?this.dataReceiverController=i.dataReceiverController:(this.dataReceiverController=new OSH.DataReceiver.DataReceiverController({replayFactor:1}),this.dataReceiverController.connectAll()),"undefined"!=typeof i.swapId&&(this.swapId=i.swapId)),this.formTagId="form-"+OSH.Utils.randomUUID(),this.serviceSelectTagId="service-"+OSH.Utils.randomUUID(),this.offeringSelectTagId="offering-"+OSH.Utils.randomUUID(),this.observablePropertyTagId="obsProperty-"+OSH.Utils.randomUUID(),this.startTimeTagId="startTime-"+OSH.Utils.randomUUID(),this.endTimeTagId="endTime-"+OSH.Utils.randomUUID(),this.typeSelectTagId="type-"+OSH.Utils.randomUUID(),this.formButtonId="submit-"+OSH.Utils.randomUUID(),this.syncMasterTimeId="syncMasterTime-"+OSH.Utils.randomUUID(),this.entitiesSelectTagId="entities-"+OSH.Utils.randomUUID(),this.viewSelectTagId="dialogSelect-"+OSH.Utils.randomUUID();var n=document.createElement("form");n.setAttribute("action","#"),n.setAttribute("id",this.formTagId),n.setAttribute("class","discovery-form"),document.getElementById(this.divId).appendChild(n);var a="";a+="<ul>",a+="            <li>",a+="                <h2>Discovery</h2>",a+='                <span class="required_notification">* Denotes Required Field</span>',a+="            </li>",a+="            <li>",a+="                <label>Service:</label>",a+='                <div class="select-style">',a+='                     <select id="'+this.serviceSelectTagId+'" required pattern="^(?!Select a service$).*">',a+='                         <option value="" disabled selected>Select a service</option>',a+="                     </select>",a+="                </div>",a+="            </li>",a+="            <li>",a+="                <label>Offering:</label>",a+='                <div class="select-style">',a+='                    <select id="'+this.offeringSelectTagId+'" required>',a+='                        <option value="" disabled selected>Select an offering</option>',a+="                    </select>",a+="                </div>",a+="            </li>",a+="            <li>",a+="                <label>Observable Property:</label>",a+='                <div class="select-style">',a+='                     <select id="'+this.observablePropertyTagId+'" required>',a+='                         <option value="" disabled selected>Select a property</option>',a+="                     </select>",a+="                </div>",a+="            </li>",a+="            <li>",a+='                <label for="startTime">Start time:</label>',a+='                <input id="'+this.startTimeTagId+'" type="text" name="startTime" class="input-text" placeholder="YYYY-MM-DDTHH:mm:ssZ" required/>',a+='                <span class="form_hint">YYYY-MM-DDTHH:mm:ssZ</span>',a+="            </li>",a+="            <li>",a+='                <label for="endTime">End time:</label>',a+='                <input id="'+this.endTimeTagId+'" type="text" name="endTime" class="input-text" placeholder="YYYY-MM-DDTHH:mm:ssZ"  required/>',a+='                <span class="form_hint">YYYY-MM-DDTHH:mm:ssZ</span>',a+="            </li>",a+="            <li>",a+='                <label for="syncMasterTime">Sync master time:</label>',a+='                <input id="'+this.syncMasterTimeId+'"  class="input-checkbox" type="checkbox" name=syncMasterTime" />',a+="            </li>",a+="            <li>",a+="                <label>Type:</label>",a+='                <div class="select-style">',a+='                    <select id="'+this.typeSelectTagId+'" required>',a+='                        <option value="" disabled selected>Select a type</option>',a+="                    </select>",a+="                </div>",a+="            </li>",a+="            <li>",a+="                <label>Entities:</label>",a+='                <div class="select-style">',a+='                    <select id="'+this.entitiesSelectTagId+'">',a+='                        <option value="" selected>None</option>',a+="                    </select>",a+="                </div>",a+="            </li>",a+="            <li>",a+="                <label>View:</label>",a+='                <div class="select-style">',a+='                    <select id="'+this.viewSelectTagId+'" required>',a+='                        <option value="" disabled selected>Select a view</option>',a+="                    </select>",a+="                </div>",a+="            </li>",a+="            <li>",a+='                <button id="'+this.formButtonId+'" class="submit" type="submit">Add</button>',a+="            </li>",a+="        </ul>",n.innerHTML=a,"undefined"!=typeof i&&("undefined"!=typeof i.services&&this.addValuesToSelect(this.serviceSelectTagId,i.services),"undefined"!=typeof i.entities&&this.addObjectsToSelect(this.entitiesSelectTagId,i.entities),"undefined"!=typeof i.views?this.views=i.views:this.views=[]);for(var o in OSH.UI.DiscoveryView.Type)this.addValueToSelect(this.typeSelectTagId,OSH.UI.DiscoveryView.Type[o]);OSH.EventManager.observeDiv(this.serviceSelectTagId,"change",this.onSelectedService.bind(this)),OSH.EventManager.observeDiv(this.offeringSelectTagId,"change",this.onSelectedOffering.bind(this)),OSH.EventManager.observeDiv(this.typeSelectTagId,"change",this.onSelectedType.bind(this)),OSH.EventManager.observeDiv(this.formTagId,"submit",this.onFormSubmit.bind(this))},onSelectedService:function(e){var t=document.getElementById(this.serviceSelectTagId),i=t.options[t.selectedIndex],n=new OSH.Server(i.value),a=function(e){this.sensors=n.sensors,this.removeAllFromSelect(this.offeringSelectTagId);for(var t=(document.getElementById(this.startTimeTagId),document.getElementById(this.endTimeTagId),0);t<this.sensors.length;t++)this.addValueToSelect(this.offeringSelectTagId,this.sensors[t].identifier,this.sensors[t])}.bind(this),o=function(e){};n.getCapabilities(a,o)},onSelectedOffering:function(e){var t=document.getElementById(this.offeringSelectTagId),i=t.options[t.selectedIndex];this.removeAllFromSelect(this.observablePropertyTagId);for(var n=document.getElementById(this.startTimeTagId),a=document.getElementById(this.endTimeTagId),o=0;o<i.parent.observableProperties.length;o++)this.addValueToSelect(this.observablePropertyTagId,i.parent.observableProperties[o]),n.value=i.parent.timeRangeStart,a.value=i.parent.timeRangeEnd},onSelectedType:function(e){var t=document.getElementById(this.typeSelectTagId),i=t.value;this.removeAllFromSelect(this.viewSelectTagId);for(var n=0;n<this.views.length;n++){var a=this.views[n];"undefined"!=typeof a.type&&a.type==i&&this.addValueToSelect(this.viewSelectTagId,a.name,void 0,a)}},onFormSubmit:function(e){e.preventDefault();var t=document.getElementById(this.serviceSelectTagId),i=t.options[t.selectedIndex],n=document.getElementById(this.offeringSelectTagId),a=n.options[n.selectedIndex],o=document.getElementById(this.observablePropertyTagId),s=o.options[o.selectedIndex],r=document.getElementById(this.startTimeTagId),d=document.getElementById(this.endTimeTagId),l=document.getElementById(this.syncMasterTimeId),c=(document.getElementById(this.typeSelectTagId),document.getElementById(this.viewSelectTagId)),u=c.options[c.selectedIndex],h=document.getElementById(this.entitiesSelectTagId),f=h.options[h.selectedIndex],m=a.parent.name,p=i.value+"sensorhub/sos",v=a.value,g=s.value,S=r.value,y=d.value,b=(u.object.viewId,void 0);"undefined"!=typeof f.object&&(b=f.object.id),p=p.replace("http://","");var I=l.checked;switch(u.object.type){case OSH.UI.DiscoveryView.Type.DIALOG_VIDEO_MJPEG:this.createMJPEGVideoDialog(m,p,v,g,S,y,I,b);break;case OSH.UI.DiscoveryView.Type.DIALOG_VIDEO_H264:this.createH264VideoDialog(m,p,v,g,S,y,I,b);break;case OSH.UI.DiscoveryView.Type.MARKER_GPS:this.createGPSMarker(m,p,v,g,S,y,I,u.object.viewId,b);break;case OSH.UI.DiscoveryView.Type.DIALOG_CHART:this.createChartDialog(m,p,v,g,S,y,I,b)}return!1},addObjectsToSelect:function(e,t){for(var i=document.getElementById(e),n=0;n<t.length;n++){var a=t[n],o=document.createElement("option");o.text=a.name,o.value=a.name,o.object=a,i.add(o)}},addValuesToSelect:function(e,t){for(var i=document.getElementById(e),n=0;n<t.length;n++){var a=t[n],o=document.createElement("option");o.text=a,o.value=a,i.add(o)}},addValueToSelect:function(e,t,i,n){var a=document.getElementById(e),o=document.createElement("option");o.text=t,o.value=t,"undefined"!=typeof i&&(o.parent=i),"undefined"!=typeof n&&(o.object=n),a.add(o)},removeAllFromSelect:function(e){var t,i=document.getElementById(e);for(t=i.options.length-1;t>0;t--)i.remove(t)},createGPSMarker:function(e,t,i,n,a,o,s,r,d){var l=new OSH.DataReceiver.LatLonAlt(e,{protocol:"ws",service:"SOS",endpointUrl:t,offeringID:i,observedProperty:n,startTime:a,endTime:o,replaySpeed:1,syncMasterTime:s,bufferingTime:1e3,timeShift:-16e3}),c=new OSH.UI.Styler.PointMarker({locationFunc:{dataSourceIds:[l.id],handler:function(e){return{x:e.lon,y:e.lat,z:e.alt}}},icon:"images/cameralook.png",iconFunc:{dataSourceIds:[l.getId()],handler:function(e,t,i){return i.selected?"images/cameralook-selected.png":"images/cameralook.png"}}});this.dataReceiverController.addDataSource(l);var u={styler:c,name:e};"undefined"!=typeof d&&(u.entityId=d),OSH.EventManager.fire(OSH.EventManager.EVENT.ADD_VIEW_ITEM,{viewItem:u,viewId:r}),OSH.EventManager.fire(OSH.EventManager.EVENT.CONNECT_DATASOURCE,{dataSourcesId:[l.id]})},createMJPEGVideoDialog:function(e,t,i,n,a,o,s,r){var d=new OSH.DataReceiver.VideoMjpeg(e,{protocol:"ws",service:"SOS",endpointUrl:t,offeringID:i,observedProperty:n,startTime:a,endTime:o,replaySpeed:1,syncMasterTime:s,bufferingTime:1e3}),l=new OSH.UI.DialogView("dialog-main-container",{draggable:!1,css:"dialog",name:e,show:!0,dockable:!0,closeable:!0,connectionIds:[d.id],swapId:this.swapId});new OSH.UI.MjpegView(l.popContentDiv.id,{dataSourceId:d.id,css:"video",cssSelected:"video-selected",name:"Android Video",entityId:r});this.dataReceiverController.addDataSource(d),OSH.EventManager.fire(OSH.EventManager.EVENT.CONNECT_DATASOURCE,{dataSourcesId:[d.id]})},createH264VideoDialog:function(e,t,i,n,a,o,s,r){var d=new OSH.DataReceiver.VideoH264(e,{protocol:"ws",service:"SOS",endpointUrl:t,offeringID:i,observedProperty:n,startTime:a,endTime:o,replaySpeed:1,syncMasterTime:s,bufferingTime:1e3}),l=new OSH.UI.DialogView("dialog-main-container",{draggable:!1,css:"dialog",name:e,show:!0,dockable:!0,closeable:!0,connectionIds:[d.id],swapId:this.swapId});new OSH.UI.FFMPEGView(l.popContentDiv.id,{dataSourceId:d.getId(),css:"video",cssSelected:"video-selected",name:"Android Video",entityId:r});this.dataReceiverController.addDataSource(d),OSH.EventManager.fire(OSH.EventManager.EVENT.CONNECT_DATASOURCE,{dataSourcesId:[d.id]})},createChartDialog:function(e,t,i,n,a,o,s,r){var d=new OSH.DataReceiver.Chart(e,{protocol:"ws",service:"SOS",endpointUrl:t,offeringID:i,observedProperty:n,startTime:a,endTime:o,replaySpeed:1,syncMasterTime:s,bufferingTime:1e3}),l=new OSH.UI.DialogView("dialog-main-container",{draggable:!1,css:"dialog",name:e,show:!0,dockable:!0,closeable:!0,connectionIds:[d.id],swapId:this.swapId});new OSH.UI.Nvd3CurveChartView(l.popContentDiv.id,[{styler:new OSH.UI.Styler.Curve({valuesFunc:{dataSourceIds:[d.getId()],handler:function(e,t){return{x:t,y:parseFloat(e[2])}}}})}],{name:e,yLabel:"",xLabel:"",css:"chart-view",cssSelected:"video-selected",maxPoints:30});this.dataReceiverController.addDataSource(d),OSH.EventManager.fire(OSH.EventManager.EVENT.CONNECT_DATASOURCE,{dataSourcesId:[d.id]})}}),OSH.UI.DiscoveryView.Type={MARKER_GPS:"Marker(GPS)",DIALOG_VIDEO_H264:"Video Dialog(H264)",DIALOG_VIDEO_MJPEG:"Video Dialog(MJPEG)",DIALOG_CHART:"Chart Dialog"},OSH.UI.EntityTreeView=Class.create(OSH.UI.View,{initialize:function(e,t,i,n){e(t,[],n),this.entityItems=i,this.initTree(n)},initTree:function(e){this.tree=createTree(this.divId,"white",null);for(var t=0;t<this.entityItems.length;t++){var i=this.entityItems[t],a=i.entity,o=i.path,s=i.treeIcon,r=i.contextMenuId;o.endsWith("/")&&(o=o.substring(0,o.length-1));for(var d=o.split("/"),l=d.length,c=this.tree,u=0;l>0;){var h=null;for(n=0;n<c.childNodes.length;n++){var f=c.childNodes[n];if(f.text===d[u]){h=f;break}}c=null==h?c===this.tree?this.tree.createNode(d[u],!1,"",this.tree,null,null):c.createChildNode(d[u],!1,"",null,null):h,u++,l--}var m;m=c===this.tree?this.tree.createNode(a.name,!1,s,this.tree,a,r):c.createChildNode(a.name,!1,s,a,r),i.node=m}this.tree.drawTree()},selectDataView:function(e,t){if("undefined"!=typeof t)for(var i=0;i<this.entityItems.length;i++){var n=this.entityItems[i];if(n.entity.id===t){this.tree.selectNode(n.node,!1);for(var a=n.node.parent;a!=this.tree;)this.tree.expandNode(a),a=a.parent}}}}),OSH.UI.CesiumView=Class.create(OSH.UI.View,{initialize:function(e,t,i,n){e(t,i,n);var a=document.getElementById(this.divId).className;document.getElementById(this.divId).setAttribute("class",a+" "+this.css),this.imageDrapingPrimitive=null,this.frameCount=0},updateMarker:function(e,t,i){var n=0;e.getId()in this.stylerToObj?n=this.stylerToObj[e.getId()]:(n=this.addMarker({lat:e.location.y,lon:e.location.x,alt:e.location.z,orientation:e.orientation,color:e.color,icon:e.icon,label:e.label,timeStamp:t,selected:"undefined"!=typeof i.selected&&i.selected}),this.stylerToObj[e.getId()]=n),this.updateMapMarker(n,{lat:e.location.y,lon:e.location.x,alt:e.location.z,orientation:e.orientation,color:e.color,icon:e.icon,timeStamp:t,selected:"undefined"!=typeof i.selected&&i.selected})},updateDrapedImage:function(e,t,i){var n=e.platformLocation,a=Cesium.Cartesian3.fromDegrees(n.x,n.y,n.z),o=Math.PI/180,s=e.platformOrientation,r=e.gimbalOrientation,d=Cesium.Transforms.northEastDownToFixedFrame(a),l=new Cesium.Matrix3;Cesium.Matrix4.getRotation(d,l);var c=new Cesium.Matrix3,u=Cesium.Matrix3.fromRotationZ(s.heading*o,c);Cesium.Matrix3.multiply(l,u,l);var h=Cesium.Matrix3.fromRotationY(s.pitch*o,c);Cesium.Matrix3.multiply(l,h,l);var f=Cesium.Matrix3.fromRotationX(s.roll*o,c);Cesium.Matrix3.multiply(l,f,l);var m=Cesium.Matrix3.fromRotationZ(r.heading*o,c);Cesium.Matrix3.multiply(l,m,l);var p=Cesium.Matrix3.fromRotationX(r.roll*o,c);Cesium.Matrix3.multiply(l,p,l);var v=Cesium.Matrix3.fromRotationY((90+r.pitch)*o,c);Cesium.Matrix3.multiply(l,v,l);var g=Cesium.Matrix3.fromRotationZ(90*o,c);Cesium.Matrix3.multiply(l,g,l);var S=e.cameraModel.camProj,y=e.cameraModel.camDistR,b=e.cameraModel.camDistT,I=e.imageSrc,T=this.viewer.scene.primitives.add(new Cesium.ImageDrapingPrimitive({imageSrc:I,camPos:a,camRot:l,camProj:S,camDistR:y,camDistT:b,asynchronous:!1}));null==e.snapshotFunc&&(null!=this.imageDrapingPrimitive&&this.viewer.scene.primitives.remove(this.imageDrapingPrimitive),this.imageDrapingPrimitive=T),this.frameCount++},beforeAddingItems:function(e,t){this.markers={},this.first=!0;var i=Cesium.createDefaultImageryProviderViewModels();this.viewer=new Cesium.Viewer(this.divId,{baseLayerPicker:!0,imageryProviderViewModels:i,selectedImageryProviderViewModel:i[6],timeline:!1,homeButton:!1,navigationInstructionsInitiallyVisible:!1,navigationHelpButton:!1,geocoder:!0,fullscreenButton:!1,showRenderLoopErrors:!0,animation:!1,targetFrameRate:10}),this.viewer.terrainProvider=new Cesium.CesiumTerrainProvider({url:"//assets.agi.com/stk-terrain/world"}),this.viewer.scene.copyGlobeDepth=!0,this.viewer.scene._environmentState.useGlobeDepthFramebuffer=!0;var n=this;Cesium.knockout.getObservable(this.viewer,"_selectedEntity").subscribe(function(e){if(Cesium.defined(e)){var t,i=[];for(var a in n.stylerToObj)if(n.stylerToObj[a]==e._dsid)for(var o=0;o<n.stylers.length;o++)if(n.stylers[o].getId()==a){i=i.concat(n.stylers[o].getDataSourcesIds()),t=n.stylers[o].viewItem.entityId;break;
}OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:i,entityId:t})}}.bind(this))},addMarker:function(e){var t="images/cameralook.png";null!=e.icon&&(t=e.icon);var i,n=t.endsWith(".glb"),a=e.label;i=n?{name:a,position:Cesium.Cartesian3.fromDegrees(0,0,0),model:{uri:t,scale:4,modelM:Cesium.Matrix4.IDENTITY.clone()}}:{position:Cesium.Cartesian3.fromDegrees(0,0,0),billboard:{image:t,rotation:Cesium.Math.toRadians(0),horizontalOrigin:Cesium.HorizontalOrigin.CENTER}};var o=this.viewer.entities.add(i),s="view-marker-"+OSH.Utils.randomUUID();return o._dsid=s,this.markers[s]=o,s},updateMapMarker:function(e,t){var i=t.lon,n=t.lat,a=t.alt,o=t.orientation;t.icon;if(!isNaN(i)&&!isNaN(n)){var s=this.markers[e];("undefined"==typeof a||isNaN(a))&&(a=this.getAltitude(n,i),a>1&&(a+=.3));var r=Cesium.Cartesian3.fromDegrees(i,n,a);if(s.position=r,"undefined"!=typeof o){var d=Math.PI/180,l=o.heading,c=0,u=Cesium.Transforms.headingPitchRollQuaternion(r,l*d,0,c*d);s.orientation=u}this.first&&(this.viewer.zoomTo(this.viewer.entities,new Cesium.HeadingPitchRange(Cesium.Math.toRadians(0),Cesium.Math.toRadians(-90),2e3)),this.first=!1),t.selected&&(this.viewer.selectedEntity=s)}},getAltitude:function(e,t){var i=Cesium.Cartesian3.fromDegrees(t,e,0,this.viewer.scene.globe.ellipsoid,new Cesium.Cartesian3),n=this.viewer.scene.globe.getHeight(Cesium.Ellipsoid.WGS84.cartesianToCartographic(i));return("undefined"==n||n<=0)&&(n=.1),n}}),OSH.UI.LeafletView=Class.create(OSH.UI.View,{initialize:function(e,t,i,n){e(t,i,n);var a=document.getElementById(this.divId).className;document.getElementById(this.divId).setAttribute("class",a+" "+this.css)},beforeAddingItems:function(e,t){this.initMap(t),this.initEvents()},initEvents:function(){document.getElementById(this.divId).oncontextmenu=function(e){new Object({keyCode:93});void 0!=e.preventDefault&&e.preventDefault(),void 0!=e.stopPropagation&&e.stopPropagation()}},initMap:function(e){var t={location:new L.LatLng(0,0),zoom:3};this.first=!0;var i=this.getDefaultLayers(),n=i[0].layer,a={},o={};a[i[0].name]=i[0].layer,o[i[1].name]=i[1].layer,"undefined"!=typeof e&&(e.initialView&&(t={location:new L.LatLng(e.initialView.lat,e.initialView.lon),zoom:e.initialView.zoom}),e.autoZoomOnFirstMarker||(this.first=!1),e.overlayLayers&&(o=e.overlayLayers),e.baseLayers&&(a=e.baseLayers),e.defaultLayer&&(n=e.defaultLayer)),this.map=new L.Map(this.divId,{fullscreenControl:!0,layers:n}),L.control.layers(a,o).addTo(this.map),this.map.setView(t.location,t.zoom),this.markers={},this.polylines={}},getDefaultBaseLayers:function(){return{}},getDefaultLayers:function(e){var t=22;"undefined"!=typeof e&&e.maxZoom&&(t=e.maxZoom);var i='Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery  <a href="http://mapbox.com">Mapbox</a>',n="https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw",a='<a href="http://www.esri.com/">Esri</a>',o="i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",s=L.tileLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; "+a+", "+o,maxZoom:t,maxNativeZoom:19}),r=L.tileLayer(n,{id:"mapbox.streets",attribution:i,maxZoom:t});return[{name:"MapBox Streets",layer:r},{name:"Esri Satellite",layer:s}]},initLayers:function(){var e="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",t='Map data  <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',i=new L.tileLayer(e,{minZoom:1,maxZoom:22,attribution:t});this.map.addLayer(i)},addMarker:function(e){var t=null;if(null!=e.icon){var i=L.icon({iconAnchor:e.iconAnchor,iconUrl:e.icon});t=L.marker([e.lat,e.lon],{icon:i})}else t=L.marker([e.lat,e.lon]);t.bindPopup(e.name),t.addTo(this.map),t.setRotationAngle(e.orientation);var n="view-marker-"+OSH.Utils.randomUUID();this.markers[n]=t,this.map.setView(new L.LatLng(e.lat,e.lon),19);var a=this;return t._icon.id=n,t.on("click",function(){var e=[];for(var t in a.stylerToObj)if(a.stylerToObj[t]==n){var i=a.stylerIdToStyler[t];OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:e.concat(i.getDataSourcesIds()),entityId:i.viewItem.entityId});break}}),$(n).oncontextmenu=function(e){new Object({keyCode:93});void 0!=e.preventDefault&&e.preventDefault(),void 0!=e.stopPropagation&&e.stopPropagation();for(var t in a.stylerToObj)if(a.stylerToObj[t]==n){OSH.EventManager.fire(OSH.EventManager.EVENT.CONTEXT_MENU+"-"+a.stylerIdToStyler[t].viewItem.contextMenuId,{offsetX:-70,offsetY:-70,action:"show",x:OSH.Utils.getXCursorPosition(),y:OSH.Utils.getYCursorPosition()});break}}.bind(this),n},addPolyline:function(e){for(var t=[],i=0;i<e.locations.length;i++)t.push(new L.LatLng(e.locations[i].y,e.locations[i].x));var n=new L.Polyline(t,{color:e.color,weight:e.weight,opacity:e.opacity,smoothFactor:e.smoothFactor}).addTo(this.map),a="view-polyline-"+OSH.Utils.randomUUID();return this.polylines[a]=n,a},updateMarker:function(e){var t=0;e.getId()in this.stylerToObj?t=this.stylerToObj[e.getId()]:(t=this.addMarker({lat:e.location.y,lon:e.location.x,orientation:e.orientation.heading,color:e.color,icon:e.icon,iconAnchor:e.iconAnchor,name:this.names[e.getId()]}),this.stylerToObj[e.getId()]=t);var i=this.markers[t],n=e.location.x,a=e.location.y;if(!isNaN(n)&&!isNaN(a)){var o=new L.LatLng(a,n);i.setLatLng(o)}if("undefined"!=typeof e.orientation&&i.setRotationAngle(e.orientation.heading),null!=e.icon&&i._icon.iconUrl!=e.icon){var s=L.icon({iconAnchor:[16,16],iconUrl:e.icon});i.setIcon(s)}},updatePolyline:function(e){var t=0;if(e.getId()in this.stylerToObj?t=this.stylerToObj[e.getId()]:(t=this.addPolyline({color:e.color,weight:e.weight,locations:e.locations,maxPoints:e.maxPoints,opacity:e.opacity,smoothFactor:e.smoothFactor}),this.stylerToObj[e.getId()]=t),t in this.polylines){var i=this.polylines[t];this.map.removeLayer(i);for(var n=[],a=0;a<e.locations.length;a++)n.push(new L.LatLng(e.locations[a].y,e.locations[a].x));var i=new L.Polyline(n,{color:e.color,weight:e.weight,opacity:e.opacity,smoothFactor:e.smoothFactor}).addTo(this.map);this.polylines[t]=i}},attachTo:function(e,t){e(t),this.map.invalidateSize()},onResize:function(e){this.map.invalidateSize()}}),L.Map=L.Map.extend({openPopup:function(e){return this._popup=e,this.addLayer(e).fire("popupopen",{popup:this._popup})}}),function(){var e=L.Marker.prototype._initIcon,t=L.Marker.prototype._setPos,i="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook(function(){var e=this.options.icon.options.iconAnchor;e&&(e=e[0]+"px "+e[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||e||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0}),L.Marker.include({_initIcon:function(){e.call(this)},_setPos:function(e){t.call(this,e),this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,i?this._icon.style[L.DomUtil.TRANSFORM]=" rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(e){return this.options.rotationAngle=e,this.update(),this},setRotationOrigin:function(e){return this.options.rotationOrigin=e,this.update(),this}})}(),OSH.UI.OpenLayerView=Class.create(OSH.UI.View,{initialize:function(e,t,i,n){e(t,i,n)},beforeAddingItems:function(e,t){this.initMap(t),this.initEvents()},initEvents:function(){document.getElementById(this.divId).oncontextmenu=function(e){new Object({keyCode:93});void 0!=e.preventDefault&&e.preventDefault(),void 0!=e.stopPropagation&&e.stopPropagation()};var e=this;this.map.getViewport().addEventListener("contextmenu",function(t){t.preventDefault();var i=e.map.forEachFeatureAtPixel(e.map.getEventPixel(t),function(e,t){return e});if(i){var n=i.ha;for(var a in e.stylerToObj)if(e.stylerToObj[a]==n){OSH.EventManager.fire(OSH.EventManager.EVENT.CONTEXT_MENU+"-"+e.stylerIdToStyler[a].viewItem.contextMenuId,{offsetX:-70,offsetY:-70,action:"show",x:OSH.Utils.getXCursorPosition(),y:OSH.Utils.getYCursorPosition()});break}}}),this.map.on("click",function(t){e.map.forEachFeatureAtPixel(t.pixel,function(t,i){var n=t.ha,a=[];for(var o in e.stylerToObj)if(e.stylerToObj[o]==n){var s=e.stylerIdToStyler[o];OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:a.concat(s.getDataSourcesIds()),entityId:s.viewItem.entityId});break}})})},updateMarker:function(e){var t=0;e.getId()in this.stylerToObj?t=this.stylerToObj[e.getId()]:(t=this.addMarker({lat:e.location.y,lon:e.location.x,orientation:e.orientation.heading,color:e.color,icon:e.icon,name:this.names[e.getId()]}),this.stylerToObj[e.getId()]=t);var i=this.markers[t],n=e.location.x,a=e.location.y;if(!isNaN(n)&&!isNaN(a)){var o=ol.proj.transform([n,a],"EPSG:4326","EPSG:900913");i.getGeometry().setCoordinates(o)}if(null!=e.icon){var s=new ol.style.Style({image:new ol.style.Icon({opacity:.75,src:e.icon,rotation:e.orientation.heading*Math.PI/180})});i.setStyle(s)}},updatePolyline:function(e){var t=0;if(e.getId()in this.stylerToObj?t=this.stylerToObj[e.getId()]:(t=this.addPolyline({color:e.color,weight:e.weight,locations:e.locations,maxPoints:e.maxPoints,opacity:e.opacity,smoothFactor:e.smoothFactor,name:this.names[e.getId()]}),this.stylerToObj[e.getId()]=t),t in this.polylines){for(var i=this.polylines[t],n=[],a=0;a<e.locations.length;a++)n.push(ol.proj.transform([e.locations[a].x,e.locations[a].y],"EPSG:4326","EPSG:900913"));i.setCoordinates(n)}},initMap:function(e){var t=null;this.first=!0;var i=[],n=null,a=this.getDefaultLayers();if("undefined"!=typeof e){var o=19;e.maxZoom&&(o=e.maxZoom),e.initialView&&(t=new ol.View({center:ol.proj.transform([e.initialView.lon,e.initialView.lat],"EPSG:4326","EPSG:900913"),zoom:e.initialView.zoom,maxZoom:o})),e.autoZoomOnFirstMarker||(this.first=!1),e.overlayLayers&&(i=e.overlayLayers),e.baseLayers&&(a=e.baseLayers),e.defaultLayer&&(n=e.defaultLayer)}else t=new ol.View({center:ol.proj.transform([0,0],"EPSG:4326","EPSG:900913"),zoom:11,maxZoom:o});this.map=new ol.Map({target:this.divId,controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([new ol.control.ZoomSlider,new ol.control.Rotate,new ol.control.ScaleLine]),interactions:ol.interaction.defaults().extend([new ol.interaction.Select({condition:ol.events.condition.mouseMove})]),layers:[new ol.layer.Group({title:"Base maps",layers:a}),new ol.layer.Group({title:"Overlays",layers:i})],view:t});var s=new ol.control.LayerSwitcher({tipLabel:"Layers"});this.map.addControl(s);var r=new ol.interaction.Select,d=this;r.getFeatures().on("add",function(e){var t=e.element,i=[];for(var n in d.stylerToObj)if(d.stylerToObj[n]==t.getId())for(var a=0;a<d.stylers.length;a++)if(d.stylers[a].getId()==n){i=i.concat(d.stylers[a].getDataSourcesIds());break}$(d.divId).fire("osh:select",i)}),this.map.addInteraction(r),this.markers={},this.polylines={}},getDefaultBaseLayers:function(){return{}},getDefaultLayers:function(){var e=new ol.layer.Tile({title:"OSM",type:"base",visible:!0,source:new ol.source.OSM});return[e]},addMarker:function(e){var t=new ol.geom.Point(ol.proj.transform([e.lon,e.lat],"EPSG:4326","EPSG:900913")),i=new ol.Feature({geometry:t,name:"Marker"});if(null!=e.icon){var n=new ol.style.Style({image:new ol.style.Icon({opacity:.75,src:e.icon,rotation:e.orientation*Math.PI/180})});i.setStyle(n)}var a=new ol.layer.Vector({title:e.name,source:new ol.source.Vector({features:[i]})});this.map.addLayer(a);var o="view-marker-"+OSH.Utils.randomUUID();return i.setId(o),this.markers[o]=i,this.first&&(this.first=!1,this.map.getView().setCenter(ol.proj.transform([e.lon,e.lat],"EPSG:4326","EPSG:900913")),this.map.getView().setZoom(19)),o},addPolyline:function(e){for(var t=[],i=0;i<e.locations.length;i++)t.push(ol.proj.transform([e.locations[i].x,e.locations[i].y],"EPSG:4326","EPSG:900913"));var n=new ol.geom.LineString(t),a=new ol.Feature({geometry:n,name:"Line"}),o=new ol.source.Vector({features:[a]}),s=new ol.layer.Vector({title:e.name,source:o,style:new ol.style.Style({fill:new ol.style.Fill({color:e.color}),stroke:new ol.style.Stroke({color:e.color,width:e.weight})})});this.map.addLayer(s);var r="view-polyline-"+OSH.Utils.randomUUID();return this.polylines[r]=n,r}}),OSH.UI.DialogView=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i),this.dialogId="dialog-"+OSH.Utils.randomUUID(),this.pinDivId="dialog-pin-"+OSH.Utils.randomUUID();var n="dialog-close-"+OSH.Utils.randomUUID();this.connectDivId="dialog-connect-"+OSH.Utils.randomUUID(),this.name="Untitled";var a="";a+="<div>",this.dockable=!1,this.closeable=!1,this.connected=!1,this.swapped=!1,this.connectionIds=[],this.draggable=!1,"undefined"!=typeof i&&("undefined"!=typeof i.swapId&&""!=i.swapId&&(this.swapDivId="dialog-exchange-"+OSH.Utils.randomUUID(),a+='<a id="'+this.swapDivId+'"class="pop-exchange fa fa-exchange" title="swap"></a>',this.divIdToSwap=i.swapId),"undefined"!=typeof i.connectionIds&&"undefined"!=typeof i.connectionIds&&i.connectionIds.length>0&&(a+='<a id="'+this.connectDivId+'"class="pop-connect"></a>',this.connected=!0,this.connectionIds=i.connectionIds),"undefined"!=typeof i.dockable&&i.dockable&&(a+='<a id="'+this.pinDivId+'"class="pop-pin"></a>',this.dockable=i.dockable),"undefined"!=typeof i.closeable&&i.closeable&&(a+='<a id="'+n+'"class="pop-close" title="close">x</a>',this.closeable=i.closeable),"undefined"!=typeof i.draggable&&i.draggable&&(this.draggable=i.draggable),"undefined"!=typeof i.name&&(this.name=i.name)),this.titleId="dialog-title-"+OSH.Utils.randomUUID(),a+='<h3 id="'+this.titleId+'">'+this.name+"</h3></div>",this.rootTag=document.getElementById(this.divId),this.rootTag.innerHTML=a,this.rootTag.setAttribute("class","pop-over resizable"),this.rootTag.setAttribute("draggable",this.draggable),i.css&&this.rootTag.setAttribute("class",this.rootTag.className+" "+i.css),this.popContentDiv=document.createElement("div"),this.popContentDiv.setAttribute("class","pop-content"),this.popContentDiv.setAttribute("id","pop-content-id-"+OSH.Utils.randomUUID()),this.rootTag.appendChild(this.popContentDiv),"undefined"!=typeof i&&("undefined"==typeof i.show||i.show?this.initialWidth=this.rootTag.offsetWidth:this.rootTag.style.display="none"),this.rootTag.addEventListener("dragstart",this.drag_start.bind(this),!1),document.addEventListener("dragover",this.drag_over.bind(this),!1),document.addEventListener("drop",this.drop.bind(this),!1),this.closeable&&(document.getElementById(n).onclick=this.close.bind(this)),this.dockable&&(document.getElementById(this.pinDivId).onclick=this.unpin.bind(this)),this.connectionIds.length>0&&(document.getElementById(this.connectDivId).onclick=this.connect.bind(this)),"undefined"!=typeof this.swapDivId&&(document.getElementById(this.swapDivId).onclick=this.swapClick.bind(this)),this.handleEvents();var o=this;OSH.EventManager.observe(OSH.EventManager.EVENT.CONNECT_DATASOURCE,function(e){var t=e.dataSourcesId;t.length==o.connectionIds.length&&t.filter(function(e){return o.connectionIds.indexOf(e)!=-1}).length==o.connectionIds.length&&(document.getElementById(o.connectDivId).setAttribute("class","pop-connect"),o.connected=!0)}),OSH.EventManager.observe(OSH.EventManager.EVENT.DISCONNECT_DATASOURCE,function(e){var t=e.dataSourcesId;t.length==o.connectionIds.length&&t.filter(function(e){return o.connectionIds.indexOf(e)!=-1}).length==o.connectionIds.length&&(document.getElementById(o.connectDivId).setAttribute("class","pop-disconnect"),o.connected=!1)}),OSH.EventManager.observe("swap-restore",function(e){o.swapped&&e.exclude!=o.id&&(o.swap(),o.swapped=!1)})},swapClick:function(){OSH.EventManager.fire("swap-restore",{exclude:this.id}),this.swap()},swap:function(){var e=document.getElementById(this.divIdToSwap);if("undefined"!=e&&null!=e)if(this.swapped){var t=this.popContentDiv.firstChild,i=document.getElementById(this.contentViewId);e.removeChild(i),this.popContentDiv.removeChild(t),e.appendChild(t),this.popContentDiv.appendChild(i),document.getElementById(this.titleId).innerText=this.name,this.swapped=!1}else{var t=this.popContentDiv.firstChild;this.contentViewId=t.id;var i=e.firstChild;e.removeChild(i),this.popContentDiv.removeChild(t),e.appendChild(t),this.popContentDiv.appendChild(i),this.swapped=!0,document.getElementById(this.titleId).innerText="- Swapped -"}},show:function(e,t){t.viewId.indexOf(this.getId())>-1&&(this.rootTag.style.display="block","undefined"==typeof this.initialWidth&&(this.initialWidth=this.rootTag.offsetWidth))},connect:function(){this.swapped||(this.connected?OSH.EventManager.fire(OSH.EventManager.EVENT.DISCONNECT_DATASOURCE,{dataSourcesId:this.connectionIds}):OSH.EventManager.fire(OSH.EventManager.EVENT.CONNECT_DATASOURCE,{dataSourcesId:this.connectionIds}))},unpin:function(){if(this.draggable)this.rootTag.style.top=0,this.rootTag.style.left=0-(this.rootTag.offsetWidth-this.initialWidth),this.rootTag.style.position="relative",this.rootTag.setAttribute("draggable",!1),document.body.removeChild(this.rootTag),this.container.appendChild(this.rootTag),this.draggable=!1,document.getElementById(this.pinDivId).setAttribute("class","pop-pin");else{var e=document.body.getBoundingClientRect(),t=this.rootTag.getBoundingClientRect(),i=t.top-e.top,n=t.left-e.left;this.rootTag.setAttribute("draggable",!0),this.rootTag.parentNode.removeChild(this.rootTag),document.body.appendChild(this.rootTag),this.rootTag.style.top=i,this.rootTag.style.left=n,this.rootTag.style.position="absolute",this.draggable=!0,document.getElementById(this.pinDivId).setAttribute("class","pop-pin pop-pin-drag")}},onClose:function(e){this.onClose=e},close:function(){this.rootTag.style.display="none",this.onClose&&this.onClose()},drag_start:function(e){e.stopPropagation();var t=window.getComputedStyle(e.target,null);e.dataTransfer.effectAllowed="all",e.dataTransfer.setData("text-"+this.rootTag.id,parseInt(t.getPropertyValue("left"),10)-e.clientX+","+(parseInt(t.getPropertyValue("top"),10)-e.clientY))},drag_over:function(e){return e.stopPropagation(),e.preventDefault(),!1},drop:function(e){e.stopPropagation();var t=e.dataTransfer.getData("text-"+this.rootTag.id).split(",");return this.rootTag.style.left=100*(e.clientX+parseInt(t[0],10))/window.innerWidth+"%",this.rootTag.style.top=e.clientY+parseInt(t[1],10)+"px",e.preventDefault(),!1}}),OSH.UI.Loading=Class.create({initialize:function(){var e=document.createElement("div");e.setAttribute("class","loading-container"),OSH.EventManager.observe(OSH.EventManager.EVENT.LOADING_START,function(t){var i="";i+='\t<div class="loading-dot-container">',i+='\t<div class="loading-dot-section-1"><span class="loading-label">Buffering</span></div>',i+='\t<div class="loading-dot-section-2">',i+='\t<div class="loading-dot"></div>',i+='\t<div class="loading-dot"></div>',i+='\t<div class="loading-dot"></div>',i+="\t</div>",i+="\t</div>",e.innerHTML=i,document.body.appendChild(e)}),OSH.EventManager.observe(OSH.EventManager.EVENT.LOADING_STOP,function(t){document.body.removeChild(e)})}}),new OSH.UI.Loading,OSH.UI.RangeSlider=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i),this.slider=document.createElement("div");var n=document.createElement("div"),a=document.createElement("a");n.appendChild(a),this.slider.setAttribute("class","osh-rangeslider-slider"),n.setAttribute("class","osh-rangeslider-control");var o=this;n.addEventListener("click",function(e){n.className.indexOf("osh-rangeslider-control-select")>-1?(n.setAttribute("class","osh-rangeslider-control"),o.deactivate()):(n.setAttribute("class","osh-rangeslider-control-select"),o.activate())}),document.getElementById(this.divId).appendChild(this.slider),document.getElementById(this.divId).appendChild(n);var s=(new Date).getTime();this.endTime=new Date("2055-01-01T00:00:00Z").getTime(),this.slider.setAttribute("disabled",!0),this.dataSourcesId=[],this.multi=!1,this.dataCount=0,this.refreshRate=10,"undefined"!=typeof i&&("undefined"!=typeof i.startTime&&(s=new Date(i.startTime).getTime()),"undefined"!=typeof i.endTime&&(this.endTime=new Date(i.endTime).getTime()),"undefined"!=typeof i.dataSourcesId&&(this.dataSourcesId=i.dataSourcesId),"undefined"!=typeof i.refreshRate&&(this.refreshRate=i.refreshRate)),noUiSlider.create(this.slider,{start:[s,this.endTime],range:{min:s,max:this.endTime},format:wNumb({decimals:0}),behaviour:"drag",connect:!0,tooltips:[wNumb({decimals:1,edit:function(e){var t=new Date(parseInt(e)).toISOString();return t.split("T")[1].split("Z")[0]}}),wNumb({decimals:1,edit:function(e){var t=new Date(parseInt(e)).toISOString();return t.split("T")[1].split("Z")[0]}})],pips:{mode:"positions",values:[5,25,50,75],density:1,format:wNumb({edit:function(e){return new Date(parseInt(e)).toISOString().replace(".000Z","Z")}})}}),this.slider.noUiSlider.on("slide",function(e,t){o.update=!0}),OSH.EventManager.observe(OSH.EventManager.EVENT.CURRENT_MASTER_TIME,function(e){o.lock||++o.dataCount%o.refreshRate!=0||(o.slider.noUiSlider.set([e.timeStamp]),o.dataCount=0)})},deactivate:function(){if(this.slider.setAttribute("disabled",!0),this.lock=!1,this.update){var e=this.slider.noUiSlider.get();OSH.EventManager.fire(OSH.EventManager.EVENT.DATASOURCE_UPDATE_TIME,{startTime:new Date(parseInt(e[0])).toISOString(),endTime:new Date(parseInt(e[1])).toISOString()})}this.update=!1},activate:function(){this.slider.removeAttribute("disabled"),this.lock=!0}});var htmlTaskingComponent='<div class="flex-container"><div class="remote fixed"><div class="remote-left"><input id="button-pan-left" type="image" src="images/remote-left.png" class="remote-button"/></div><div class="remote-up"><input id="button-tilt-up" type="image" src="images/remote-up.png" class="remote-button"/></div><div class="remote-zoomin"><input id="button-zoom-in" type="image" src="images/remote-zoomin.png" class="remote-button"/></div><div class="remote-zoomout"><input id="button-zoom-out" type="image" src="images/remote-zoomout.png" class="remote-button"/></div><div class="remote-right"><input id="button-pan-right" type="image" src="images/remote-right.png" class="remote-button"/></div><div class="remote-down"><input id="button-tilt-down" type="image" src="images/remote-down.png" class="remote-button"/></div></div></div>';OSH.UI.PtzTaskingView=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t);var n="640",a="480";this.css="",this.cssSelected="","undefined"!=typeof i&&(i.width&&(n=i.width),i.height&&(a=i.height),i.css&&(this.css=i.css),i.cssSelected&&(this.cssSelected=i.cssSelected)),this.rootTag=document.createElement("div"),this.rootTag.setAttribute("height",a),this.rootTag.setAttribute("width",n),this.rootTag.setAttribute("class",this.css),this.rootTag.setAttribute("id","dataview-"+OSH.Utils.randomUUID()),document.getElementById(this.divId).appendChild(this.rootTag),this.rootTag.innerHTML=htmlTaskingComponent,this.observers=[],this.pan=0,this.tilt=0,this.zoom=0;var o=5;$("button-tilt-up").observe("click",function(){this.onTiltClick(o)}.bind(this)),$("button-tilt-down").observe("click",function(){this.onTiltClick(-1*o)}.bind(this)),$("button-pan-right").observe("click",function(){this.onPanClick(o)}.bind(this)),$("button-pan-left").observe("click",function(){this.onPanClick(-1*o)}.bind(this)),$("button-zoom-in").observe("click",function(){this.onZoomClick(50)}.bind(this)),$("button-zoom-out").observe("click",function(){this.onZoomClick(-50)}.bind(this))},removeInterval:function(e){this.timerIds.length>0&&setTimeout(clearInterval(this.timerIds.pop()),e+50)},onTiltClick:function(e){this.tilt+=e,this.onChange(0,e,0)},onPanClick:function(e){this.pan+=e,this.onChange(e,0,0)},onZoomClick:function(e){this.zoom+=e,this.onChange(0,0,e)},onChange:function(e,t,i){for(var n={pan:e,zoom:i,tilt:t},a=0;a<this.observers.length;a++)this.observers[a].sendRequest(n)},register:function(e){this.observers.push(e)}}),OSH.UI.FFMPEGView=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i),this.fps=0;var n="640",a="480";this.statistics={videoStartTime:0,videoPictureCounter:0,windowStartTime:0,windowPictureCounter:0,fps:0,fpsMin:1e3,fpsMax:-1e3,fpsSinceStart:0},this.useWorker=!1,this.resetCalled=!0,"undefined"!=typeof i&&(i.width&&(n=i.width),i.height&&(a=i.height),this.useWorker="undefined"!=typeof i.useWorker&&i.useWorker&&OSH.Utils.isWebWorker()),this.yuvCanvas=new YUVCanvas({width:n,height:a,contextOptions:{preserveDrawingBuffer:!0}});var o=document.getElementById(this.divId);o.appendChild(this.yuvCanvas.canvasElement);var s=this;OSH.EventManager.observeDiv(this.divId,"click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:[s.dataSourceId],entityId:s.entityId})}),this.useWorker?this.initFFMPEG_DECODER_WORKER():this.initFFMEG_DECODER()},setData:function(e,t){var i=t.data,n=i.length;if(this.useWorker)this.resetCalled=!1,this.decodeWorker(n,i);else{var a=this.decode(n,i);"undefined"!=typeof a&&(this.yuvCanvas.drawNextOuptutPictureGL({yData:a.frameYData,yDataPerRow:a.frame_width,yRowCnt:a.frame_height,uData:a.frameUData,uDataPerRow:a.frame_width/2,uRowCnt:a.frame_height/2,vData:a.frameVData,vDataPerRow:a.frame_width/2,vRowCnt:a.frame_height/2}),this.updateStatistics(),this.onAfterDecoded())}},selectDataView:function(e,t,i){t.indexOf(this.dataSourceId)>-1||"undefined"!=typeof this.entityId&&this.entityId==i?document.getElementById(this.divId).setAttribute("class",this.css+" "+this.cssSelected):document.getElementById(this.divId).setAttribute("class",this.css)},reset:function(){_avcodec_flush_buffers(this.av_ctx),this.resetCalled=!0;var e=new Uint8Array(1);this.yuvCanvas.drawNextOuptutPictureGL({yData:e,yDataPerRow:1,yRowCnt:1,uData:e,uDataPerRow:1,uRowCnt:1,vData:e,vDataPerRow:1,vRowCnt:1})},updateStatistics:function(){var e=this.statistics;e.videoPictureCounter+=1,e.windowPictureCounter+=1;var t=Date.now();e.videoStartTime||(e.videoStartTime=t);var i=t-e.videoStartTime;if(e.elapsed=i/1e3,!(i<1e3)){if(!e.windowStartTime)return void(e.windowStartTime=t);if(t-e.windowStartTime>1e3){var n=t-e.windowStartTime,a=e.windowPictureCounter/n*1e3;e.windowStartTime=t,e.windowPictureCounter=0,a<e.fpsMin&&(e.fpsMin=a),a>e.fpsMax&&(e.fpsMax=a),e.fps=a}var a=e.videoPictureCounter/i*1e3;e.fpsSinceStart=a}},onAfterDecoded:function(){},initFFMPEG_DECODER_WORKER:function(e){console.log("init FFMPEG worker");var t=URL.createObjectURL(new Blob(["(",function(){function e(e,t){Module.setValue(i.av_pkt+28,e,"i32"),Module.writeArrayToMemory(t,i.av_pktData);var n=_avcodec_decode_video2(i.av_ctx,i.av_frame,i.got_frame,i.av_pkt);if(n<0)return void console.log("Error while decoding frame");if(0!=Module.getValue(i.got_frame,"i8")){var a=i.av_frame,o=Module.getValue(a+68,"i32"),s=Module.getValue(a+72,"i32"),r=Module.getValue(a,"*"),d=Module.getValue(a+4,"*"),l=Module.getValue(a+8,"*");return{frame_width:o,frame_height:s,frameYDataPtr:r,frameUDataPtr:d,frameVDataPtr:l,frameYData:new Uint8Array(Module.HEAPU8.buffer.slice(r,r+o*s)),frameUData:new Uint8Array(Module.HEAPU8.buffer.slice(d,d+o/2*s/2)),frameVData:new Uint8Array(Module.HEAPU8.buffer.slice(l,l+o/2*s/2))}}}importScripts("http://opensensorhub.github.io/osh-js/Toolkit/vendor/ffmpeg/ffmpeg-h264.js"),Module.ccall("avcodec_register_all");var t=Module.ccall("avcodec_find_decoder_by_name","number",["string"],["h264"]);if(0==t)return void console.error("Could not find H264 codec");i.av_ctx=_avcodec_alloc_context3(t);var n=_avcodec_open2(i.av_ctx,t,0);return n<0?void console.error("Could not initialize codec"):(i.av_pkt=Module._malloc(96),i.av_pktData=Module._malloc(153600),_av_init_packet(i.av_pkt),Module.setValue(i.av_pkt+24,i.av_pktData,"*"),i.av_frame=_avcodec_alloc_frame(),i.av_frame||alert("Could not allocate video frame"),i.got_frame=Module._malloc(4),void(i.onmessage=function(t){var n=t.data,a=e(n.pktSize,new Uint8Array(n.pktData,n.byteOffset,n.pktSize));"undefined"!=typeof a&&i.postMessage(a,[a.frameYData.buffer,a.frameUData.buffer,a.frameVData.buffer])}))}.toString(),")()"],{type:"application/javascript"}));this.worker=new Worker(t);var i=this;this.worker.onmessage=function(e){var t=e.data;this.resetCalled||(i.yuvCanvas.canvasElement.drawing=!0,i.yuvCanvas.drawNextOuptutPictureGL({yData:t.frameYData,yDataPerRow:t.frame_width,yRowCnt:t.frame_height,uData:t.frameUData,uDataPerRow:t.frame_width/2,uRowCnt:t.frame_height/2,vData:t.frameVData,vDataPerRow:t.frame_width/2,vRowCnt:t.frame_height/2}),i.yuvCanvas.canvasElement.drawing=!1,i.updateStatistics(),i.onAfterDecoded())}.bind(this),URL.revokeObjectURL(t)},decodeWorker:function(e,t){var i={pktSize:e,pktData:t.buffer,byteOffset:t.byteOffset};this.worker.postMessage(i,[i.pktData])},initFFMEG_DECODER:function(){Module.ccall("avcodec_register_all");var e=Module.ccall("avcodec_find_decoder_by_name","number",["string"],["h264"]);if(0==e)return void console.error("Could not find H264 codec");this.av_ctx=_avcodec_alloc_context3(e);var t=_avcodec_open2(this.av_ctx,e,0);return t<0?void console.error("Could not initialize codec"):(this.av_pkt=Module._malloc(96),this.av_pktData=Module._malloc(153600),_av_init_packet(this.av_pkt),Module.setValue(this.av_pkt+24,this.av_pktData,"*"),this.av_frame=_avcodec_alloc_frame(),this.av_frame||alert("Could not allocate video frame"),void(this.got_frame=Module._malloc(4)))},decode:function(e,t){Module.setValue(this.av_pkt+28,e,"i32"),Module.writeArrayToMemory(t,this.av_pktData);var i=_avcodec_decode_video2(this.av_ctx,this.av_frame,this.got_frame,this.av_pkt);if(i<0)return void console.log("Error while decoding frame");if(0!=Module.getValue(this.got_frame,"i8")){var n=this.av_frame,a=Module.getValue(n+68,"i32"),o=Module.getValue(n+72,"i32"),s=Module.getValue(n,"*"),r=Module.getValue(n+4,"*"),d=Module.getValue(n+8,"*");return{frame_width:a,frame_height:o,frameYDataPtr:s,frameUDataPtr:r,frameVDataPtr:d,frameYData:new Uint8Array(Module.HEAPU8.buffer,s,a*o),frameUData:new Uint8Array(Module.HEAPU8.buffer,r,a/2*o/2),frameVData:new Uint8Array(Module.HEAPU8.buffer,d,a/2*o/2)}}}}),OSH.UI.H264View=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i);var n="640",a="480";"undefined"!=typeof i&&(i.width&&(n=i.width),i.height&&(a=i.height));var o=!1,s=!1,r="auto";this.hasSps=!1,this.avcWs=new Player({useWorker:o,reuseMemory:s,webgl:r,size:{width:n,height:a}}),this.video=this.avcWs.canvas,this.video.setAttribute("width",n),this.video.setAttribute("height",a);var d=document.getElementById(this.divId);d.appendChild(this.video);var l=this;OSH.EventManager.observeDiv(this.divId,"click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:[l.dataSourceId],entityId:l.entityId})})},decode:function(e){this.avcWs.decode(e)},setData:function(e,t){this.computeFullNalFromRaw(t.data,function(e){var t=31&e[0];7!=t&&8!=t&&1!=t&&5!=t&6!=t||(7==t&&(this.hasSps=!0),this.hasSps&&this.decode(e))}.bind(this))},computeFullNalFromRaw:function(e,t){if(e&&e.length){for(var i=-1,n=-1,a=!1;(n=e.indexOf(1,n+1))!=-1&&(a=0==e[n-1],a&=0==e[n-2],!(a&=0==e[n-3])););if(a){for(i=n;(i=e.indexOf(1,i+1))!=-1;)a=0==e[i-1],a&=0==e[i-2],a&=0==e[i-3],a&&(t(e.subarray(n+1,i-3)),n=i);i==-1&&(t(e.subarray(n+1,e.length)),n=i)}}},selectDataView:function(e,t,i){t.indexOf(this.dataSourceId)>-1||"undefined"!=typeof this.entityId&&this.entityId==i?document.getElementById(this.divId).setAttribute("class",this.css+" "+this.cssSelected):document.getElementById(this.divId).setAttribute("class",this.css)}}),OSH.UI.MjpegView=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i),this.imgTag=document.createElement("img"),this.imgTag.setAttribute("id","dataview-"+OSH.Utils.randomUUID()),document.getElementById(this.divId).appendChild(this.imgTag);var n=this;OSH.EventManager.observeDiv(this.divId,"click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:[n.dataSourceId],entityId:n.entityId})})},setData:function(e,t,i){var n=this.imgTag.src;
this.imgTag.src=i.data,window.URL.revokeObjectURL(n)},selectDataView:function(e,t,i){t.indexOf(this.dataSourceId)>-1||"undefined"!=typeof this.entityId&&this.entityId==i?document.getElementById(this.divId).setAttribute("class",this.css+" "+this.cssSelected):document.getElementById(this.divId).setAttribute("class",this.css)},reset:function(){this.imgTag.src=""}}),OSH.UI.Mp4View=Class.create(OSH.UI.View,{initialize:function(e,t,i){e(t,[],i);this.codecs="avc1.64001E","undefined"!=typeof i&&(i.css&&(this.css=i.css),i.codecs&&(this.codecs=i.codecs)),this.video=document.createElement("video"),this.video.setAttribute("control",""),document.getElementById(this.divId).appendChild(this.video);var n=this;OSH.EventManager.observeDiv(this.divId,"click",function(e){OSH.EventManager.fire(OSH.EventManager.EVENT.SELECT_VIEW,{dataSourcesIds:[n.dataSourceId],entityId:n.entityId})}),this.mediaSource=new MediaSource,this.buffer=null,this.queue=[],this.video.src=window.URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener("sourceopen",function(e){this.mediaSource.duration=1e7,this.video.play(),this.buffer=this.mediaSource.addSourceBuffer('video/mp4; codecs="'+this.codecs+'"');this.mediaSource;this.buffer.addEventListener("updatestart",function(e){this.queue.length>0&&!this.buffer.updating&&this.buffer.appendBuffer(this.queue.shift())}.bind(this)),this.buffer.addEventListener("updateend",function(e){}),this.buffer.addEventListener("error",function(e){}),this.buffer.addEventListener("abort",function(e){}),this.buffer.addEventListener("update",function(){this.queue.length>0&&!this.buffer.updating&&this.buffer.appendBuffer(this.queue.shift())}.bind(this))}.bind(this),!1);this.mediaSource;this.mediaSource.addEventListener("sourceopen",function(e){}),this.mediaSource.addEventListener("sourceended",function(e){}),this.mediaSource.addEventListener("sourceclose",function(e){}),this.mediaSource.addEventListener("error",function(e){})},setData:function(e,t){this.buffer.updating||this.queue.length>0?this.queue.push(t.data):this.buffer.appendBuffer(t.data)},selectDataView:function(e,t,i){t.indexOf(this.dataSourceId)>-1||"undefined"!=typeof this.entityId&&this.entityId==i?document.getElementById(this.divId).setAttribute("class",this.css+" "+this.cssSelected):document.getElementById(this.divId).setAttribute("class",this.css)}});